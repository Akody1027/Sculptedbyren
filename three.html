<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RoadWatcHero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Google Maps with Geometry -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU&libraries=geometry"></script>

<style>
/* Immersive Enhancements */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');

:root {
  --bg: #f8fafc; /* Lighter background for UI elements */
  --app-bg: linear-gradient(180deg, #f0f4f8 0%, #e2e8f0 100%); /* New immersive app background */
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #EE611C; /* Main brand color */
  --danger: #EE611C; /* Red for urgent actions/status */
  --success: #22c55e; /* Green for positive actions/status */
  --warning: #f59e0b; /* Yellow for warnings */
  --info-blue: #2563eb; /* Blue for informational/tow truck */
  --shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
  --inset-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html {
  margin: 0; padding: 0; width: 100%; height: 100%;
  font-family: 'Inter', -apple-system, system-ui, sans-serif;
  color: var(--text);
  background: var(--app-bg); /* Use new app background */
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Base View Transitions */
.view {
  display: none; width: 100vw; height: 100vh; position: fixed; inset: 0;
  z-index: 10; background: var(--app-bg); /* Use app background */
  overflow-y: auto;
  transition: transform 0.4s ease-out, opacity 0.4s ease-out;
  transform: translateX(100%);
  opacity: 0;
}
.view-active {
  display: flex; flex-direction: column;
  transform: translateX(0);
  opacity: 1;
}

/* Landing Page - More engaging visuals */
#landingPage {
  align-items: center; justify-content: center; padding: 30px; text-align: center; z-index: 100;
  background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%); /* Retain distinct landing bg */
  position: relative;
  overflow: hidden;
}
#landingPage::before { /* Subtle background texture/pattern */
    content: '';
    position: absolute;
    inset: 0;
    background: url('data:image/svg+xml;utf-8,<svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h100v100H0z" fill="none"/><path d="M50 0L0 50l50 50 50-50z" fill="rgba(0,0,0,0.02)"/></svg>') repeat;
    background-size: 80px;
    opacity: 0.7;
    animation: backgroundPan 120s linear infinite;
}
@keyframes backgroundPan {
    from { background-position: 0 0; }
    to { background-position: 100% 100%; }
}

#landingPage img {
  width: 280px; /* Slightly larger logo */
  margin-bottom: 20px;
  filter: drop-shadow(0 8px 20px rgba(0,0,0,0.15));
  position: relative; z-index: 2; /* Ensure logo is above pseudo-element */
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
    100% { transform: translateY(0px); }
}

.mode-btn {
  width: 100%; max-width: 340px; /* Slightly wider buttons */
  padding: 22px; /* More prominent buttons */
  border-radius: 20px; /* Softer rounded corners */
  font-size: 19px; /* Slightly larger text */
  font-weight: 700; border: none; cursor: pointer; margin-bottom: 18px;
  box-shadow: var(--shadow);
  transition: all 0.2s ease;
  letter-spacing: 0.5px;
}
.mode-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 25px -8px rgba(0,0,0,0.2); }
.mode-btn:active { transform: scale(0.97); box-shadow: var(--inset-shadow); } /* More tactile active state */
.btn-req { background: var(--danger); color: white; }
.btn-hero { background: var(--text); color: white; }

/* Seeker UI - Enhanced cards and map */
#seekerUI {
    background: var(--app-bg); /* Use app background */
    padding: 20px;
    align-items: center;
}
#cancelSosBtn {
    align-self: flex-start;
    background: none;
    border: none;
    font-weight: 800;
    color: var(--danger);
    padding: 20px;
    display: none;
    letter-spacing: 0.8px;
    transition: transform 0.1s ease-in-out;
}
#cancelSosBtn:active { transform: scale(0.95); }

.status-card {
    background: white; width: 100%; max-width: 450px;
    padding: 25px; border-radius: 28px;
    box-shadow: var(--shadow);
    text-align: center; margin-top: 15px; /* More space */
    border: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.3s ease-in-out;
}

#seekerMapContainer {
    position: relative;
    width: 100%;
    height: 220px;
    border-radius: 20px;
    margin: 15px 0;
    background: #eee;
    border: 1px solid #e2e8f0;
    overflow: hidden;
    transition: all 0.3s ease-in-out;
    box-shadow: var(--inset-shadow); /* Inner shadow for depth */
}
#seekerMapContainer.expanded {
    position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 1001;
    border-radius: 0; margin: 0;
}

#seekerMap {
    width: 100%; height: 100%;
    border-radius: 20px;
}
#seekerMapContainer.expanded #seekerMap {
    border-radius: 0;
}

.map-expand-btn {
    position: absolute; bottom: 10px; right: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: none; padding: 8px 15px; /* Wider padding */
    border-radius: 18px; /* Softer border radius */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Lighter shadow */
    cursor: pointer; z-index: 2;
    font-size: 14px; font-weight: 700; color: var(--text);
    transition: all 0.2s ease;
}
.map-expand-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 1); }

.map-close-btn {
    position: absolute; top: 15px; right: 15px;
    background: var(--danger); color: white;
    border: none; width: 38px; height: 38px; /* Slightly larger */
    border-radius: 50%; font-size: 22px; /* Larger icon */
    font-weight: bold; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: var(--shadow); z-index: 1002;
    display: none;
    transition: all 0.2s ease;
}
.map-close-btn:active { transform: scale(0.95); background: #d04d10; }

.search-pulse {
    width: 80px; height: 80px; background: var(--danger); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 30px; color: white; margin: 0 auto 20px; position: relative;
    box-shadow: 0 0 0 0 rgba(238, 97, 28, 0.7); /* Initial state for pulse effect */
    animation: searchPulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
}
.search-pulse::after { /* Removed original ::after as it's now handled by keyframes */
    display: none;
}
@keyframes searchPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(238, 97, 28, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(238, 97, 28, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(238, 97, 28, 0); }
}


#statusIndicator {
    position: fixed; left: 15px; bottom: 85px; /* Adjusted position */
    z-index: 150; width: 60px; height: 60px; /* Slightly larger */
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 900; font-size: 30px; /* Larger font */
    cursor: pointer; box-shadow: var(--shadow);
    border: 4px solid white; /* Thicker border */
    transition: background-color 0.3s ease, transform 0.1s ease;
}
#statusIndicator:active { transform: scale(0.95); }

#map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
#heroPanel { width:100%; max-width: 400px; position: fixed; bottom: 100px; /* Adjusted for larger footer */ left: 50%; transform: translateX(-50%); /* Center horizontally */ z-index: 100; display: flex; flex-direction: column; padding: 0 15px; pointer-events: none; }
#heroPanel > * { pointer-events: auto; }

.task-card {
    background: rgba(255,255,255,0.98); backdrop-filter: blur(10px);
    padding: 20px; border-radius: 28px; /* Larger radius */
    box-shadow: 0 20px 30px -8px rgba(0,0,0,0.15); /* Stronger shadow */
    border-left: 8px solid var(--accent); /* Thicker accent border */
    display: none; transform: translateY(110%); /* Slide up from bottom */
    transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 400px; overflow-y: auto;
    border-top: 1px solid rgba(226, 232, 240, 0.8); /* Subtle top border */
}
.task-card.expanded {
    display: block;
    transform: translateY(0);
}

.sos-list-item {
    padding: 18px; /* More padding */
    border-bottom: 1px solid #f1f5f9;
    cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left;
    transition: background-color 0.15s ease;
}
.sos-list-item:hover { background: #f8fafc; }
.sos-list-item:active { background: #f1f5f9; transform: scale(0.99); }


/* Modal Enhancements */
.modal {
    position: fixed; inset: 0;
    background: rgba(15, 23, 42, 0.75); /* Darker, more opaque overlay */
    backdrop-filter: blur(6px); /* Stronger blur */
    display: none; justify-content: center; align-items: flex-end; z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-out;
}
.modal.active { /* Use 'active' class to show modal */
    opacity: 1;
}
.modal-content {
    background: white; width: 100%; max-width: 500px;
    border-radius: 32px 32px 0 0; padding: 30px;
    max-height: 95vh; overflow-y: auto;
    transform: translateY(100%); /* Start off-screen */
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
    border-top: 1px solid #e2e8f0;
}
.modal.active .modal-content { /* Slide in when modal is active */
    transform: translateY(0);
}


#chatBox {
    height: 320px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 12px; padding: 15px;
    background: #f1f5f9; /* Lighter chat background */
    border-radius: 20px; margin-bottom: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: var(--inset-shadow);
}
.msg { padding: 12px 18px; border-radius: 20px; max-width: 85%; font-size: 15px; line-height: 1.5; }
.msg-me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 8px; }
.msg-them { align-self: flex-start; background: white; color: var(--text); border-bottom-left-radius: 8px; border: 1px solid #e2e8f0; }

.vehicle-grid {
    display: grid; /* Changed to grid for better alignment */
    grid-template-columns: repeat(2, 1fr);
    gap: 10px; /* Gap between buttons */
    margin: 15px 0;
}
.v-type {
    padding: 15px; border: 2px solid #e2e8f0; border-radius: 16px;
    text-align: center; cursor: pointer; font-weight: 700;
    transition: all 0.2s ease;
    background: white;
}
.v-type.active {
    border-color: var(--danger); background: #ffece6; color: var(--danger);
    box-shadow: var(--inset-shadow);
}
.v-type:active { transform: scale(0.97); }

.tip-btn {
    border: 2px solid #e2e8f0; border-radius: 16px;
    padding: 14px; /* More prominent */
    flex: 1; text-align: center; cursor: pointer; font-weight: 800;
    background: white;
    transition: all 0.2s ease;
}
.tip-btn.active {
    border-color: var(--success); background: #f0fdf4; color: var(--success);
    box-shadow: var(--inset-shadow);
}
.tip-btn:active { transform: scale(0.97); }

input, textarea, select {
    width: 100%; padding: 16px; /* Increased padding */
    border-radius: 16px; /* Softer corners */
    border: 1px solid #e2e8f0; margin-bottom: 12px;
    font-size: 16px; background: #f8fafc;
    font-family: 'Inter', sans-serif;
    color: var(--text);
    box-shadow: var(--inset-shadow);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
input:focus, textarea:focus, select:focus {
    outline: none; border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(238, 97, 28, 0.2);
}

.submit-btn {
    width: 100%; padding: 18px;
    background: var(--accent); color: white; border: none;
    border-radius: 18px; /* Slightly larger radius */
    font-weight: 700; cursor: pointer; font-size: 17px; /* Larger font */
    letter-spacing: 0.5px;
    box-shadow: var(--shadow);
    transition: all 0.2s ease;
}
.submit-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 20px -8px rgba(0,0,0,0.15); }
.submit-btn:active { transform: scale(0.97); box-shadow: var(--inset-shadow); }

.cancel-link {
    display: block; text-align: center; padding: 15px;
    color: var(--muted); cursor: pointer; font-weight: 600;
    transition: color 0.2s ease;
}
.cancel-link:hover { color: var(--text); }
.cancel-link:active { transform: scale(0.98); }

/* Footer - More prominent and integrated */
.footer {
    position: fixed; bottom: 0; width: 100%;
    background: var(--accent); /* Solid accent color for footer */
    /* Removed backdrop-filter to keep it solid */
    display: flex; justify-content:center; align-items: center;
    z-index: 200;
    height: 70px; /* Taller footer */
    border-top: 1px solid rgba(255,255,255,0.3); /* Subtle white border */
    box-shadow: 0 -5px 15px -5px rgba(0,0,0,0.1);
}
.footer-icons { display:flex; gap: 80px; /* More space between icons */ padding:5px; }
.icon-btn {
    cursor: pointer; width: 36px; height: 36px; /* Larger icons */
    filter: brightness(0) invert(1); /* White icons */
    transition: transform 0.15s ease;
}
.icon-btn:active { transform: scale(0.9); }

#chatBadge, #chatBadgeHero {
    position: absolute; top: -8px; right: -8px; /* Adjusted position */
    background: var(--info-blue); /* Distinct chat badge color */
    color: white; font-size: 11px; /* Slightly larger font */
    width: 24px; height: 24px; border-radius: 50%;
    display: none; align-items: center; justify-content: center; font-weight: 800;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border: 2px solid white;
}

.center-btn {
    position: absolute; top: 20px; right: 20px;
    background: var(--accent); border: none; padding: 12px 18px; /* Wider padding */
    border-radius: 16px; /* Softer corners */
    box-shadow: var(--shadow); cursor: pointer; z-index: 5;
    font-weight: 700; font-size: 13px; color:white;
    transition: all 0.2s ease;
}
.center-btn:active { transform: scale(0.95); background: #d04d10; }

.trash-icon {
    width: 22px; /* Slightly larger */
    height: 22px;
    cursor: pointer;
    margin-left: 10px;
    opacity: 0.6;
    transition: opacity 0.2s ease;
}
.trash-icon:hover { opacity: 1; }
.trash-icon:active { transform: scale(0.9); }


/* New style for the blue tow truck button */
.btn-towtruck {
    background: var(--info-blue); /* A nice blue color */
    color: white;
    border: none;
    border-radius: 18px; /* Consistent radius */
    font-weight: 700;
    cursor: pointer;
    font-size: 17px;
    padding: 18px;
    width: 100%;
    margin-bottom: 15px; /* More space */
    box-shadow: var(--shadow);
    transition: all 0.2s ease;
}
.btn-towtruck:hover { transform: translateY(-1px); box-shadow: 0 12px 20px -8px rgba(0,0,0,0.15); }
.btn-towtruck:active { transform: scale(0.97); background: #1d4ed8; box-shadow: var(--inset-shadow); }
.btn-towtruck.active {
    background: #1d4ed8; /* Slightly darker blue when active */
    box-shadow: var(--inset-shadow);
}
.phone-input-group {
    margin-bottom: 20px; /* More space */
    display: none;
}
.phone-input-group label {
    font-size: 12px; /* Slightly larger label */
    font-weight: bold;
    color: var(--muted);
    margin-bottom: 10px; /* More space */
    display: block;
    letter-spacing: 0.5px;
}

/* Specific details modal styling */
#detailsModal .modal-content {
    text-align: center; /* Center content in details modal */
}
#detailsModal h3 {
    margin-bottom: 15px;
    font-size: 22px;
}
#detailsModal p {
    margin-bottom: 10px;
    font-size: 15px;
}
#detImg {
    border: 1px solid #e2e8f0;
    box-shadow: var(--inset-shadow);
}
#detETA {
    margin-top: 10px;
    text-align: center;
}
#detAcceptBtn, #detInProgressText {
    margin-top: 20px;
}

/* History items */
.history-item {
    padding: 15px; background:white; border-radius:15px; margin-bottom:10px;
    border:1px solid #e2e8f0; display:flex; justify-content:space-between;
    align-items:center;
    transition: background-color 0.15s ease, transform 0.1s ease;
}
.history-item:active { background: #f8fafc; transform: scale(0.99); }
.history-item .status-pill {
    font-size:10px; font-weight:800; padding:4px 10px; /* Adjusted padding */
    border-radius:8px; /* Softer pill shape */
    color:white;
    background:var(--info-blue); /* Default to info blue */
    display: inline-block;
    margin-right: 8px;
    letter-spacing: 0.3px;
}


</style>
</head>
<body>

<!-- APP CONTENT -->
<div id="landingPage" class="view view-active">
    <img src="roadwatchlogo.png" alt="Logo">
    <h2 style="color: var(--muted); margin-bottom: 40px; font-weight: 500; font-size: 18px;">Help is just a click away.</h2>
    <button class="mode-btn btn-req" onclick="window.openModal('requestModal')">Find a Hero!</button>
    <button class="mode-btn btn-hero" onclick="window.enterHeroMode()">Become a Hero!</button>
</div>

<!-- SEEKER UI -->
<div id="seekerUI" class="view">
    <button id="cancelSosBtn" onclick="window.openModal('cancelConfirmModal')" style="align-self: flex-start; background: none; border: none; font-weight: 800; color: var(--danger); padding: 20px; display: none;">‚úï CANCEL SOS</button>

    <div id="searchingState" class="status-card">
        <div class="search-pulse">üì°</div>
        <h3>Broadcasting SOS...</h3>
        <p>Your request is live. Waiting for a Hero to accept...</p>
    </div>

    <div id="matchedState" class="status-card" style="display:none; border-color: var(--success);">
        <div id="seekerStatusPill" style="background: var(--success); color: white; padding: 6px 16px; border-radius: 20px; display: inline-block; font-size: 12px; font-weight: 800; margin-bottom: 15px;">HERO CONNECTED</div>
        <div style="display: flex; align-items: center; gap: 15px; text-align: left;">
            <img id="matchPic" src="" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #f1f5f9; text-align:center;">
            <div style="flex:1">
                <h3 id="matchName" style="margin:0;">Hero Name</h3>
                <p id="matchETA" style="margin:4px 0; color: var(--success); font-weight: 800; font-size: 14px;">Arriving in ...</p>
                <p id="matchHeroPhone" style="margin:4px 0; font-size: 14px; font-weight: 600; display:none;"></p>
            </div>

        </div>
        <div id="seekerMapContainer">
            <div id="seekerMap"></div>
            <button class="map-expand-btn" onclick="window.toggleSeekerMapExpansion()">Expand Map</button>
            <button class="map-close-btn" onclick="window.toggleSeekerMapExpansion()">‚úï</button>
        </div>
        <p style="font-size:11px; color:var(--muted)">LIVE HERO TRACKING ENABLED</p>
    </div>

    <div id="completionConfirmState" class="status-card" style="display:none; border-color: var(--success);">
        <div style="font-size: 40px; margin-bottom: 15px;">‚úÖ</div>
        <h3>Job Completed!</h3>
        <p>Your Hero has marked the job as finished.</p>
        <button class="submit-btn" style="background: var(--success); margin-top: 15px;" onclick="window.finalSeekerConfirm()">CONFIRM & FINISH</button>
    </div>

    <div class="footer">
        <div class="footer-icons">

            <div id="footerChatBtn" style="position:relative; display:none;">
                <img src="Chaticon.png" class="icon-btn" onclick="window.openChat()">
                <span id="chatBadge">0</span>
            </div>

        </div>
    </div>
</div>

<!-- HERO UI -->
<div id="heroUI" class="view">
    <button class="center-btn" onclick="window.centerOnMe()">RE-CENTER</button>
    <div id="statusIndicator" style="background: #94a3b8;" onclick="window.toggleTaskCard()">!</div>
    <div id="map"></div>
    <div id="heroPanel">
        <div id="activeTask" class="task-card">
            <!-- DYNAMIC HERO CONTENT -->
        </div>
    </div>
    <div class="footer">
        <div class="footer-icons">
            <div style="position:relative">
                <img src="Historyicon.png" class="icon-btn" onclick="window.openModal('notifModal')">
                <!-- Removed #notifBadge as per request -->
            </div>
            <img src="thishomeicon.png" class="icon-btn" onclick="location.reload()">
            <div id="heroFooterChatBtn" style="position:relative; display:none;">
                <img src="Chaticon.png" class="icon-btn" onclick="window.openChat()">
                <span id="chatBadgeHero">0</span>
            </div>
            <img src="usericon.png"  class="icon-btn" onclick="window.openProfile()">
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <h3 id="detVehicle">Vehicle Request</h3>
        <img id="detImg" style="width:100%; height:200px; object-fit:cover; border-radius:20px; margin-bottom:15px; display:none;">
        <p id="detIssue" style="font-weight:bold; margin-bottom:5px;"></p>
        <p id="detTip" style="color:var(--success); font-weight: 900; font-size: 18px; margin: 10px 0;"></p>
        <p id="detDist" style="color:var(--accent); font-size:14px; margin-bottom:20px; font-weight:600;"></p>
        <!-- Phone number for tow truck requests -->
        <p id="detPhoneNumber" style="font-size:14px; margin-bottom:10px; font-weight:600; display:none;">Contact: <a id="detPhoneLink" href="#" style="color:var(--text); text-decoration: underline;"></a></p>
        <label style="font-size:11px; font-weight:bold; color:var(--muted);">ETA TO ARRIVAL</label>
        <select id="detETA">
            <option value="5-10 mins">5-10 mins</option>
            <option value="15-20 mins">15-20 mins</option>
            <option value="30-45 mins">30-45 mins</option>
            <option value="1 hour+">1 hour+</option>
        </select>
        <button id="detAcceptBtn" class="submit-btn">ACCEPT & HELP</button>
        <span id="detInProgressText" style="display:none; color:var(--success); font-weight:bold; text-align:center;">JOB IN PROGRESS...</span>
        <span class="cancel-link" onclick="window.closeModal('detailsModal')">Go Back</span>
    </div>
</div>

<div id="chatModal" class="modal">
    <div class="modal-content" style="height:85vh">
        <h3 id="chatTitle">Messages</h3>
        <div id="chatBox"></div>
        <div style="display:flex; gap:10px;">
            <button onclick="document.getElementById('chatImgInput').click()" style="padding:15px; background:#f1f5f9; border:none; border-radius:15px;">üì∑</button>
            <input type="file" id="chatImgInput" accept="image/*" style="display:none" onchange="window.sendChatImg(this)">
            <input id="chatInput" placeholder="Type message..." style="margin:0;">
            <button onclick="window.sendTextMsg()" style="background:var(--accent); color:white; border:none; padding:0 20px; border-radius:15px; font-weight:bold;">SEND</button>
        </div>
        <span class="cancel-link" onclick="window.closeModal('chatModal')">Close</span>
    </div>
</div>

<div id="requestModal" class="modal">
    <div class="modal-content">
        <h3>Request Hero</h3>
        <div class="vehicle-grid">
            <div class="v-type active" onclick="window.selectVehicle('Car', this)">üöó Car</div>
            <div class="v-type" onclick="window.selectVehicle('Truck', this)">üõª Truck</div>
            <div class="v-type" onclick="window.selectVehicle('RV', this)">üöê RV</div>
            <div class="v-type" onclick="window.selectVehicle('HeavyDuty', this)">üöõ Heavy Duty</div>
        </div>
        <label style="font-size:11px; font-weight:bold; color:var(--muted); margin-bottom:8px; display:block;">TIP NOT REQUIRED, BUT APPRECIATED!</label>
        <div style="display:flex; gap:10px; margin-bottom:12px;">
            <div class="tip-btn" onclick="window.setTip(5, this)">$5</div>
            <div class="tip-btn" onclick="window.setTip(10, this)">$10</div>
            <div class="tip-btn" onclick="window.setTip(20, this)">$20</div>
        </div>
        <input type="number" id="customTip" placeholder="Other Tip Amount ($)" style="margin-bottom:15px;">
        <img id="damagePreview" style="width:100%; height:150px; object-fit:cover; border-radius:20px; margin-bottom:15px; display:none;">
        <input type="file" id="damageInput" accept="image/*" style="display:none" onchange="window.handleImageUpload(this, 'damage')">
        <button onclick="document.getElementById('damageInput').click()" style="width:100%; padding:15px; border-radius:16px; border:2px dashed #cbd5e1; background:none; margin-bottom:15px; cursor:pointer; font-weight:bold; color:var(--muted);">üì∑ Add Damage Photo</button>
        <textarea id="reqIssue" placeholder="What's the problem?" rows="2"></textarea>

        <!-- Moved and restyled "I NEED A TOW TRUCK!" button -->
        <button id="towTruckBtn" class="btn-towtruck" onclick="window.toggleTowTruckRequest(this)">I NEED A TOW TRUCK!</button>

        <!-- Phone number input, initially hidden -->
        <div id="towTruckContact" class="phone-input-group">
            <label>PHONE NUMBER REQUIRED FOR TOWING</label>
            <input type="tel" id="phoneNumberInput" placeholder="Enter your phone number">
        </div>

        <button class="submit-btn" id="submitSosBtn" onclick="window.submitSOS()">FIND HERO</button>
        <p onclick="window.closeModal('requestModal')" class="cancel-link">Cancel</p>
    </div>
</div>

<div id="cancelConfirmModal" class="modal">
    <div class="modal-content"><h3>Cancel SOS?</h3><button class="submit-btn" style="background:var(--success); margin-bottom:10px;" onclick="window.submitCancellation('Issue Resolved')">Issue Resolved</button><button class="submit-btn" style="background:var(--accent); margin-bottom:10px;" onclick="window.submitCancellation('Found Other Helper')">Found Other Helper</button><button class="submit-btn" style="background:var(--muted); margin-bottom:10px;" onclick="window.submitCancellation('Changed Mind')">Don't Need Help</button><span class="cancel-link" onclick="window.closeModal('cancelConfirmModal')">Keep Request</span></div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Hero Profile</h3>
        <div style="text-align:center; margin-bottom:20px;">
            <img id="profileDisplayPic" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:4px solid #eff6ff;">
            <input type="file" id="picInput" style="display:none" onchange="window.handleImageUpload(this, 'profile')">
            <button onclick="document.getElementById('picInput').click()" style="display:block; margin:8px auto; border:none; background:none; color:var(--accent); font-weight:bold; cursor:pointer;">Update Photo</button>
        </div>
        <input id="profileName" placeholder="Hero Name">
        <textarea id="profileBio" placeholder="Bio / Tools Available..." rows="2"></textarea>
        <div style="background: #f8fafc; padding: 20px; border-radius: 20px; margin-bottom: 20px;">
            <label style="font-size:11px; font-weight:900; color:var(--muted);">SERVICE RADIUS: <span id="radiusVal" style="color:var(--accent);">25</span> miles</label>
            <input type="range" id="profileRadius" min="5" max="100" step="5" value="25" style="margin: 15px 0 0 0;" oninput="document.getElementById('radiusVal').innerText = this.value">
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 15px 20px; border-radius: 20px; margin-bottom: 20px;">
            <label for="prefersTowTruckRequests" style="font-weight: 700;">Only show Tow Truck requests</label>
            <input type="checkbox" id="prefersTowTruckRequests" style="width: auto; margin: 0;">
        </div>
        <button class="submit-btn" onclick="window.saveProfile()">Save Settings</button>
        <span class="cancel-link" onclick="window.closeModal('profileModal')">Close</span>
    </div>
</div>

<div id="notifModal" class="modal"><div class="modal-content"><h3>Activity History</h3><div id="notifHistory"></div><button class="submit-btn" style="background:#f1f5f9; color:var(--text); margin-top:20px;" onclick="window.closeModal('notifModal')">CLOSE</button></div></div>
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to delete this activity?</p>
        <button class="submit-btn" style="background:var(--danger); margin-bottom:10px;" onclick="window.confirmDeleteActivity()">Delete</button>
        <span class="cancel-link" onclick="window.closeModal('deleteConfirmModal')">Cancel</span>
    </div>
</div>

<!-- Hidden audio element for notifications -->
<audio id="notificationSound" src="Roadwatchero.mp3" preload="auto" style="display:none;"></audio>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

if(!localStorage.getItem('heroUserId')) localStorage.setItem('heroUserId', 'u_' + Math.random().toString(36).substr(2, 9));
const myId = localStorage.getItem('heroUserId');

let map, seekerMiniMap, userLocation, selectedVehicle = "Car", damageImgData = null, myRadius = 25, heroMarker;
let sosCache = {}, profilesCache = {}, markers = {}, seekerHeroMarker, seekerUserMarker;
let activeChatId = null, lastMsgCount = 0;
let activityToDeleteId = null; // New variable to store the ID of the activity to delete
let currentUnreadCount = 0; // New variable to track the overall unread count
let lastProcessedMessageTimestamp = 0; // Renamed for clarity: tracks the timestamp of the latest message processed
let isInitialLoadForChatListener = true; // New flag for initial load handling
let towTruckAnimationInterval = null; // For the tow truck icon animation
let currentTowTruckIconState = 0; // 0 for left-red, 1 for left-blue
let isTowTruckRequestActive = false; // New flag to track tow truck request state


// Standard marker icon for regular SOS requests
const getMarkerIcon = (color) => ({
    path: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z",
    fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1.5, anchor: new google.maps.Point(12, 12)
});

// Custom icon for the seeker's own location on the mini-map (blue circle)
const seekerOwnIcon = {
    path: google.maps.SymbolPath.CIRCLE,
    scale: 8,
    fillColor: "#2563eb",
    fillOpacity: 1,
    strokeColor: "white",
    strokeWeight: 2
};

// Custom icon for the hero on the seeker's mini-map (heromapicon.png)
const seekerHeroCustomIcon = {
    url: 'heromapicon.png', // Path to your hero map icon image
    scaledSize: new google.maps.Size(32, 32), // Adjust size as needed
    anchor: new google.maps.Point(0, 32) // Bottom-left corner (0, height)
};


// Helper function to create a tow truck icon with split colors and an exclamation mark
function getTowTruckSplitIcon(leftColor, rightColor) {
    const svgIcon = {
        url: 'data:image/svg+xml;utf-8,' + encodeURIComponent(`
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <clipPath id="clipLeft">
                        <rect x="0" y="0" width="12" height="24"/>
                    </clipPath>
                    <clipPath id="clipRight">
                        <rect x="12" y="0" width="12" height="24"/>
                    </clipPath>
                </defs>
                
                <!-- The main circle background, split into two colors -->
                <circle cx="12" cy="12" r="10" stroke="#ffffff" stroke-width="2" fill="none"/>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="${leftColor}" clip-path="url(#clipLeft)"/>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="${rightColor}" clip-path="url(#clipRight)"/>
                
                <!-- The exclamation mark path (vertical bar and dot) -->
                <rect x="11" y="7" width="2" height="8" fill="#ffffff"/>
                <circle cx="12" cy="17" r="1.5" fill="#ffffff"/>
            </svg>
        `),
        scaledSize: new google.maps.Size(24, 24), // Ensure consistent size
        anchor: new google.maps.Point(12, 12)
    };
    return svgIcon;
}


window.onload = () => {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(p => {
            const freshLoc = { lat: p.coords.latitude, lng: p.coords.longitude };
            const isFirstLoad = !userLocation;
            userLocation = freshLoc;
            update(ref(db, `profiles/${myId}`), { ...userLocation, id: myId });
            if (map) {
                if (!heroMarker) {
                    heroMarker = new google.maps.Marker({
                        position: userLocation, map: map,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#2563eb", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
                    });
                } else { heroMarker.setPosition(userLocation); }
                if (isFirstLoad && document.getElementById('heroUI').classList.contains('view-active')) { map.setCenter(userLocation); }
            }
            syncUI();
        }, (err) => console.error(err), { enableHighAccuracy: true });
    }
};

window.toggleTaskCard = () => { document.getElementById('activeTask').classList.toggle('expanded'); };
window.setTip = (amt, el) => { document.querySelectorAll('.tip-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); document.getElementById('customTip').value = amt; };
window.updateRadius = (val) => { myRadius = parseInt(val); document.getElementById('radiusVal').innerText = val; syncUI(); };
window.centerOnMe = () => { if (map && userLocation) map.setCenter(userLocation); };

// Modified openModal/closeModal to use the new 'active' class for transitions
window.openModal = (id) => {
    const modal = document.getElementById(id);
    modal.style.display = "flex"; // Make it visible
    // Force reflow to ensure display:flex is applied before starting transition
    modal.offsetHeight; 
    modal.classList.add("active"); // Trigger opacity and transform transitions
};

window.closeModal = (id) => {
    const modal = document.getElementById(id);
    modal.classList.remove("active"); // Start exit transition
    // Hide after transition completes
    modal.addEventListener('transitionend', function handler() {
        if (!modal.classList.contains('active')) { // Ensure it's not re-activated during transition
            modal.style.display = "none";
            modal.removeEventListener('transitionend', handler);
        }
    });
};

window.switchView = (id) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
    document.getElementById(id).classList.add('view-active');
    if (id === 'heroUI' && map && userLocation) { google.maps.event.trigger(map, 'resize'); map.setCenter(userLocation); }
};

window.selectVehicle = (type, el) => { 
    selectedVehicle = type; 
    document.querySelectorAll(".v-type").forEach(b => b.classList.remove("active")); 
    el.classList.add("active"); 
    // Reset tow truck request state when vehicle type changes
    isTowTruckRequestActive = false;
    document.getElementById('towTruckBtn').classList.remove('active');
    document.getElementById('towTruckBtn').innerText = 'I NEED A TOW TRUCK!';
    document.getElementById('towTruckContact').style.display = 'none';
    document.getElementById('phoneNumberInput').removeAttribute('required');
    document.getElementById('phoneNumberInput').value = '';
};


window.handleImageUpload = (input, target) => {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas'); const MAX_WIDTH = 600; const scaleSize = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const compressedData = canvas.toDataURL('image/jpeg', 0.7);
            if(target === 'damage') { damageImgData = compressedData; document.getElementById('damagePreview').src = compressedData; document.getElementById('damagePreview').style.display = 'block'; }
            else if(target === 'profile') { document.getElementById('profileDisplayPic').src = compressedData; }
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
};

window.openChat = async () => {
    // Determine the truly active chat ID here based on the current active job.
    const currentActiveSOS = Object.values(sosCache).find(
        r => (r.ownerId === myId || r.helperId === myId) &&
             (r.status === 'accepted' || r.status === 'arrived')
    );
    if (!currentActiveSOS) return;
    
    // Set activeChatId globally from the identified active SOS
    activeChatId = Object.keys(sosCache).find(key => sosCache[key] === currentActiveSOS); 

    window.openModal('chatModal');

    // Mark messages as read when chat is opened
    const chatSnap = await get(ref(db, `chats/${activeChatId}`));
    if (chatSnap.exists()) {
        const messages = chatSnap.val();
        const updates = {};
        for (const msgId in messages) {
            if (messages[msgId].sender !== myId && messages[msgId].read === false) {
                updates[`chats/${activeChatId}/${msgId}/read`] = true;
            }
        }
        if (Object.keys(updates).length > 0) {
            await update(ref(db), updates);
        }
    }
    // The global listener will update the badge count after messages are marked as read.
    // Explicitly set to 0 here for immediate visual feedback
    updateChatBadges(0); 

    // This listener is specific to the currently opened chat modal
    onValue(ref(db, `chats/${activeChatId}`), (snap) => {
        const box = document.getElementById('chatBox'); box.innerHTML = "";
        const data = snap.val() || {};
        const msgs = Object.values(data);
        msgs.forEach(m => {
            const side = m.sender === myId ? 'msg-me' : 'msg-them';
            let content = m.text ? `<div>${m.text}</div>` : "";
            if(m.img) content += `<img src="${m.img}" style="max-width:100%; border-radius:10px; margin-top:5px;">`;
            box.innerHTML += `<div class="msg ${side}">${content}</div>`;
        });
        box.scrollTop = box.scrollHeight;
        lastMsgCount = msgs.length;
    });
};

window.sendTextMsg = () => {
    const input = document.getElementById('chatInput'); if(!input.value.trim() || !activeChatId) return;
    push(ref(db, `chats/${activeChatId}`), { sender: myId, text: input.value, timestamp: Date.now(), read: false }); // Added read: false
    input.value = "";
};

window.sendChatImg = (input) => {
    const file = input.files[0]; if(!file || !activeChatId) return;
    const reader = new FileReader();
    reader.onload = (e) => push(ref(db, `chats/${activeChatId}`), { sender: myId, img: e.target.result, timestamp: Date.now(), read: false }); // Added read: false
    reader.readAsDataURL(file);
};

function updateChatBadges(count) {
    const sB = document.getElementById('chatBadge');
    const hB = document.getElementById('chatBadgeHero');

    if(sB) {
        if (count > 0) { sB.innerText = count; sB.style.display = 'flex'; }
        else { sB.style.display = 'none'; }
    }
    if(hB) {
        if (count > 0) { hB.innerText = count; hB.style.display = 'flex'; }
        else { hB.style.display = 'none'; }
    }
}

// Global listener for unread messages and notification sound
onValue(ref(db, 'chats'), (snapshot) => {
    let unreadCount = 0;
    let latestMessageTimestampInActiveChat = 0;
    
    // Determine the active SOS request for *this user*
    const myActiveSOSRequest = Object.entries(sosCache).find(
        ([id, r]) => (r.ownerId === myId || r.helperId === myId) &&
                     (r.status === 'accepted' || r.status === 'arrived')
    );

    let currentActiveChatIdForBadge = null;
    if (myActiveSOSRequest) {
        currentActiveChatIdForBadge = myActiveSOSRequest[0]; // The ID of the SOS request is also the chat ID
    }

    // Only proceed if there's an active chat relevant to the current user
    if (currentActiveChatIdForBadge) {
        const messages = snapshot.val() ? snapshot.val()[currentActiveChatIdForBadge] : null;

        if (messages) {
            for (const msgId in messages) {
                const message = messages[msgId];
                if (message.sender !== myId && message.read === false) {
                    unreadCount++;
                }
                // Keep track of the latest message timestamp in this active chat
                if (message.timestamp && message.timestamp > latestMessageTimestampInActiveChat) {
                    latestMessageTimestampInActiveChat = message.timestamp;
                }
            }
        }
    }

    // Check if chat modal is currently open
    const chatModalOpen = document.getElementById('chatModal').classList.contains('active'); // Use new class

    // Play notification sound if new unread messages are detected AND chat is not open
    // This logic handles app refresh/reopen and new messages while app is in background
    if (!isInitialLoadForChatListener && unreadCount > 0 && latestMessageTimestampInActiveChat > lastProcessedMessageTimestamp && !chatModalOpen) {
        const sound = document.getElementById('notificationSound');
        if (sound) {
            sound.play().catch(e => console.error("Error playing sound:", e));
        }
    }
    
    // Update lastProcessedMessageTimestamp
    // On initial load, set the baseline. For subsequent updates, it tracks the latest message.
    if (latestMessageTimestampInActiveChat > lastProcessedMessageTimestamp) {
        lastProcessedMessageTimestamp = latestMessageTimestampInActiveChat;
    }
    
    currentUnreadCount = unreadCount; // Update the global unread count
    updateChatBadges(currentUnreadCount);

    // After the first full processing, set isInitialLoadForChatListener to false
    if (isInitialLoadForChatListener) {
        isInitialLoadForChatListener = false;
    }

}, (error) => {
    console.error("Error fetching chats for unread count:", error);
});


window.viewRequest = (id) => {
    const r = sosCache[id]; if(!r) return;
    
    // Update Vehicle Request title
    document.getElementById('detVehicle').innerText = r.vehicle + (r.isTowTruckRequest ? ' (Tow Truck)' : '');
    
    document.getElementById('detIssue').innerText = r.issue;
    document.getElementById('detTip').innerText = (r.tip && r.tip > 0) ? " $" + r.tip + " Tip" : "";
    
    const detPhoneNumberElement = document.getElementById('detPhoneNumber');
    const detPhoneLink = document.getElementById('detPhoneLink');

    if (r.isTowTruckRequest && r.phoneNumber) {
        detPhoneLink.innerText = r.phoneNumber;
        detPhoneLink.href = `tel:${r.phoneNumber}`;
        detPhoneNumberElement.style.display = 'block';
    } else {
        detPhoneNumberElement.style.display = 'none';
    }

    const dist = userLocation ? (google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLocation.lat, userLocation.lng), new google.maps.LatLng(r.lat, r.lng)) / 1609).toFixed(1) : "?";
    document.getElementById('detDist').innerText = "" + dist + " miles away";
    const img = document.getElementById('detImg');
    if(r.damagePic) { img.src = r.damagePic; img.style.display = "block"; } else { img.style.display = "none"; }
    const acceptBtn = document.getElementById('detAcceptBtn');
    const progressText = document.getElementById('detInProgressText');
    const etaInput = document.getElementById('detETA');
    if(r.status === 'accepted' || r.status === 'arrived') {
        acceptBtn.style.display = "none"; progressText.style.display = "block"; etaInput.style.display = "none";
    } else {
        acceptBtn.style.display = "block"; progressText.style.display = "none"; etaInput.style.display = "block";
        acceptBtn.onclick = () => window.confirmHelp(id);
    }
    window.openModal('detailsModal');
};

window.enterHeroMode = () => { window.switchView('heroUI'); if(!map) initMap(); };
window.confirmHelp = (sosId) => {
    const eta = document.getElementById('detETA').value;
    update(ref(db, `sosRequests/${sosId}`), { status: 'accepted', helperId: myId, helperAcknowledged: false, eta: eta });
    window.closeModal('detailsModal');
    document.getElementById('activeTask').classList.add('expanded');
};
window.markArrived = () => { const active = Object.entries(sosCache).find(([id, r]) => r.helperId === myId && r.status === 'accepted'); if(active) update(ref(db, `sosRequests/${active[0]}`), { status: 'arrived' }); };
window.completeTask = () => { const active = Object.entries(sosCache).find(([id, r]) => r.helperId === myId && r.status === 'arrived'); if(active) update(ref(db, `sosRequests/${active[0]}`), { status: 'completed' }); };

window.acknowledgeCancel = () => {
    const canceledTask = Object.entries(sosCache).find(([id, r]) => 
        r.helperId === myId && r.status === 'canceled' && r.helperAcknowledged !== true
    );
    if(canceledTask) {
        update(ref(db, `sosRequests/${canceledTask[0]}`), { helperAcknowledged: true });
        const tCard = document.getElementById('activeTask');
        tCard.classList.remove('expanded');
        setTimeout(() => { tCard.style.display = 'none'; }, 400);
    }
};

window.toggleTowTruckRequest = (button) => {
    isTowTruckRequestActive = !isTowTruckRequestActive;
    const towTruckContactDiv = document.getElementById('towTruckContact');
    const phoneNumberInput = document.getElementById('phoneNumberInput');

    if (isTowTruckRequestActive) {
        button.classList.add('active');
        button.innerText = 'TOW TRUCK REQUEST ACTIVE';
        towTruckContactDiv.style.display = 'block';
        phoneNumberInput.setAttribute('required', 'required');
    } else {
        button.classList.remove('active');
        button.innerText = 'I NEED A TOW TRUCK!';
        towTruckContactDiv.style.display = 'none';
        phoneNumberInput.removeAttribute('required');
        phoneNumberInput.value = ''; // Clear phone number when deselected
    }
};

window.submitSOS = () => { 
    const issue = document.getElementById('reqIssue').value; 
    const tip = document.getElementById('customTip').value || 0;
    const phoneNumber = document.getElementById('phoneNumberInput').value;

    // SESSION PERSISTENCE: 1. Check if user already has an active help request before starting a new one
    const existingReq = Object.values(sosCache).find(r => r.ownerId === myId && ['open', 'accepted', 'arrived', 'completed'].includes(r.status));
    if (existingReq) {
        window.switchView('seekerUI'); // Go to status screen
        window.closeModal('requestModal');
        return; // Don't submit a second request
    }

    if(!issue || !userLocation) return alert("Please describe the issue.");
    
    if (isTowTruckRequestActive && !phoneNumber.trim()) {
        return alert("Please enter your phone number for tow truck assistance.");
    }

    push(ref(db, "sosRequests"), { 
        ownerId: myId, 
        userName: "Driver", 
        issue, 
        vehicle: selectedVehicle, 
        damagePic: damageImgData, 
        tip: tip, 
        lat: userLocation.lat, 
        lng: userLocation.lng, 
        status: 'open', 
        isTowTruckRequest: isTowTruckRequestActive, // Use the flag
        phoneNumber: isTowTruckRequestActive ? phoneNumber : null, // Save phone number if tow truck request
        timestamp: Date.now() 
    });
    window.closeModal('requestModal'); 
    window.switchView('seekerUI');
    // Reset tow truck request state after submission
    isTowTruckRequestActive = false;
    document.getElementById('towTruckBtn').classList.remove('active');
    document.getElementById('towTruckBtn').innerText = 'I NEED A TOW TRUCK!';
    document.getElementById('towTruckContact').style.display = 'none';
    document.getElementById('phoneNumberInput').removeAttribute('required');
    document.getElementById('phoneNumberInput').value = '';
};

window.submitCancellation = (reason) => {
    const myReqId = Object.keys(sosCache).find(k => sosCache[k].ownerId === myId && (sosCache[k].status === 'open' || sosCache[k].status === 'accepted' || sosCache[k].status === 'arrived'));
    if(myReqId) update(ref(db, `sosRequests/${myReqId}`), { status: 'canceled', cancelReason: reason });
    window.closeModal('cancelConfirmModal'); window.switchView('landingPage'); damageImgData = null;
};

window.finalSeekerConfirm = () => {
    const myReqId = Object.keys(sosCache).find(k => sosCache[k].ownerId === myId && sosCache[k].status === 'completed');
    if(myReqId) update(ref(db, `sosRequests/${myReqId}`), { status: 'finalized' });
    damageImgData = null;
    window.switchView('landingPage');
};

function initMap() { map = new google.maps.Map(document.getElementById("map"), { center: userLocation || {lat: 40, lng: -74}, zoom: 14, disableDefaultUI: true, styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }] }); }

function syncUI() {
    const history = document.getElementById('notifHistory'); history.innerHTML = "";
    let nearbySOS = [];
    let currentTask = null; 
    let myActiveSOS = null;
    let jobActive = false;
    let towTruckRequestsOnMap = false; // Track if any tow truck requests are on the map

    const currentHeroProfile = profilesCache[myId] || {};
    const prefersTowTruck = currentHeroProfile.prefersTowTruckRequests === true;

    // First, iterate through all SOS requests to manage map markers for ALL open requests
    Object.entries(sosCache).forEach(([id, r]) => {
        const isTowTruck = r.isTowTruckRequest === true;

        // Apply tow truck preference filter for heroes
        if (prefersTowTruck && !isTowTruck) {
            // If hero prefers tow trucks, hide non-tow truck requests
            if (markers[id]) {
                markers[id].setMap(null);
                delete markers[id];
            }
            return; // Skip processing for this non-tow truck request
        }
        // If hero doesn't prefer tow trucks, they see everything, no filter applied here.

        // Handle all 'open' requests for map display (regardless of radius)
        if (r.status === 'open' && r.ownerId !== myId) {
            if (isTowTruck) {
                towTruckRequestsOnMap = true; // Mark that there's at least one tow truck request
            }

            if (!markers[id] && map) {
                const iconToUse = isTowTruck ? getTowTruckSplitIcon("#ef4444", "#2563eb") : getMarkerIcon("#EE611C"); // Default state
                const marker = new google.maps.Marker({ position: {lat: r.lat, lng: r.lng}, map, icon: iconToUse });
                marker.addListener('click', () => window.viewRequest(id));
                markers[id] = marker;
            } else if (markers[id]) {
                // Ensure marker icon is correct if status changed (e.g., from regular to tow truck, though not typical)
                // Or if it was filtered out and now should be visible
                const iconToUse = isTowTruck ? getTowTruckSplitIcon("#ef4444", "#2563eb") : getMarkerIcon("#EE611C");
                markers[id].setIcon(iconToUse);
                markers[id].setMap(map); // Make sure it's visible if it was hidden
            }
        }
        // Handle markers for accepted/arrived jobs (no special tow truck icon needed here as it's accepted)
        else if (r.helperId === myId && (r.status === 'accepted' || r.status === 'arrived')) {
            if(!markers[id] && map) {
                const marker = new google.maps.Marker({ position: {lat: r.lat, lng: r.lng}, map, icon: getMarkerIcon("#22c55e") });
                marker.addListener('click', () => window.viewRequest(id));
                markers[id] = marker;
            } else if (markers[id]) {
                markers[id].setIcon(getMarkerIcon("#22c55e"));
                markers[id].setMap(map); // Make sure it's visible if it was hidden
            }
        }
        // Remove markers for finalized/canceled or other non-display statuses
        else if (markers[id]) {
            markers[id].setMap(null);
            delete markers[id];
        }
    });

    // Start/Stop Tow Truck Animation
    if (towTruckRequestsOnMap && !towTruckAnimationInterval) {
        startTowTruckAnimation();
    } else if (!towTruckRequestsOnMap && towTruckAnimationInterval) {
        stopTowTruckAnimation();
    }


    // Now, iterate again (or continue the loop for other logic) to populate nearbySOS for the list and other UI
    Object.entries(sosCache).forEach(([id, r]) => {
        const distMiles = userLocation ? (google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLocation.lat, userLocation.lng), new google.maps.LatLng(r.lat, r.lng)) / 1609.34) : 999;
        const isTowTruck = r.isTowTruckRequest === true;

        // Apply tow truck preference filter for the list as well
        if (prefersTowTruck && !isTowTruck) {
            return; // Skip non-tow truck requests if filter is on
        }

        if (r.status === 'open' && r.ownerId !== myId && distMiles <= myRadius) {
            nearbySOS.push({id, ...r, dist: distMiles});
        }

        // Identify current hero task (no preference filter here, you've accepted it)
        if(r.helperId === myId && (r.status === 'accepted' || r.status === 'arrived' || (r.status === 'canceled' && r.helperAcknowledged !== true))) currentTask = r;
        
        // Identify active seeker request (Only latest non-finalized)
        if(r.ownerId === myId && ['open', 'accepted', 'arrived', 'completed'].includes(r.status)) {
            if (!myActiveSOS || r.timestamp > myActiveSOS.timestamp) myActiveSOS = r;
        }
        
        if((r.ownerId === myId || r.helperId === myId) && (r.status === 'accepted' || r.status === 'arrived')) {
            jobActive = true; 
        }

        // Filtered Activity History for the specific hero
        if (r.ownerId === myId || r.helperId === myId) {
            let sCol = r.status === 'completed' || r.status === 'finalized' ? '#22c55e' : (r.status === 'canceled' ? '#ef4444' : '#2563eb');
            history.innerHTML += `
                <div class="history-item" style="padding:15px; background:#f8fafc; border-radius:15px; margin-bottom:10px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span class="status-pill" style="font-size:10px; font-weight:800; padding:3px 8px; border-radius:6px; color:white; background:${sCol};">${r.status}</span>
                        <b>${r.vehicle}${isTowTruck ? ' (Tow)' : ''}</b><br><small>${r.issue}</small>
                    </div>
                    <img src="https://cdn-icons-png.flaticon.com/512/3405/3405244.png" class="trash-icon" onclick="window.confirmDeleteActivityPrompt('${id}')">
                </div>`;
        }
    });

    document.getElementById('footerChatBtn').style.display = jobActive ? 'block' : 'none';
    document.getElementById('heroFooterChatBtn').style.display = jobActive ? 'block' : 'none';
    document.getElementById('cancelSosBtn').style.display = myActiveSOS ? 'block' : 'none'; // Only show cancel if there's an active SOS


    // HERO STATUS INDICATOR COLORS
    const ind = document.getElementById('statusIndicator');
    if(currentTask) { ind.style.background = "var(--success)"; } 
    else if (nearbySOS.length > 0) { ind.style.background = "var(--danger)"; } 
    else { ind.style.background = "#94a3b8"; }
    
    // HERO TASK PANEL
    const tCard = document.getElementById('activeTask');
    tCard.innerHTML = ""; 

    if(currentTask) {
        tCard.style.display = 'block';
        if(currentTask.status === 'canceled') {
            tCard.innerHTML = `<div style="text-align:center;"><b style="color:var(--danger)">SOS CANCELED</b><p style="font-size:13px; margin:10px 0;">Reason: ${currentTask.cancelReason || 'None'}</p><button onclick="window.acknowledgeCancel()" class="submit-btn" style="background:var(--text); padding:10px; font-size:13px;">CLOSE</button></div>`;
        } else {
            let contactInfo = '';
            if (currentTask.isTowTruckRequest && currentTask.phoneNumber) {
                contactInfo = `<p style="margin: 0 0 10px 0; font-weight: 700; font-size: 14px;">üìû Contact: <a href="tel:${currentTask.phoneNumber}" style="color:var(--text); text-decoration: underline;">${currentTask.phoneNumber}</a></p>`;
            }

            tCard.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b style="color:${currentTask.status === 'arrived' ? 'var(--warning)' : 'var(--accent)'};">${currentTask.status.toUpperCase()} JOB</b>
                    <button onclick="window.openChat()" style="background:var(--accent); color:white; border:none; padding:10px 18px; border-radius:12px; font-weight:bold; font-size:12px;">CHAT</button>
                </div>
                <p style="margin:10px 0; font-weight:700; font-size:15px;">${currentTask.vehicle}${currentTask.isTowTruckRequest ? ' (Tow Truck)' : ''}: ${currentTask.issue}</p>
                ${(currentTask.tip > 0) ? `<p style="margin: 0 0 10px 0; font-weight: 800; color: var(--success); font-size: 14px;">üí∞ Tip: $${currentTask.tip}</p>` : ''}
                ${contactInfo}
                <div style="display:flex; gap:8px;">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${currentTask.lat},${currentTask.lng}" target="_blank" style="flex:1; background:var(--success); color:white; text-align:center; padding:12px; border-radius:12px; text-decoration:none; font-weight:700; font-size:13px;">MAPS</a>
                    ${currentTask.status === 'accepted' ? `<button onclick="window.markArrived()" style="flex:1; background:var(--warning); color:white; border:none; border-radius:12px; font-weight:700; font-size:13px;">HERE</button>` : `<button onclick="window.completeTask()" style="flex:1; background:var(--success); color:white; border:none; border-radius:12px; font-weight:700; font-size:13px;">DONE</button>`}
                </div>`;
        }
    } else if (nearbySOS.length > 0) {
        tCard.style.display = 'block';
        let listHtml = `<b style="color:var(--danger); display:block; margin-bottom:10px;">${nearbySOS.length} SOS NEARBY</b>`;
        nearbySOS.forEach(s => {
            listHtml += `<div class="sos-list-item" onclick="window.viewRequest('${s.id}')">
                <div><b>${s.vehicle}${s.isTowTruckRequest ? ' (Tow)' : ''}</b><br><small>${s.dist.toFixed(1)} miles away</small></div>
                <div style="color:var(--success); font-weight:bold;">${s.tip > 0 ? '$'+s.tip : 'HELP'}</div>
            </div>`;
        });
        tCard.innerHTML = listHtml;
    } else {
        tCard.style.display = 'block';
        tCard.innerHTML = `<div style="text-align:center; color:var(--muted); padding:10px;"><b>No help needed right now.</b><p style="font-size:11px;">We'll alert you if someone nearby sends an SOS.</p></div>`;
    }

    if(myActiveSOS) {
        // SESSION PERSISTENCE: 2. If an active SOS is detected, force the view to seekerUI if they refresh back to the landing page
        if (document.getElementById('landingPage').classList.contains('view-active')) {
            window.switchView('seekerUI');
        }

        const searching = document.getElementById('searchingState');
        const matched = document.getElementById('matchedState');
        const completed = document.getElementById('completionConfirmState');
        const cancelBtn = document.getElementById('cancelSosBtn');

        // STRICT STATE TRANSITIONS
        if(myActiveSOS.status === 'open') {
            searching.style.display = 'block'; 
            matched.style.display = 'none'; 
            completed.style.display = 'none'; 
            cancelBtn.style.display = 'block';
        } else if(myActiveSOS.status === 'accepted' || myActiveSOS.status === 'arrived') {
            searching.style.display = 'none'; 
            matched.style.display = 'block'; 
            completed.style.display = 'none'; 
            cancelBtn.style.display = 'block';
            
            const hero = profilesCache[myActiveSOS.helperId] || {};
            document.getElementById('matchName').innerText = hero.name || "Roadside Hero";
            document.getElementById('matchPic').src = hero.pic || "https://via.placeholder.com/65";
            document.getElementById('matchETA').innerText = myActiveSOS.status === 'arrived' ? "Hero is at your location!" : `Arriving in ${myActiveSOS.eta || '...'}`;
            
            const matchHeroPhone = document.getElementById('matchHeroPhone');
            if (myActiveSOS.isTowTruckRequest && myActiveSOS.phoneNumber) {
                matchHeroPhone.innerHTML = `üìû Contact: <a href="tel:${myActiveSOS.phoneNumber}" style="color:var(--text); text-decoration: underline;">${myActiveSOS.phoneNumber}</a>`;
                matchHeroPhone.style.display = 'block';
            } else {
                matchHeroPhone.style.display = 'none';
            }

            updateSeekerMiniMap(myActiveSOS, hero);
        } else if(myActiveSOS.status === 'completed') {
            searching.style.display = 'none'; 
            matched.style.display = 'none'; 
            completed.style.display = 'block'; 
            cancelBtn.style.display = 'none';
        }
    } else {
        // If no active SOS, ensure seeker UI elements are hidden
        document.getElementById('searchingState').style.display = 'none'; 
        document.getElementById('matchedState').style.display = 'none'; 
        document.getElementById('completionConfirmState').style.display = 'none'; 
        document.getElementById('cancelSosBtn').style.display = 'none';
    }
    
    // Removed badge count for activity history
    // const badge = document.getElementById('notifBadge'); badge.innerText = nearbySOS.length; badge.style.display = nearbySOS.length > 0 ? "flex" : "none";
}

function updateSeekerMiniMap(sos, hero) {
    if(!seekerMiniMap) { 
        seekerMiniMap = new google.maps.Map(document.getElementById('seekerMap'), { zoom: 14, disableDefaultUI: true }); 
        
        // Seeker's own marker with the blue circle icon
        seekerUserMarker = new google.maps.Marker({ map: seekerMiniMap, icon: seekerOwnIcon }); 
        
        // Hero's marker with the custom image icon
        seekerHeroMarker = new google.maps.Marker({ map: seekerMiniMap, icon: seekerHeroCustomIcon }); 
    }

    // Seeker's location from the SOS request (fixed at request time)
    const userPos = {lat: sos.lat, lng: sos.lng}; 
    seekerUserMarker.setPosition(userPos);

    // Hero's live location from their profile (if available)
    if(hero && hero.lat && hero.lng) { 
        const heroPos = {lat: hero.lat, lng: hero.lng}; 
        seekerHeroMarker.setPosition(heroPos); 
        
        const bounds = new google.maps.LatLngBounds(); 
        bounds.extend(userPos); 
        bounds.extend(heroPos); 
        seekerMiniMap.fitBounds(bounds); 
    }
    else { 
        // If hero's live location isn't available yet, center on seeker's location
        seekerMiniMap.setCenter(userPos); 
    }
    
    // Trigger map resize after updates in case it was expanded/collapsed
    google.maps.event.trigger(seekerMiniMap, 'resize');
}

window.toggleSeekerMapExpansion = () => {
    const container = document.getElementById('seekerMapContainer');
    const expandBtn = container.querySelector('.map-expand-btn');
    const closeBtn = container.querySelector('.map-close-btn');
    
    container.classList.toggle('expanded');
    
    if (container.classList.contains('expanded')) {
        expandBtn.style.display = 'none';
        closeBtn.style.display = 'flex'; // Use flex to center 'X'
        // Ensure map resizes and re-centers correctly after expansion
        google.maps.event.trigger(seekerMiniMap, 'resize');
        if (seekerMiniMap && seekerUserMarker && seekerHeroMarker) {
             const bounds = new google.maps.LatLngBounds();
             bounds.extend(seekerUserMarker.getPosition());
             bounds.extend(seekerHeroMarker.getPosition());
             seekerMiniMap.fitBounds(bounds);
        }
    } else {
        expandBtn.style.display = 'block';
        closeBtn.style.display = 'none';
        // Ensure map resizes and re-centers correctly after collapsing
        google.maps.event.trigger(seekerMiniMap, 'resize');
        if (seekerMiniMap && seekerUserMarker && seekerHeroMarker) {
             const bounds = new google.maps.LatLngBounds();
             bounds.extend(seekerUserMarker.getPosition());
             bounds.extend(seekerHeroMarker.getPosition());
             seekerMiniMap.fitBounds(bounds);
        }
    }
};

// Function to start the tow truck icon animation
function startTowTruckAnimation() {
    if (towTruckAnimationInterval) return; // Already running
    
    towTruckAnimationInterval = setInterval(() => {
        currentTowTruckIconState = 1 - currentTowTruckIconState; // Toggle between 0 and 1
        Object.values(markers).forEach(marker => {
            const sosId = Object.keys(markers).find(key => markers[key] === marker);
            const sos = sosCache[sosId]; // Find corresponding SOS
            if (sos && sos.isTowTruckRequest && sos.status === 'open') {
                const icon = currentTowTruckIconState === 0 
                             ? getTowTruckSplitIcon("#ef4444", "#2563eb") // Left Red, Right Blue
                             : getTowTruckSplitIcon("#2563eb", "#ef4444"); // Left Blue, Right Red
                marker.setIcon(icon);
            }
        });
    }, 500); // Toggle every 500ms
}

// Function to stop the tow truck icon animation
function stopTowTruckAnimation() {
    if (towTruckAnimationInterval) {
        clearInterval(towTruckAnimationInterval);
        towTruckAnimationInterval = null;
    }
    // Reset tow truck icons to default state (e.g., Left Red, Right Blue) when animation stops
    Object.values(markers).forEach(marker => {
        const sosId = Object.keys(markers).find(key => markers[key] === marker);
        const sos = sosCache[sosId];
        if (sos && sos.isTowTruckRequest && sos.status === 'open') {
            marker.setIcon(getTowTruckSplitIcon("#ef4444", "#2563eb"));
        }
    });
}


onValue(ref(db, "sosRequests"), (snap) => { 
    sosCache = snap.val() || {}; 
    syncUI(); 
    
    // SESSION PERSISTENCE: 3. Immediately switch the view if the database loads and sees you have an active session
    const myActive = Object.values(sosCache).find(r => r.ownerId === myId && ['open', 'accepted', 'arrived', 'completed'].includes(r.status));
    if (myActive && document.getElementById('landingPage').classList.contains('view-active')) {
        window.switchView('seekerUI');
        // Pre-fill phone number if seeker revisits an active tow truck request
        if (myActive.isTowTruckRequest && myActive.phoneNumber) {
            document.getElementById('phoneNumberInput').value = myActive.phoneNumber;
            // Also ensure the tow truck button and input are visible/active
            isTowTruckRequestActive = true;
            document.getElementById('towTruckBtn').classList.add('active');
            document.getElementById('towTruckBtn').innerText = 'TOW TRUCK REQUEST ACTIVE';
            document.getElementById('towTruckContact').style.display = 'block';
            document.getElementById('phoneNumberInput').setAttribute('required', 'required');
        } else {
             // If not a tow truck request, or no phone number, ensure these are reset
            isTowTruckRequestActive = false;
            document.getElementById('towTruckBtn').classList.remove('active');
            document.getElementById('towTruckBtn').innerText = 'I NEED A TOW TRUCK!';
            document.getElementById('towTruckContact').style.display = 'none';
            document.getElementById('phoneNumberInput').removeAttribute('required');
            document.getElementById('phoneNumberInput').value = '';
        }
    }
});

// IMPORTANT: Listen to profiles for live hero tracking AND preference filtering
onValue(ref(db, "profiles"), (snap) => { 
    profilesCache = snap.val() || {}; 
    syncUI(); 

    // Update seeker minimap hero position in real-time if there's an active matched SOS
    const myActiveSOS = Object.values(sosCache).find(r => r.ownerId === myId && (r.status === 'accepted' || r.status === 'arrived'));
    if (myActiveSOS && myActiveSOS.helperId && profilesCache[myActiveSOS.helperId]) {
        updateSeekerMiniMap(myActiveSOS, profilesCache[myActiveSOS.helperId]);
    }
});

window.saveProfile = () => {
    myRadius = parseInt(document.getElementById("profileRadius").value);
    const prefersTowTruckRequests = document.getElementById("prefersTowTruckRequests").checked;

    update(ref(db, `profiles/${myId}`), { 
        name: document.getElementById("profileName").value, 
        bio: document.getElementById("profileBio").value, 
        pic: document.getElementById("profileDisplayPic").src, 
        radius: myRadius,
        prefersTowTruckRequests: prefersTowTruckRequests // Save the new preference
    });
    if(map && userLocation) { 
        const radiusInMeters = myRadius * 1609.34; 
        const circle = new google.maps.Circle({center: userLocation, radius: radiusInMeters}); 
        map.setCenter(userLocation);
        map.fitBounds(circle.getBounds()); 
    }
    window.closeModal("profileModal");
};

window.openProfile = async () => {
    window.openModal("profileModal");
    const snap = await get(ref(db, `profiles/${myId}`));
    if(snap.exists()) {
        const d = snap.val(); 
        document.getElementById("profileName").value = d.name || ""; 
        document.getElementById("profileBio").value = d.bio || ""; 
        if(d.pic) document.getElementById("profileDisplayPic").src = d.pic; 
        if(d.radius) { myRadius = d.radius; document.getElementById("profileRadius").value = d.radius; document.getElementById("radiusVal").innerText = d.radius; }
        document.getElementById("prefersTowTruckRequests").checked = d.prefersTowTruckRequests === true; // Load preference
    }
};

window.confirmDeleteActivityPrompt = (id) => {
    activityToDeleteId = id;
    window.openModal('deleteConfirmModal');
};

window.confirmDeleteActivity = () => {
    if (activityToDeleteId) {
        remove(ref(db, `sosRequests/${activityToDeleteId}`))
            .then(() => {
                console.log("Activity deleted successfully:", activityToDeleteId);
                activityToDeleteId = null; // Clear the stored ID
                window.closeModal('deleteConfirmModal');
            })
            .catch((error) => {
                console.error("Error deleting activity:", error);
                alert("Failed to delete activity. Please try again.");
            });
    }
};
</script>
</body>
</html>
