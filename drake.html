<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Drakes Memorial Billboard</title>
  <style>
    html, body {
      margin:0; padding:0; overflow:hidden; height:100%;
      font-family:sans-serif;
    }
    #viewport {
      width:100vw; height:100vh;
      background:#eef; touch-action:none; position:relative;
    }
    #billboard {
      width:5000px; height:5000px;
      position:absolute; top:0; left:0;
      transform-origin:0 0;
      background: repeating-linear-gradient(
        45deg, #ddd 0, #ddd 1px, #fff 1px, #fff 20px
      );
    }
    .media-item {
      position:absolute; max-width:300px; max-height:300px;
      object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,0.15);
      opacity:0; animation:fadeIn 0.5s forwards;
    }
    @keyframes fadeIn { to { opacity:1; } }

    #footer-bar {
      position:fixed; bottom:0; left:0; width:100%;
      background:#fff; border-top:2px solid #007bff;
      padding:12px; display:flex; justify-content:space-around;
      z-index:1000;
    }
    #upload { display:none; }
    .btn {
      background:#007bff; color:#fff; padding:10px 20px;
      border:none; border-radius:4px; cursor:pointer;
      font-size:16px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
      transition:background .2s, transform .1s;
    }
    .btn:hover { background:#0056b3; }
    .btn:active { transform:scale(0.95); }

    #toast {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.8); color:#fff; padding:8px 16px;
      border-radius:4px; font-size:14px; opacity:0;
      transition: opacity .3s; pointer-events:none; z-index:2000;
    }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

  <div id="viewport">
    <div id="billboard"></div>
  </div>

  <div id="footer-bar">
    <input id="upload" type="file" accept="image/*,video/*" multiple />
    <label for="upload" class="btn">âž• Add Media</label>
    <button id="test" class="btn">ðŸ§ª Test Image</button>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
  <script type="module">
    import { createClient } 
      from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // â”€â”€â”€â”€â”€ YOUR SUPABASE CONFIG â”€â”€â”€â”€â”€
    const supabaseUrl     = 'https://vfcucqummaxexqacunzt.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmY3VjcXVtbWF4ZXhxYWN1bnp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3MTUyMzgsImV4cCI6MjA2MjI5MTIzOH0.ugrPhlbI1byzAPFUnBfDWtK3iJsKbSfooM7_aX10dT4';
    const bucketName      = 'drakes-memorial';  // make sure this bucket exists and is public
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    const billboard = document.getElementById('billboard');
    const toast     = document.getElementById('toast');

    // initialize Panzoom
    const panzoom = Panzoom(billboard, {
      maxScale:5, minScale:0.2, contain:'outside', step:0.3
    });
    document.getElementById('viewport')
      .addEventListener('wheel', panzoom.zoomWithWheel);

    const rand = (min, max) => Math.random()*(max-min)+min;

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), 1500);
    }

    function placeURL(url) {
      const isVid = /\.(mp4|webm|ogg)$/i.test(url);
      const el = document.createElement(isVid ? 'video' : 'img');
      el.src = url;
      if (isVid) el.autoplay = el.loop = el.muted = true;
      el.className = 'media-item';
      const [bw, bh] = [billboard.clientWidth, billboard.clientHeight];
      el.style.left      = rand(0, bw - 300) + 'px';
      el.style.top       = rand(0, bh - 300) + 'px';
      el.style.transform = `rotate(${rand(-30,30)}deg)`;
      billboard.appendChild(el);
    }

    // 1) Load existing media
    async function loadAll() {
      console.log('Loading bucket:', bucketName);
      const { data, error } = await supabase
        .storage.from(bucketName)
        .list('', { limit:200, sortBy:{column:'name', order:'desc'} });
      console.log('List result:', { data, error });
      if (error) return showToast('Error loading media');
      data.forEach(entry => {
        const { data:urlData, error:urlErr } = supabase
          .storage.from(bucketName)
          .getPublicUrl(entry.name);
        if (urlData) placeURL(urlData.publicUrl);
      });
    }

    // 2) Handle uploads
    document.getElementById('upload').addEventListener('change', async e => {
      for (let file of e.target.files) {
        const filename = `${Date.now()}_${file.name}`;
        const { error: upErr } = await supabase
          .storage.from(bucketName)
          .upload(filename, file, { upsert:false });
        if (upErr) {
          console.error(upErr);
          showToast('Upload failed');
        } else {
          showToast('Uploaded!');
          const { data:urlData } = supabase
            .storage.from(bucketName)
            .getPublicUrl(filename);
          if (urlData) placeURL(urlData.publicUrl);
        }
      }
      e.target.value = '';
    });

    // 3) Test Image button
    document.getElementById('test').addEventListener('click', () => {
      placeURL('https://via.placeholder.com/250.png?text=Test');
    });

    loadAll();
  </script>
</body>
</html>
