<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pop-Up Shop - Full Store Builder</title>
<style>
  /* General reset and base styles */
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
    background: #f8f8f8; overflow-x: hidden;
  }
  button {
    cursor: pointer;
  }

  /* Admin Popup */
  #adminPopup {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.75);
    display: flex; justify-content: center; align-items: center;
    z-index: 10000;
  }
  #adminPopupContent {
    background: white; border-radius: 8px;
    padding: 24px;
    width: 400px;
    box-sizing: border-box;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  #adminPopupContent h1 {
    margin-top: 0; margin-bottom: 20px; text-align: center;
  }
  label {
    display: block; font-weight: bold; margin: 12px 0 6px;
  }
  input[type="text"], input[type="password"] {
    width: 100%; padding: 10px; box-sizing: border-box; font-size: 1rem;
    border-radius: 5px; border: 1px solid #ccc;
  }
  button.primary {
    background-color: #007bff; color: white; border: none;
    width: 100%; padding: 12px; font-weight: bold; font-size: 1rem;
    margin-top: 15px; border-radius: 5px;
  }
  button.primary:disabled {
    background-color: #aac8ff; cursor: not-allowed;
  }
  .errorMsg {
    color: red; min-height: 18px; margin-top: 6px; font-weight: 600;
    font-size: 0.9rem; text-align: center;
  }

  /* Bottom Navigation */
  #bottomNav {
    position: fixed; bottom: 0; left: 0; right: 0;
    height: 50px; background-color: #222;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px; color: #eee; font-weight: bold; font-size: 1rem;
    z-index: 9000;
  }
  #bottomNav .nav-left, #bottomNav .nav-right {
    display: flex; gap: 15px;
  }
  #bottomNav button.nav-btn {
    background: #444; border: none; color: white;
    border-radius: 5px; padding: 8px 15px;
    user-select: none;
  }

  /* Admin Dropdown */
  #adminDropdown {
    position: relative;
  }
  #adminDropdownContent {
    display: none;
    position: absolute; bottom: 55px; right: 0;
    background: white; color: #222;
    border-radius: 6px; box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    min-width: 180px;
    user-select: auto;
    z-index: 10001;
  }
  #adminDropdownContent button {
    width: 100%; padding: 10px 15px; background: none; border: none;
    text-align: left; font-weight: 600; cursor: pointer;
  }
  #adminDropdownContent button:hover {
    background-color: #f0f0f0;
  }

  /* Store Editor Modal */
  #storeEditorModal {
    position: fixed; top: 2.5%; left: 2.5%; width: 95vw; height: 95vh;
    background: white; border-radius: 10px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.35);
    display: none; flex-direction: column;
    z-index: 10002;
    user-select: auto;
  }

  /* Editor Header */
  #editorHeader {
    height: 50px; background-color: #007bff; color: white;
    border-top-left-radius: 10px; border-top-right-radius: 10px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px; font-weight: 700; font-size: 1.2rem;
  }
  #editorHeader button {
    background: #0056b3; border: none; color: white;
    padding: 8px 15px; border-radius: 5px; cursor: pointer;
  }
  #editorHeader button:hover {
    background: #003d80;
  }

  /* Editor Body */
  #editorBody {
    display: flex; flex: 1; overflow: hidden;
  }

  /* Toolbar */
  #editorToolbar {
    width: 220px; background-color: #f9f9f9; border-right: 1px solid #ccc;
    padding: 20px;
    box-sizing: border-box;
    display: flex; flex-direction: column; gap: 12px;
  }
  #editorToolbar button {
    background-color: #007bff; color: white; border: none;
    border-radius: 5px; padding: 12px; font-weight: 700;
    user-select: none;
  }
  #editorToolbar button:hover {
    background-color: #0056b3;
  }

  /* Canvas Wrapper */
  #editorCanvasWrapper {
    flex: 1; position: relative; background-color: #fff;
    border-left: 1px solid #ccc; overflow: auto;
    padding: 15px;
    box-sizing: border-box;
  }

  /* Canvas area */
  #editorCanvas {
    position: relative; width: 100%; min-height: 100%;
    border: 2px dashed #bbb;
    border-radius: 8px;
    background-color: var(--background-color, #fff);
    color: var(--font-color, #222);
    font-family: Arial, sans-serif;
  }

  /* Editor Elements */
  .editor-element {
    position: absolute;
    border: 2px solid transparent;
    border-radius: 5px;
    padding: 6px;
    background: rgba(255,255,255,0.9);
    box-sizing: border-box;
    user-select: none;
    cursor: move;
    overflow: hidden;
  }
  .editor-element.selected {
    border-color: #007bff;
    background: rgba(0,123,255,0.1);
  }
  .editor-element img {
    max-width: 100%;
    max-height: 100%;
    display: block;
    pointer-events: none;
  }

  /* Properties Panel */
  #propertiesPanel {
    width: 300px; background-color: #f9f9f9; border-left: 1px solid #ccc;
    padding: 20px; box-sizing: border-box;
    overflow-y: auto;
  }
  #propertiesPanel h3 {
    margin-top: 0; margin-bottom: 15px;
    font-weight: 700; font-size: 1.2rem;
  }
  #propertiesPanel label {
    font-weight: 600;
    display: block;
    margin: 10px 0 5px;
  }
  #propertiesPanel input[type=text], #propertiesPanel input[type=number], #propertiesPanel textarea, #propertiesPanel input[type=color] {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  #propertiesPanel textarea {
    resize: vertical;
    min-height: 80px;
  }
  #propertiesPanel button.delete-btn {
    margin-top: 15px;
    width: 100%;
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 12px;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
  }
  #propertiesPanel button.delete-btn:hover {
    background-color: #b02a37;
  }

  /* Scrollbar for properties panel */
  #propertiesPanel::-webkit-scrollbar {
    width: 8px;
  }
  #propertiesPanel::-webkit-scrollbar-thumb {
    background: #bbb;
    border-radius: 4px;
  }
</style>
</head>
<body>

<!-- Admin Login/Create Popup -->
<div id="adminPopup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
  <div id="adminPopupContent">
    <h1 id="popupTitle">Pop-Up Shop</h1>

    <section aria-label="Admin Login Section">
      <label for="loginPin">Admin PIN</label>
      <input type="password" id="loginPin" placeholder="Enter your admin PIN" autocomplete="off" />
      <button id="loginBtn" class="primary">Login</button>
      <div id="loginError" class="errorMsg" role="alert"></div>
    </section>

    <hr />

    <section aria-label="Create New Store Section">
      <label for="createTitle">New Store Title</label>
      <input type="text" id="createTitle" placeholder="Enter store title" autocomplete="off" />
      <label for="createPin">Create Admin PIN</label>
      <input type="password" id="createPin" placeholder="Create a PIN" autocomplete="off" />
      <button id="createBtn" class="primary">Create New Store</button>
      <div id="createError" class="errorMsg" role="alert"></div>
    </section>
  </div>
</div>

<!-- Store Editor Modal -->
<div id="storeEditorModal" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
  <header id="editorHeader">
    <h2 id="editorTitle" style="margin: 0;"></h2>
    <div>
      <button id="saveStoreBtn" title="Save Store">Save</button>
      <button id="viewStoreBtn" title="View Live Store">View Store</button>
      <button id="exportStoreBtn" title="Export Store HTML">Export HTML</button>
      <button id="closeEditorBtn" title="Close Editor">Close</button>
    </div>
  </header>
  <main id="editorBody">
    <nav id="editorToolbar" aria-label="Add Elements Toolbar">
      <button id="addTextBtn" title="Add Text">Add Text</button>
      <button id="addImageBtn" title="Add Image">Add Image</button>
      <button id="addCategoryBtn" title="Add Product Category">Add Category</button>
      <button id="addProductBtn" title="Add Product">Add Product</button>
      <button id="addNavButtonBtn" title="Add Nav Button">Add Nav Button</button>
      <button id="themeSettingsBtn" title="Theme Settings">Theme</button>
    </nav>
    <section id="editorCanvasWrapper" tabindex="0" aria-label="Page Layout Editor">
      <div id="editorCanvas"></div>
    </section>
    <aside id="propertiesPanel" aria-label="Element Properties Panel">
      <h3>Properties</h3>
      <div id="propertiesContent">Select an element to edit its properties.</div>
    </aside>
  </main>
</div>

<!-- Bottom Navigation Bar -->
<nav id="bottomNav" aria-label="Main Navigation">
  <div class="nav-left" role="menubar" aria-label="Primary Navigation">
    <button id="homeBtn" class="nav-btn" role="menuitem">Home</button>
  </div>
  <div class="nav-right" id="adminDropdown" role="menu" aria-haspopup="true" aria-label="Admin Menu">
    <button id="adminDropdownBtn" class="nav-btn" aria-expanded="false" aria-controls="adminDropdownContent" role="menuitem">Admin ▼</button>
    <div id="adminDropdownContent" role="menu" aria-hidden="true">
      <button id="openAdminEditorBtn" role="menuitem">Open Admin Editor</button>
      <button id="logoutBtn" role="menuitem">Logout</button>
    </div>
  </div>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase config (your project config here)
  const firebaseConfig = {
    apiKey: "AIzaSyAoWuLi-47H_0hvGzhqCx7lhQUpVwMvjVw",
    authDomain: "popupshop-59cfa.firebaseapp.com",
    projectId: "popupshop-59cfa",
    storageBucket: "popupshop-59cfa.firebasestorage.app",
    messagingSenderId: "993129063429",
    appId: "1:993129063429:web:701de513ba59ea1f04a86c",
    measurementId: "G-SK505GZFCK",
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM Elements
  const adminPopup = document.getElementById('adminPopup');
  const loginPinInput = document.getElementById('loginPin');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  const createTitleInput = document.getElementById('createTitle');
  const createPinInput = document.getElementById('createPin');
  const createBtn = document.getElementById('createBtn');
  const createError = document.getElementById('createError');

  const storeEditorModal = document.getElementById('storeEditorModal');
  const editorCanvas = document.getElementById('editorCanvas');
  const propertiesPanel = document.getElementById('propertiesContent');
  const editorTitle = document.getElementById('editorTitle');

  const saveStoreBtn = document.getElementById('saveStoreBtn');
  const viewStoreBtn = document.getElementById('viewStoreBtn');
  const exportStoreBtn = document.getElementById('exportStoreBtn');
  const closeEditorBtn = document.getElementById('closeEditorBtn');

  const editorToolbar = document.getElementById('editorToolbar');
  const addTextBtn = document.getElementById('addTextBtn');
  const addImageBtn = document.getElementById('addImageBtn');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const addProductBtn = document.getElementById('addProductBtn');
  const addNavButtonBtn = document.getElementById('addNavButtonBtn');
  const themeSettingsBtn = document.getElementById('themeSettingsBtn');

  const bottomNav = document.getElementById('bottomNav');
  const navLeft = bottomNav.querySelector('.nav-left');
  const adminDropdownBtn = document.getElementById('adminDropdownBtn');
  const adminDropdownContent = document.getElementById('adminDropdownContent');
  const openAdminEditorBtn = document.getElementById('openAdminEditorBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const homeBtn = document.getElementById('homeBtn');

  // State
  let currentStore = null; // { id, title, pin, layout, navButtons, theme }
  let selectedElementId = null;
  let adminDropdownOpen = false;

  // Helpers

  function localStorageKey(storeId) {
    return `popupshop_store_${storeId}`;
  }

  // Show/hide admin dropdown menu
  adminDropdownBtn.addEventListener('click', () => {
    adminDropdownOpen = !adminDropdownOpen;
    adminDropdownContent.style.display = adminDropdownOpen ? 'block' : 'none';
    adminDropdownBtn.setAttribute('aria-expanded', adminDropdownOpen.toString());
  });

  window.addEventListener('click', (e) => {
    if (!adminDropdownBtn.contains(e.target) && !adminDropdownContent.contains(e.target)) {
      adminDropdownOpen = false;
      adminDropdownContent.style.display = 'none';
      adminDropdownBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // Load store by PIN
  async function loadStoreByPin(pin) {
    try {
      const storesCol = collection(db, 'stores');
      const q = query(storesCol, where('pin', '==', pin));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) return null;
      const docSnap = querySnapshot.docs[0];
      return { id: docSnap.id, ...docSnap.data() };
    } catch (e) {
      console.error('Firestore load error:', e);
      return null;
    }
  }

  // Create new store
  async function createNewStore(title, pin) {
    if (!title || !pin) return null;
    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    const rand = Math.random().toString(36).slice(2, 7);
    const storeId = `${slug}-${rand}`;
    const newStore = {
      title,
      pin,
      layout: [],
      navButtons: [],
      theme: {
        backgroundColor: '#ffffff',
        backgroundImage: '',
        navBarColor: '#222222',
        navBarTextColor: '#eeeeee',
        fontColor: '#222222',
      },
      createdAt: new Date().toISOString(),
    };
    try {
      await setDoc(doc(db, 'stores', storeId), newStore);
      return { id: storeId, ...newStore };
    } catch (e) {
      console.error('Firestore create error:', e);
      return null;
    }
  }

  // Save store with fallback localStorage
  async function saveStore(store) {
    try {
      await setDoc(doc(db, 'stores', store.id), store);
      localStorage.removeItem(localStorageKey(store.id));
      alert('Store saved successfully.');
      return true;
    } catch (e) {
      console.warn('Firestore save failed, trying localStorage:', e);
      try {
        localStorage.setItem(localStorageKey(store.id), JSON.stringify(store));
        alert('Saved locally due to network issue.');
        return true;
      } catch (err) {
        console.error('LocalStorage save failed:', err);
        alert('Failed to save store.');
        return false;
      }
    }
  }

  // Load store from Firestore or localStorage fallback
  async function loadStore(storeId) {
    try {
      const docSnap = await getDoc(doc(db, 'stores', storeId));
      if (docSnap.exists()) return docSnap.data();
      const lsData = localStorage.getItem(localStorageKey(storeId));
      if (lsData) return JSON.parse(lsData);
      return null;
    } catch (e) {
      console.warn('Firestore load failed, trying localStorage:', e);
      const lsData = localStorage.getItem(localStorageKey(storeId));
      if (lsData) return JSON.parse(lsData);
      return null;
    }
  }

  // Render nav buttons in fixed bottom nav (keep Home and Admin fixed)
  function renderNavButtons() {
    // Remove custom nav buttons first
    [...navLeft.querySelectorAll('.nav-btn.custom')].forEach(btn => btn.remove());
    if (!currentStore || !currentStore.navButtons) return;
    currentStore.navButtons.forEach(btnData => {
      const btn = document.createElement('button');
      btn.textContent = btnData.label;
      btn.classList.add('nav-btn', 'custom');
      btn.addEventListener('click', () => {
        if (btnData.link) window.open(btnData.link, '_blank');
      });
      navLeft.appendChild(btn);
    });
  }

  // Render elements on canvas
  function renderElements() {
    editorCanvas.innerHTML = '';
    if (!currentStore?.layout) return;
    currentStore.layout.forEach(el => {
      const elDiv = document.createElement('div');
      elDiv.classList.add('editor-element');
      if (el.id === selectedElementId) elDiv.classList.add('selected');
      elDiv.dataset.id = el.id;
      elDiv.style.left = (el.position?.x ?? 10) + 'px';
      elDiv.style.top = (el.position?.y ?? 10) + 'px';
      elDiv.style.width = (el.size?.width ?? 150) + 'px';
      elDiv.style.height = (el.size?.height ?? 100) + 'px';
      elDiv.style.color = currentStore.theme.fontColor || '#222';

      // Render content by type
      switch (el.type) {
        case 'text':
          elDiv.textContent = el.content || 'Text';
          elDiv.style.fontSize = (el.fontSize || 16) + 'px';
          elDiv.style.fontWeight = el.bold ? 'bold' : 'normal';
          elDiv.style.fontStyle = el.italic ? 'italic' : 'normal';
          elDiv.style.textDecoration = el.underline ? 'underline' : 'none';
          elDiv.style.color = el.color || currentStore.theme.fontColor || '#222';
          break;
        case 'image':
          if (el.src) {
            const img = document.createElement('img');
            img.src = el.src;
            img.alt = el.alt || '';
            elDiv.appendChild(img);
          } else {
            elDiv.textContent = 'Image';
          }
          break;
        case 'category':
          elDiv.textContent = `Category: ${el.title || '(No title)'}`;
          elDiv.style.fontWeight = '700';
          elDiv.style.fontSize = '16px';
          break;
        case 'product':
          elDiv.textContent = `Product: ${el.title || '(No title)'}`;
          elDiv.style.fontSize = '14px';
          break;
        case 'navButton':
          elDiv.textContent = `Nav Btn: ${el.label || '(No label)'}`;
          elDiv.style.backgroundColor = '#007bff';
          elDiv.style.color = '#fff';
          elDiv.style.textAlign = 'center';
          elDiv.style.padding = '4px';
          elDiv.style.borderRadius = '4px';
          break;
        default:
          elDiv.textContent = 'Unknown Element';
      }

      elDiv.addEventListener('mousedown', e => {
        e.stopPropagation();
        selectElement(el.id);
      });

      editorCanvas.appendChild(elDiv);
    });
  }

  // Generate unique ID for elements
  function generateId() {
    return 'el-' + Math.random().toString(36).slice(2, 10);
  }

  // Select element
  function selectElement(id) {
    selectedElementId = id;
    renderElements();
    updatePropertiesPanel();
  }

  // Clear selection
  function clearSelection() {
    selectedElementId = null;
    renderElements();
    updatePropertiesPanel();
  }

  // Update properties panel based on selected element
  function updatePropertiesPanel() {
    const panel = propertiesPanel;
    panel.innerHTML = '';
    if (!selectedElementId) {
      panel.textContent = 'Select an element to edit its properties.';
      return;
    }
    const el = currentStore.layout.find(e => e.id === selectedElementId);
    if (!el) {
      panel.textContent = 'Selected element not found.';
      return;
    }

    // Title
    const title = document.createElement('h3');
    title.textContent = `Edit ${el.type.charAt(0).toUpperCase() + el.type.slice(1)}`;
    panel.appendChild(title);

    // Position X
    const posXLabel = document.createElement('label');
    posXLabel.textContent = 'Position X (px)';
    const posXInput = document.createElement('input');
    posXInput.type = 'number';
    posXInput.value = el.position?.x ?? 10;
    posXInput.addEventListener('input', () => {
      el.position = el.position || {};
      el.position.x = parseInt(posXInput.value) || 0;
      renderElements();
    });
    panel.appendChild(posXLabel);
    panel.appendChild(posXInput);

    // Position Y
    const posYLabel = document.createElement('label');
    posYLabel.textContent = 'Position Y (px)';
    const posYInput = document.createElement('input');
    posYInput.type = 'number';
    posYInput.value = el.position?.y ?? 10;
    posYInput.addEventListener('input', () => {
      el.position = el.position || {};
      el.position.y = parseInt(posYInput.value) || 0;
      renderElements();
    });
    panel.appendChild(posYLabel);
    panel.appendChild(posYInput);

    // Width
    const widthLabel = document.createElement('label');
    widthLabel.textContent = 'Width (px)';
    const widthInput = document.createElement('input');
    widthInput.type = 'number';
    widthInput.value = el.size?.width ?? 150;
    widthInput.addEventListener('input', () => {
      el.size = el.size || {};
      el.size.width = parseInt(widthInput.value) || 150;
      renderElements();
    });
    panel.appendChild(widthLabel);
    panel.appendChild(widthInput);

    // Height
    const heightLabel = document.createElement('label');
    heightLabel.textContent = 'Height (px)';
    const heightInput = document.createElement('input');
    heightInput.type = 'number';
    heightInput.value = el.size?.height ?? 100;
    heightInput.addEventListener('input', () => {
      el.size = el.size || {};
      el.size.height = parseInt(heightInput.value) || 100;
      renderElements();
    });
    panel.appendChild(heightLabel);
    panel.appendChild(heightInput);

    // Type-specific properties
    if (el.type === 'text') {
      // Content textarea
      const contentLabel = document.createElement('label');
      contentLabel.textContent = 'Text Content';
      const contentInput = document.createElement('textarea');
      contentInput.value = el.content || '';
      contentInput.addEventListener('input', () => {
        el.content = contentInput.value;
        renderElements();
      });
      panel.appendChild(contentLabel);
      panel.appendChild(contentInput);

      // Font size
      const fontSizeLabel = document.createElement('label');
      fontSizeLabel.textContent = 'Font Size (px)';
      const fontSizeInput = document.createElement('input');
      fontSizeInput.type = 'number';
      fontSizeInput.value = el.fontSize || 16;
      fontSizeInput.addEventListener('input', () => {
        el.fontSize = parseInt(fontSizeInput.value) || 16;
        renderElements();
      });
      panel.appendChild(fontSizeLabel);
      panel.appendChild(fontSizeInput);

      // Color
      const colorLabel = document.createElement('label');
      colorLabel.textContent = 'Font Color';
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = el.color || '#222222';
      colorInput.addEventListener('input', () => {
        el.color = colorInput.value;
        renderElements();
      });
      panel.appendChild(colorLabel);
      panel.appendChild(colorInput);

      // Bold
      const boldLabel = document.createElement('label');
      boldLabel.textContent = 'Bold';
      const boldCheckbox = document.createElement('input');
      boldCheckbox.type = 'checkbox';
      boldCheckbox.checked = el.bold || false;
      boldCheckbox.addEventListener('change', () => {
        el.bold = boldCheckbox.checked;
        renderElements();
      });
      panel.appendChild(boldLabel);
      panel.appendChild(boldCheckbox);

      // Italic
      const italicLabel = document.createElement('label');
      italicLabel.textContent = 'Italic';
      const italicCheckbox = document.createElement('input');
      italicCheckbox.type = 'checkbox';
      italicCheckbox.checked = el.italic || false;
      italicCheckbox.addEventListener('change', () => {
        el.italic = italicCheckbox.checked;
        renderElements();
      });
      panel.appendChild(italicLabel);
      panel.appendChild(italicCheckbox);

      // Underline
      const underlineLabel = document.createElement('label');
      underlineLabel.textContent = 'Underline';
      const underlineCheckbox = document.createElement('input');
      underlineCheckbox.type = 'checkbox';
      underlineCheckbox.checked = el.underline || false;
      underlineCheckbox.addEventListener('change', () => {
        el.underline = underlineCheckbox.checked;
        renderElements();
      });
      panel.appendChild(underlineLabel);
      panel.appendChild(underlineCheckbox);
    } else if (el.type === 'image') {
      // Image URL
      const srcLabel = document.createElement('label');
      srcLabel.textContent = 'Image URL';
      const srcInput = document.createElement('input');
      srcInput.type = 'text';
      srcInput.value = el.src || '';
      srcInput.addEventListener('input', () => {
        el.src = srcInput.value;
        renderElements();
      });
      panel.appendChild(srcLabel);
      panel.appendChild(srcInput);

      // Alt Text
      const altLabel = document.createElement('label');
      altLabel.textContent = 'Alt Text';
      const altInput = document.createElement('input');
      altInput.type = 'text';
      altInput.value = el.alt || '';
      altInput.addEventListener('input', () => {
        el.alt = altInput.value;
      });
      panel.appendChild(altLabel);
      panel.appendChild(altInput);
    } else if (el.type === 'navButton') {
      // Label
      const labelLabel = document.createElement('label');
      labelLabel.textContent = 'Button Label';
      const labelInput = document.createElement('input');
      labelInput.type = 'text';
      labelInput.value = el.label || '';
      labelInput.addEventListener('input', () => {
        el.label = labelInput.value;
        renderElements();
      });
      panel.appendChild(labelLabel);
      panel.appendChild(labelInput);

      // Link
      const linkLabel = document.createElement('label');
      linkLabel.textContent = 'Link URL';
      const linkInput = document.createElement('input');
      linkInput.type = 'text';
      linkInput.value = el.link || '';
      linkInput.addEventListener('input', () => {
        el.link = linkInput.value;
      });
      panel.appendChild(linkLabel);
      panel.appendChild(linkInput);
    } else if (el.type === 'category' || el.type === 'product') {
      // Title
      const titleLabel = document.createElement('label');
      titleLabel.textContent = 'Title';
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.value = el.title || '';
      titleInput.addEventListener('input', () => {
        el.title = titleInput.value;
        renderElements();
      });
      panel.appendChild(titleLabel);
      panel.appendChild(titleInput);

      if (el.type === 'product') {
        // Description
        const descLabel = document.createElement('label');
        descLabel.textContent = 'Description';
        const descInput = document.createElement('textarea');
        descInput.value = el.description || '';
        descInput.addEventListener('input', () => {
          el.description = descInput.value;
        });
        panel.appendChild(descLabel);
        panel.appendChild(descInput);

        // Price
        const priceLabel = document.createElement('label');
        priceLabel.textContent = 'Price ($)';
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.min = 0;
        priceInput.step = 0.01;
        priceInput.value = el.price || 0;
        priceInput.addEventListener('input', () => {
          el.price = parseFloat(priceInput.value) || 0;
        });
        panel.appendChild(priceLabel);
        panel.appendChild(priceInput);
      }
    }

    // Delete button
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'Delete Element';
    delBtn.addEventListener('click', () => {
      currentStore.layout = currentStore.layout.filter(e => e.id !== el.id);
      selectedElementId = null;
      renderElements();
      updatePropertiesPanel();
    });
    panel.appendChild(delBtn);
  }

  // Add element function
  function addElement(type) {
    if (!currentStore) return;
    const newEl = {
      id: generateId(),
      type,
      position: { x: 20, y: 20 },
      size: { width: 150, height: 100 }
    };
    switch (type) {
      case 'text':
        newEl.content = 'New text';
        newEl.color = '#222222';
        newEl.fontSize = 16;
        break;
      case 'image':
        newEl.src = '';
        newEl.alt = '';
        break;
      case 'category':
        newEl.title = 'New Category';
        break;
      case 'product':
        newEl.title = 'New Product';
        newEl.description = '';
        newEl.price = 0;
        break;
      case 'navButton':
        newEl.label = 'New Nav Button';
        newEl.link = '#';
        break;
    }
    currentStore.layout.push(newEl);
    renderElements();
    selectElement(newEl.id);
  }

  addTextBtn.addEventListener('click', () => addElement('text'));
  addImageBtn.addEventListener('click', () => addElement('image'));
  addCategoryBtn.addEventListener('click', () => addElement('category'));
  addProductBtn.addEventListener('click', () => addElement('product'));
  addNavButtonBtn.addEventListener('click', () => addElement('navButton'));

  // Save store button
  saveStoreBtn.addEventListener('click', async () => {
    if (!currentStore) return alert('No store loaded');
    await saveStore(currentStore);
  });

  // View live store button - renders store without admin UI
  viewStoreBtn.addEventListener('click', () => {
    if (!currentStore) return alert('No store loaded');
    const liveWindow = window.open('', '_blank');
    liveWindow.document.write(generateLiveStoreHTML(currentStore));
    liveWindow.document.close();
  });

  // Export HTML button - triggers download of store page HTML
  exportStoreBtn.addEventListener('click', () => {
    if (!currentStore) return alert('No store loaded');
    const htmlContent = generateLiveStoreHTML(currentStore);
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const safeTitle = (currentStore.title || 'popupshop').toLowerCase().replace(/[^a-z0-9]+/g, '-');
    a.download = `${safeTitle}.html`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Close editor modal
  closeEditorBtn.addEventListener('click', () => {
    if (confirm('Close editor and return to login? Unsaved changes will be lost.')) {
      currentStore = null;
      selectedElementId = null;
      storeEditorModal.style.display = 'none';
      adminPopup.style.display = 'flex';
      resetLoginCreateFields();
    }
  });

  // Reset login/create fields
  function resetLoginCreateFields() {
    loginPinInput.value = '';
    createTitleInput.value = '';
    createPinInput.value = '';
    loginError.textContent = '';
    createError.textContent = '';
  }

  // Admin login button
  loginBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    const pin = loginPinInput.value.trim();
    if (!pin) {
      loginError.textContent = 'Please enter a PIN.';
      return;
    }
    loginBtn.disabled = true;
    const store = await loadStoreByPin(pin);
    loginBtn.disabled = false;
    if (!store) {
      loginError.textContent = 'Invalid PIN or store not found.';
      return;
    }
    openStoreEditor(store);
  });

  // Create new store button
  createBtn.addEventListener('click', async () => {
    createError.textContent = '';
    const title = createTitleInput.value.trim();
    const pin = createPinInput.value.trim();
    if (!title || !pin) {
      createError.textContent = 'Please enter both store title and PIN.';
      return;
    }
    createBtn.disabled = true;
    const newStore = await createNewStore(title, pin);
    createBtn.disabled = false;
    if (!newStore) {
      createError.textContent = 'Failed to create store. Try again.';
      return;
    }
    openStoreEditor(newStore);
  });

  // Logout button
  logoutBtn.addEventListener('click', () => {
    if (confirm('Logout and return to login? Unsaved changes will be lost.')) {
      currentStore = null;
      selectedElementId = null;
      storeEditorModal.style.display = 'none';
      adminPopup.style.display = 'flex';
      resetLoginCreateFields();
      editorCanvas.innerHTML = '';
      propertiesPanel.textContent = 'Select an element to edit its properties.';
      navLeft.querySelectorAll('.nav-btn.custom').forEach(btn => btn.remove());
    }
  });

  // Open editor button in admin dropdown
  openAdminEditorBtn.addEventListener('click', () => {
    if (currentStore) {
      storeEditorModal.style.display = 'flex';
      adminDropdownContent.style.display = 'none';
      adminDropdownBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // Home button click (placeholder)
  homeBtn.addEventListener('click', () => {
    alert('Home button clicked!');
  });

  // Generate live store HTML from store data
  function generateLiveStoreHTML(store) {
    const bgImage = store.theme.backgroundImage ? `url('${store.theme.backgroundImage}')` : 'none';
    const bgColor = store.theme.backgroundColor || '#fff';
    const navBarColor = store.theme.navBarColor || '#222';
    const navBarTextColor = store.theme.navBarTextColor || '#eee';
    const fontColor = store.theme.fontColor || '#222';

    // Compose elements HTML
    let elementsHTML = '';
    (store.layout || []).forEach(el => {
      const style = `
        position: absolute;
        left: ${el.position?.x || 10}px;
        top: ${el.position?.y || 10}px;
        width: ${el.size?.width || 150}px;
        height: ${el.size?.height || 100}px;
        color: ${fontColor};
        overflow: hidden;
        ${el.type === 'text' ? `
          font-size: ${el.fontSize || 16}px;
          font-weight: ${el.bold ? 'bold' : 'normal'};
          font-style: ${el.italic ? 'italic' : 'normal'};
          text-decoration: ${el.underline ? 'underline' : 'none'};
          color: ${el.color || fontColor};
          background: transparent;
          padding: 4px;
          box-sizing: border-box;
        ` : ''}
        ${el.type === 'navButton' ? 'background-color: #007bff; color: white; text-align: center; border-radius: 4px; padding: 4px;' : ''}
      `;

      let content = '';
      switch (el.type) {
        case 'text':
          content = el.content || '';
          break;
        case 'image':
          content = el.src ? `<img src="${el.src}" alt="${el.alt || ''}" style="max-width:100%; max-height:100%;">` : 'Image';
          break;
        case 'category':
          content = `<strong>Category: </strong>${el.title || '(No title)'}`;
          break;
        case 'product':
          content = `<strong>Product: </strong>${el.title || '(No title)'}<br>${el.description || ''}<br><em>Price: $${el.price?.toFixed(2) || '0.00'}</em>`;
          break;
        case 'navButton':
          content = el.label || 'Nav Button';
          break;
        default:
          content = 'Unknown Element';
      }

      if(el.type === 'navButton' && el.link) {
        content = `<a href="${el.link}" target="_blank" style="color:inherit; text-decoration:none;">${content}</a>`;
      }

      elementsHTML += `<div style="${style}">${content}</div>`;
    });

    // Compose nav buttons HTML (fixed home + admin nav not included)
    let navButtonsHTML = '';
    (store.navButtons || []).forEach(btn => {
      navButtonsHTML += `
        <button onclick="window.open('${btn.link || '#'}','_blank')" style="
          background:#444; border:none; color:#eee; margin-left:8px;
          padding: 6px 14px; border-radius: 5px; cursor:pointer;
        ">${btn.label}</button>
      `;
    });

    return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>${store.title || 'Pop-Up Shop'}</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      background-color: ${bgColor};
      background-image: ${bgImage};
      background-size: cover;
      color: ${fontColor};
      font-family: Arial, sans-serif;
      position: relative;
      overflow-x: hidden;
    }
    #pageContent {
      position: relative;
      min-height: 100vh;
      padding-bottom: 60px; /* space for nav */
    }
    #fixedNav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 50px;
      background-color: ${navBarColor};
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 0 15px;
      box-sizing: border-box;
      color: ${navBarTextColor};
      font-weight: bold;
    }
    #fixedNav button {
      background: #444; border: none; color: ${navBarTextColor};
      border-radius: 5px; padding: 8px 15px;
      margin-right: 12px;
      cursor: pointer;
      user-select: none;
      font-size: 1rem;
    }
    #fixedNav button:hover {
      background: #666;
    }
    #contentArea {
      position: relative;
      padding: 15px;
      min-height: calc(100vh - 50px);
    }
    #elementsContainer {
      position: relative;
      width: 100%;
      height: 100%;
    }
    #elementsContainer > div {
      position: absolute;
      box-sizing: border-box;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="pageContent">
    <div id="contentArea">
      <div id="elementsContainer">
        ${elementsHTML}
      </div>
    </div>
    <nav id="fixedNav" role="navigation" aria-label="Main navigation">
      <button onclick="alert('Home clicked!')">Home</button>
      ${navButtonsHTML}
      <button onclick="alert('Admin menu - not implemented')">Admin ▼</button>
    </nav>
  </div>
</body>
</html>`;
  }

  // Open store editor modal
  function openStoreEditor(store) {
    currentStore = store;
    selectedElementId = null;
    adminPopup.style.display = 'none';
    storeEditorModal.style.display = 'flex';
    editorTitle.textContent = store.title || 'Store Editor';
    renderElements();
    renderNavButtons();
    updatePropertiesPanel();
  }

  // Generate unique ID for elements
  function generateId() {
    return 'el-' + Math.random().toString(36).slice(2, 10);
  }

  // Clear selection when clicking outside elements
  editorCanvas.addEventListener('mousedown', () => {
    clearSelection();
  });

  // Basic drag functionality
  let dragElement = null;
  let dragOffsetX = 0;
  let dragOffsetY = 0;

  editorCanvas.addEventListener('mousedown', e => {
    const target = e.target.closest('.editor-element');
    if (!target) return;
    e.preventDefault();
    dragElement = currentStore.layout.find(el => el.id === target.dataset.id);
    if (!dragElement) return;
    selectElement(dragElement.id);
    const rect = target.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    function onMouseMove(e) {
      if (!dragElement) return;
      const canvasRect = editorCanvas.getBoundingClientRect();
      let newX = e.clientX - canvasRect.left - dragOffsetX;
      let newY = e.clientY - canvasRect.top - dragOffsetY;
      newX = Math.max(0, newX);
      newY = Math.max(0, newY);
      dragElement.position.x = newX;
      dragElement.position.y = newY;
      renderElements();
      updatePropertiesPanel();
    }

    function onMouseUp() {
      dragElement = null;
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
    }

    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
  });

  // Touch events for drag (basic)
  editorCanvas.addEventListener('touchstart', e => {
    const target = e.target.closest('.editor-element');
    if (!target) return;
    e.preventDefault();
    dragElement = currentStore.layout.find(el => el.id === target.dataset.id);
    if (!dragElement) return;
    selectElement(dragElement.id);
    const rect = target.getBoundingClientRect();
    const touch = e.touches[0];
    dragOffsetX = touch.clientX - rect.left;
    dragOffsetY = touch.clientY - rect.top;

    function onTouchMove(e) {
      if (!dragElement) return;
      const canvasRect = editorCanvas.getBoundingClientRect();
      const touchMove = e.touches[0];
      let newX = touchMove.clientX - canvasRect.left - dragOffsetX;
      let newY = touchMove.clientY - canvasRect.top - dragOffsetY;
      newX = Math.max(0, newX);
      newY = Math.max(0, newY);
      dragElement.position.x = newX;
      dragElement.position.y = newY;
      renderElements();
      updatePropertiesPanel();
    }

    function onTouchEnd() {
      dragElement = null;
      window.removeEventListener('touchmove', onTouchMove);
      window.removeEventListener('touchend', onTouchEnd);
      window.removeEventListener('touchcancel', onTouchEnd);
    }

    window.addEventListener('touchmove', onTouchMove, { passive: false });
    window.addEventListener('touchend', onTouchEnd);
    window.addEventListener('touchcancel', onTouchEnd);
  });

  // Theme settings modal (simple prompt for background color and nav bar color)
  themeSettingsBtn.addEventListener('click', () => {
    if (!currentStore) return alert('No store loaded');
    const bgColor = prompt('Set page background color (hex or CSS color):', currentStore.theme.backgroundColor || '#ffffff');
    if (bgColor !== null) currentStore.theme.backgroundColor = bgColor.trim() || '#ffffff';
    const bgImage = prompt('Set background image URL (leave blank for none):', currentStore.theme.backgroundImage || '');
    if (bgImage !== null) currentStore.theme.backgroundImage = bgImage.trim();
    const navColor = prompt('Set nav bar background color:', currentStore.theme.navBarColor || '#222222');
    if (navColor !== null) currentStore.theme.navBarColor = navColor.trim() || '#222222';
    const navTextColor = prompt('Set nav bar text color:', currentStore.theme.navBarTextColor || '#eeeeee');
    if (navTextColor !== null) currentStore.theme.navBarTextColor = navTextColor.trim() || '#eeeeee';
    const fontColor = prompt('Set page font color:', currentStore.theme.fontColor || '#222222');
    if (fontColor !== null) currentStore.theme.fontColor = fontColor.trim() || '#222222';

    applyTheme();
  });

  // Apply theme colors to editor canvas and bottom nav
  function applyTheme() {
    if (!currentStore) return;
    const bgColor = currentStore.theme.backgroundColor || '#fff';
    const bgImage = currentStore.theme.backgroundImage ? `url('${currentStore.theme.backgroundImage}')` : 'none';
    const fontColor = currentStore.theme.fontColor || '#222';
    editorCanvas.style.setProperty('--background-color', bgColor);
    editorCanvas.style.backgroundImage = bgImage;
    editorCanvas.style.color = fontColor;

    bottomNav.style.backgroundColor = currentStore.theme.navBarColor || '#222';
    bottomNav.style.color = currentStore.theme.navBarTextColor || '#eee';

    // Update nav buttons text color
    [...navLeft.querySelectorAll('button')].forEach(btn => {
      btn.style.color = currentStore.theme.navBarTextColor || '#eee';
    });
  }

  // Initialize page with popup visible
  adminPopup.style.display = 'flex';

</script>

</body>
</html>
