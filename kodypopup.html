<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pop-Up Shop Store Editor</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
  }
  #adminPopup {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.75);
    display: flex; justify-content: center; align-items: center;
    z-index: 1000;
  }
  #adminPopupContent {
    background: white; border-radius: 8px;
    width: 400px; max-width: 90vw; padding: 20px;
    box-sizing: border-box;
  }
  #adminPopupContent h1 {
    margin-top: 0; margin-bottom: 20px; text-align: center;
  }
  .section {
    margin-bottom: 20px;
  }
  label {
    display: block; margin-bottom: 5px; font-weight: bold;
  }
  input[type="text"], input[type="password"] {
    width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;
  }
  button {
    padding: 10px 15px; cursor: pointer;
    background: #007bff; color: white; border: none; border-radius: 4px;
    font-size: 1rem;
  }
  button:disabled {
    background: #aaa;
  }
  #errorMsg {
    color: red; margin-bottom: 10px; text-align: center;
  }
  #storeEditor {
    display: none;
    padding: 20px;
  }
  #bottomNav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #222; color: white;
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 20px;
    font-size: 1rem;
    z-index: 999;
  }
  #bottomNav .nav-left, #bottomNav .nav-right {
    display: flex; align-items: center; gap: 10px;
  }
  #bottomNav button.nav-btn {
    background: #444; color: white; border: none; border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
  }
  #adminDropdown {
    position: relative;
  }
  #adminDropdownContent {
    display: none;
    position: absolute;
    bottom: 40px; right: 0;
    background: white;
    color: black;
    border: 1px solid #ccc;
    border-radius: 4px;
    min-width: 150px;
    z-index: 1001;
  }
  #adminDropdownContent button {
    width: 100%; padding: 10px; border: none; background: none;
    text-align: left; cursor: pointer;
  }
  #adminDropdownContent button:hover {
    background: #eee;
  }
</style>
</head>
<body>

<!-- Admin Popup -->
<div id="adminPopup">
  <div id="adminPopupContent">
    <h1>Pop-Up Shop</h1>
    <div class="section" id="loginSection">
      <label for="adminPinInput">Enter Admin PIN:</label>
      <input type="password" id="adminPinInput" placeholder="Admin PIN" />
      <button id="verifyPinBtn">Verify</button>
      <div id="loginErrorMsg" style="color:red;"></div>
    </div>
    <hr />
    <div class="section" id="createSection">
      <label for="newStoreTitleInput">New Store Title:</label>
      <input type="text" id="newStoreTitleInput" placeholder="Store Title" />
      <label for="newAdminPinInput">New Admin PIN:</label>
      <input type="password" id="newAdminPinInput" placeholder="Create PIN" />
      <button id="createStoreBtn">Create Store</button>
      <div id="createErrorMsg" style="color:red;"></div>
    </div>
  </div>
</div>

<!-- Store Editor Placeholder -->
<div id="storeEditor">
  <h2>Store Editor</h2>
  <p>Welcome, <span id="storeTitleDisplay"></span>!</p>
  <button id="viewStoreBtn">View Live Store</button>
  <button id="logoutBtn">Logout</button>
  <!-- Admin editor UI will go here in later steps -->
</div>

<!-- Bottom Navigation -->
<div id="bottomNav">
  <div class="nav-left">
    <button class="nav-btn" id="homeBtn">Home</button>
    <!-- Extra nav buttons added dynamically here -->
  </div>
  <div class="nav-right" id="adminDropdown">
    <button class="nav-btn" id="adminDropdownBtn">Admin â–¼</button>
    <div id="adminDropdownContent">
      <button id="openAdminEditorBtn">Open Admin Editor</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase imports and initialization
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAoWuLi-47H_0hvGzhqCx7lhQUpVwMvjVw",
    authDomain: "popupshop-59cfa.firebaseapp.com",
    projectId: "popupshop-59cfa",
    storageBucket: "popupshop-59cfa.firebasestorage.app",
    messagingSenderId: "993129063429",
    appId: "1:993129063429:web:701de513ba59ea1f04a86c",
    measurementId: "G-SK505GZFCK",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM Elements
  const adminPopup = document.getElementById("adminPopup");
  const adminPinInput = document.getElementById("adminPinInput");
  const verifyPinBtn = document.getElementById("verifyPinBtn");
  const loginErrorMsg = document.getElementById("loginErrorMsg");

  const newStoreTitleInput = document.getElementById("newStoreTitleInput");
  const newAdminPinInput = document.getElementById("newAdminPinInput");
  const createStoreBtn = document.getElementById("createStoreBtn");
  const createErrorMsg = document.getElementById("createErrorMsg");

  const storeEditor = document.getElementById("storeEditor");
  const storeTitleDisplay = document.getElementById("storeTitleDisplay");
  const viewStoreBtn = document.getElementById("viewStoreBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const bottomNav = document.getElementById("bottomNav");
  const navLeft = bottomNav.querySelector(".nav-left");
  const adminDropdownBtn = document.getElementById("adminDropdownBtn");
  const adminDropdownContent = document.getElementById("adminDropdownContent");
  const openAdminEditorBtn = document.getElementById("openAdminEditorBtn");
  const homeBtn = document.getElementById("homeBtn");

  // State
  let currentStore = null; // object {id, title, pin, layout, navButtons}
  let adminDropdownOpen = false;

  // LocalStorage keys helpers
  function localStorageKey(storeId) {
    return `popupshop_store_${storeId}`;
  }

  // Toggle admin dropdown menu
  adminDropdownBtn.addEventListener("click", () => {
    adminDropdownOpen = !adminDropdownOpen;
    adminDropdownContent.style.display = adminDropdownOpen ? "block" : "none";
  });

  // Click outside admin dropdown closes it
  window.addEventListener("click", (e) => {
    if (!adminDropdownBtn.contains(e.target) && !adminDropdownContent.contains(e.target)) {
      adminDropdownOpen = false;
      adminDropdownContent.style.display = "none";
    }
  });

  // Firestore helper: load store by PIN
  async function loadStoreByPin(pin) {
    // Search stores collection for matching PIN (simple approach)
    // In a real app, consider indexing PIN or using admin ID login
    try {
      const storesRef = db.collection ? db.collection("stores") : null;
      // Firestore modular SDK doesn't have 'collection' on db directly, we need to import collection()
      // So let's import collection and query here:
    } catch (e) {
      console.error("Firestore error loading by PIN:", e);
      return null;
    }
    // Because Firestore SDK v9 uses modular imports, let's adjust:

    // Firestore modular approach
  }

  // Due to complexity, let's write the Firestore PIN lookup properly:
  import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  async function loadStoreByPin(pin) {
    try {
      const storesCol = collection(db, "stores");
      const q = query(storesCol, where("pin", "==", pin));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) return null;
      const docSnap = querySnapshot.docs[0];
      return { id: docSnap.id, ...docSnap.data() };
    } catch (e) {
      console.error("Firestore error loading by PIN:", e);
      return null;
    }
  }

  // Save store to Firestore and localStorage fallback
  async function saveStore(store) {
    try {
      await setDoc(doc(db, "stores", store.id), store);
      localStorage.removeItem(localStorageKey(store.id)); // clear fallback on success
      return true;
    } catch (e) {
      console.warn("Firestore save failed, using localStorage fallback:", e);
      try {
        localStorage.setItem(localStorageKey(store.id), JSON.stringify(store));
        return true;
      } catch (err) {
        console.error("localStorage save also failed:", err);
        return false;
      }
    }
  }

  // Load store from Firestore or localStorage fallback
  async function loadStore(storeId) {
    try {
      const docSnap = await getDoc(doc(db, "stores", storeId));
      if (docSnap.exists()) {
        return docSnap.data();
      } else {
        // Try localStorage fallback
        const localData = localStorage.getItem(localStorageKey(storeId));
        if (localData) return JSON.parse(localData);
        return null;
      }
    } catch (e) {
      console.warn("Firestore load failed, trying localStorage fallback:", e);
      const localData = localStorage.getItem(localStorageKey(storeId));
      if (localData) return JSON.parse(localData);
      return null;
    }
  }

  // Create new store in Firestore with default layout/navButtons
  async function createNewStore(title, pin) {
    // Generate store ID from title slug + random string
    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
    const randomStr = Math.random().toString(36).substring(2, 7);
    const storeId = `${slug}-${randomStr}`;

    const newStore = {
      title,
      pin,
      layout: [], // empty layout for now
      navButtons: [], // no extra nav buttons initially
      createdAt: new Date().toISOString(),
    };

    try {
      await setDoc(doc(db, "stores", storeId), newStore);
      return { id: storeId, ...newStore };
    } catch (e) {
      console.error("Error creating store:", e);
      return null;
    }
  }

  // Render bottom nav buttons from store.navButtons
  function renderNavButtons() {
    // Remove all extra buttons except Home and Admin dropdown
    [...navLeft.querySelectorAll(".nav-btn.custom")].forEach((btn) => btn.remove());

    if (!currentStore || !currentStore.navButtons) return;
    currentStore.navButtons.forEach((btnData) => {
      const btn = document.createElement("button");
      btn.textContent = btnData.label;
      btn.classList.add("nav-btn", "custom");
      btn.addEventListener("click", () => {
        window.location.href = btnData.link || "#";
      });
      navLeft.appendChild(btn);
    });
  }

  // Show store editor UI
  function openStoreEditor(store) {
    currentStore = store;
    adminPopup.style.display = "none";
    storeEditor.style.display = "block";
    storeTitleDisplay.textContent = store.title || "(No Title)";
    renderNavButtons();
  }

  // View live store page (placeholder: reload page for now)
  viewStoreBtn.addEventListener("click", () => {
    alert("Live store preview is not implemented yet.");
  });

  // Logout: reload page to show admin popup again
  logoutBtn.addEventListener("click", () => {
    location.reload();
  });

  // Admin dropdown open editor button
  openAdminEditorBtn.addEventListener("click", () => {
    alert("Admin editor modal coming soon!");
  });

  // Handle Verify PIN
  verifyPinBtn.addEventListener("click", async () => {
    const pin = adminPinInput.value.trim();
    loginErrorMsg.textContent = "";
    if (!pin) {
      loginErrorMsg.textContent = "Please enter a PIN.";
      return;
    }
    const store = await loadStoreByPin(pin);
    if (!store) {
      loginErrorMsg.textContent = "Invalid PIN or store not found.";
      return;
    }
    openStoreEditor(store);
  });

  // Handle Create Store
  createStoreBtn.addEventListener("click", async () => {
    const title = newStoreTitleInput.value.trim();
    const pin = newAdminPinInput.value.trim();
    createErrorMsg.textContent = "";
    if (!title || !pin) {
      createErrorMsg.textContent = "Please enter both store title and PIN.";
      return;
    }
    const newStore = await createNewStore(title, pin);
    if (!newStore) {
      createErrorMsg.textContent = "Failed to create store. Try again.";
      return;
    }
    openStoreEditor(newStore);
  });

  // Hide admin popup and show store editor if user already logged in (optional)
  // Here we can add logic to check session/localStorage for existing store session

  // Initial setup
  // For demo purposes, admin popup shows on every load

</script>

</body>
</html>
