<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuralDrop | Driver Portal</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        [v-cloak] { display: none; }
        #map { height: 380px; width: 100%; z-index: 1; border-bottom: 4px solid #4f46e5; }
        .tab-active { color: #4f46e5; border-bottom: 4px solid #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 antialiased font-sans">

<div id="app" v-cloak>
    <div v-if="!isFirebaseConnected" class="bg-amber-500 text-white text-[10px] font-black py-1 text-center uppercase tracking-widest">
        Demo Mode: No Database Sync Active
    </div>

    <div v-if="!isAuthenticated" class="fixed inset-0 z-[100] bg-white flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-md">
            <div class="bg-slate-900 text-white w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 uppercase tracking-tighter">Driver PIN</h2>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-10">Enter 123456 to test</p>
            
            <input v-model="pinInput" type="password" maxlength="6" 
                   class="text-center text-4xl tracking-[0.4em] w-full border-b-4 border-slate-100 focus:border-indigo-600 outline-none pb-4 mb-10 font-black transition-all">
            
            <button @click="login" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black shadow-xl hover:bg-indigo-600 transition-all">
                Unlock Dashboard
            </button>
        </div>
    </div>

    <main v-else class="min-h-screen pb-24">
        <div id="map" class="shadow-inner"></div>

        <div class="bg-white flex border-b sticky top-0 z-40 shadow-sm">
            <button @click="activeTab = 'current'" :class="activeTab === 'current' ? 'tab-active' : 'text-slate-400'" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest transition-all">Current Run</button>
            <button @click="activeTab = 'settings'" :class="activeTab === 'settings' ? 'tab-active' : 'text-slate-400'" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest transition-all">Settings</button>
        </div>

        <div class="p-4 max-w-2xl mx-auto mt-4">
            <div v-if="activeTab === 'current'" class="space-y-4">
                <div v-for="(order, index) in orders" :key="order.id" class="p-6 bg-white rounded-3xl border border-slate-200 flex items-center gap-4 shadow-sm hover:border-indigo-200 transition-all">
                    <div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center font-black">
                        {{ index + 1 }}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-black text-slate-800">{{ order.customer || 'New Customer' }}</h4>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            ${{ order.total }}.00 • {{ order.pickups ? order.pickups.length : 1 }} Stops
                        </p>
                    </div>
                    <button @click="completeOrder(order.id)" class="bg-green-100 text-green-600 px-5 py-2.5 rounded-xl font-black text-[10px] uppercase hover:bg-green-200 transition-all">
                        Delivered
                    </button>
                </div>

                <div v-if="orders.length === 0" class="text-center py-20 opacity-20">
                    <i class="fas fa-route text-6xl mb-4"></i>
                    <p class="font-black uppercase text-xs">Waiting for new orders...</p>
                </div>
            </div>

            <div v-if="activeTab === 'settings'" class="text-center space-y-6">
                <div class="bg-white p-10 rounded-[3rem] border shadow-sm">
                    <i class="fas fa-user-circle text-5xl text-slate-200 mb-4"></i>
                    <h3 class="font-black text-slate-800 uppercase tracking-widest">Driver Account</h3>
                    <p class="text-xs text-slate-400 font-bold mb-8">Status: Active</p>
                    <button @click="logout" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-black text-xs uppercase tracking-widest">Sign Out</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
const { createApp } = Vue;

// PASTE YOUR FIREBASE CONFIG HERE LATER
const firebaseConfig = { 
    apiKey: "YOUR_KEY", 
    databaseURL: "YOUR_URL" 
};

createApp({
    data() {
        return {
            isAuthenticated: false,
            isFirebaseConnected: false,
            pinInput: '',
            activeTab: 'current',
            map: null,
            driverLoc: [41.25, -95.85], // Omaha default for demo
            orders: []
        }
    },
    methods: {
        login() {
            if(this.pinInput === '123456') {
                this.isAuthenticated = true;
                this.initMap();
                if(this.isFirebaseConnected) {
                    this.listenForLiveOrders();
                } else {
                    // Inject Demo Order so page isn't empty
                    this.orders = [{
                        id: 'demo-1',
                        customer: 'Test Delivery (Demo)',
                        total: 25,
                        pickups: [{location: 'Store A', lat: 41.26, lng: -95.86}],
                        dLat: 41.24, dLng: -95.84
                    }];
                    this.drawRoutes();
                }
            }
        },
        initMap() {
            // Wait for DOM to render after login
            setTimeout(() => {
                if (this.map) this.map.remove();
                this.map = L.map('map', { zoomControl: false }).setView(this.driverLoc, 13);
                
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri'
                }).addTo(this.map);
                
                this.drawRoutes();
            }, 300);
        },
        listenForLiveOrders() {
            const db = firebase.database();
            db.ref('orders').on('value', snap => {
                const val = snap.val();
                this.orders = val ? Object.values(val) : [];
                this.drawRoutes();
            });
        },
        drawRoutes() {
            if (!this.map) return;
            // Clear existing markers/lines
            this.map.eachLayer(l => { if (l instanceof L.Polyline || l instanceof L.Marker || l instanceof L.CircleMarker) this.map.removeLayer(l); });
            
            // Driver current position
            L.marker(this.driverLoc, {
                icon: L.divIcon({className: 'bg-indigo-600 w-4 h-4 rounded-full border-2 border-white shadow-lg'})
            }).addTo(this.map);

            let lastPoint = this.driverLoc;

            this.orders.forEach(order => {
                // Draw Pickups (Dotted Line)
                if(order.pickups) {
                    order.pickups.forEach(p => {
                        if(p.lat) {
                            L.polyline([lastPoint, [p.lat, p.lng]], {color: '#94a3b8', weight: 2, dashArray: '5, 10'}).addTo(this.map);
                            L.circleMarker([p.lat, p.lng], {radius: 4, color: '#334155'}).addTo(this.map);
                            lastPoint = [p.lat, p.lng];
                        }
                    });
                }
                // Draw Final Delivery (Solid Line)
                if(order.dLat) {
                    L.polyline([lastPoint, [order.dLat, order.dLng]], {color: '#4f46e5', weight: 5}).addTo(this.map);
                    L.circleMarker([order.dLat, order.dLng], {radius: 8, color: '#4f46e5', fillOpacity: 1}).addTo(this.map);
                    lastPoint = [order.dLat, order.dLng];
                }
            });
        },
        completeOrder(id) {
            if(this.isFirebaseConnected) {
                firebase.database().ref('orders/' + id).remove();
            } else {
                this.orders = this.orders.filter(o => o.id !== id);
                this.drawRoutes();
            }
        },
        logout() {
            this.isAuthenticated = false;
            this.pinInput = '';
        }
    },
    mounted() {
        // Safe-check Firebase connection
        try {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) throw "No Keys";
            firebase.initializeApp(firebaseConfig);
            this.isFirebaseConnected = true;
        } catch (e) {
            console.warn("Firebase not configured. Running in Local Demo Mode.");
        }
    }
}).mount('#app');
</script>
</body>
</html>
