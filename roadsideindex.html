<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Assistance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU"></script>

<style>
:root {
  --bg: #f7f8fa;
  --card: #ffffff;
  --text: #1f2933;
  --muted: #6b7280;
  --accent: #334155;
  --danger: #dc2626;
}

* { box-sizing: border-box; }

body { margin:0; background: var(--bg); font-family: system-ui, -apple-system, BlinkMacSystemFont; color: var(--text); }
#map { height:65vh; width:100%; position:relative; z-index:1; }

/* Dropdown Panel */
#panel {
  position: absolute; /* float above map */
  bottom: 64px;       /* above footer */
  left: 0;
  right: 0;
  background: white;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  box-shadow:0 -10px 30px rgba(0,0,0,0.08);
  z-index: 10;       /* above map */
  pointer-events: auto;
}

#panelHeader { padding:14px 18px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
#panelHeader h3 { margin:0; font-size:15px; }
#panelContent { max-height:0; overflow:hidden; transition:max-height 0.25s ease; padding:0 16px; }
#panelContent.open { max-height:260px; padding-bottom:12px; }

.card { background: var(--card); border-radius:16px; padding:14px; margin-bottom:12px; box-shadow:0 8px 20px rgba(0,0,0,0.05); }
.card h4 { margin:0 0 4px; font-size:15px; }
.meta { font-size:12px; color: var(--muted); }
.badge { display:inline-block; background:#eef2f7; padding:4px 8px; border-radius:999px; font-size:11px; margin:6px 0; }

button { border:none; padding:10px 14px; border-radius:12px; background:var(--accent); color:white; font-size:14px; cursor:pointer; }
button:active { transform:scale(0.97); }

/* Footer */
#footer { position:fixed; bottom:0; width:100%; height:64px; display:flex; justify-content:center; align-items:center; box-shadow:0 -10px 30px rgba(0,0,0,0.08); z-index:20; background:white; }
#sosBtn { background:var(--danger); padding:14px 36px; border-radius:999px; font-weight:600; }

/* Modal */
#modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; justify-content:center; align-items:center; z-index:50; }
#modalContent { background:white; width:90%; max-width:420px; border-radius:20px; padding:20px; }
input, textarea { width:100%; padding:10px; border-radius:12px; border:1px solid #e5e7eb; margin-bottom:10px; font-size:14px; }
.tip-options button { background:#e5e7eb; color:var(--text); margin-right:6px; }
.tip-options button.active { background:var(--accent); color:white; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div id="panelHeader" onclick="togglePanel()">
    <h3>Active Requests</h3>
    <span id="chevron">▴</span>
  </div>
  <div id="panelContent">
    <div id="requests"></div>
  </div>
</div>

<div id="footer">
  <button id="sosBtn" onclick="openSOS()">Request Assistance</button>
</div>

<div id="modal">
  <div id="modalContent">
    <h3>Request Assistance</h3>
    <p class="meta">Location shared securely</p>
    <input id="name" placeholder="Your name">
    <textarea id="issue" placeholder="Briefly describe the issue"></textarea>
    <div class="tip-options">
      <p class="meta">Optional tip for helper</p>
      <button onclick="selectTip(5, this)">$5</button>
      <button onclick="selectTip(10, this)">$10</button>
      <button onclick="selectTip(20, this)">$20</button>
    </div>
    <input id="customTip" placeholder="Custom tip amount ($)">
    <button onclick="submitSOS()">Submit Request</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app",
  messagingSenderId: "1068443635940",
  appId: "1:1068443635940:web:ae5e33d3fe0d78c415dcf1"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

let map, userLocation;
let sosCache = {}, sosMarkers = {};
let selectedTip = 0;

function initMap() {
  navigator.geolocation.getCurrentPosition(pos => {
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map = new google.maps.Map(document.getElementById("map"), { center: userLocation, zoom:13, styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]});
    new google.maps.Marker({ position: userLocation, map, icon:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png" });

    onValue(ref(database, "sosRequests"), snap => {
      sosCache = {};
      snap.forEach(c => sosCache[c.key] = c.val());
      renderSOS();
    });

    map.addListener("idle", renderSOS);
  });
}

function renderSOS() {
  const container = document.getElementById("requests");
  container.innerHTML = "";
  const bounds = map.getBounds();
  let found = false;

  Object.keys(sosMarkers).forEach(id => {
    if(!sosCache[id] || sosCache[id].status!=="open") { sosMarkers[id].setMap(null); delete sosMarkers[id]; }
  });

  Object.entries(sosCache).forEach(([id,d])=>{
    if(d.status!=="open") return;
    const pos = new google.maps.LatLng(d.lat,d.lng);
    if(!sosMarkers[id]){
      sosMarkers[id]=new google.maps.Marker({position:pos,map,icon:"https://maps.google.com/mapfiles/ms/icons/red-dot.png",title:d.issue});
    }
    const visible = bounds.contains(pos);
    sosMarkers[id].setVisible(visible);
    if(!visible) return;

    found = true;
    container.innerHTML += `<div class="card"><h4>${d.userName}</h4><p>${d.issue}</p><span class="badge">Tip: $${d.tip||0}</span><button>Respond</button></div>`;
  });

  if(!found) container.innerHTML=`<p class="meta">No assistance needed in this area</p>`;
}

function togglePanel() {
  const content=document.getElementById("panelContent");
  const chevron=document.getElementById("chevron");
  content.classList.toggle("open");
  chevron.textContent = content.classList.contains("open")?"▾":"▴";
}

function openSOS(){ document.getElementById("modal").style.display="flex"; }
function selectTip(amount,el){ selectedTip=amount; document.querySelectorAll(".tip-options button").forEach(b=>b.classList.remove("active")); el.classList.add("active"); }

function submitSOS(){
  const name=document.getElementById("name").value.trim();
  const issue=document.getElementById("issue").value.trim();
  const customTip=parseFloat(document.getElementById("customTip").value);
  if(!name||!issue) return;

  push(ref(database,"sosRequests"),{
    userName:name,
    issue,
    lat:userLocation.lat,
    lng:userLocation.lng,
    tip:customTip||selectedTip||0,
    status:"open",
    timestamp:Date.now()
  });

  document.getElementById("modal").style.display="none";
  document.getElementById("name").value="";
  document.getElementById("issue").value="";
  document.getElementById("customTip").value="";
  selectedTip=0;
}

initMap();
</script>

</body>
</html>
