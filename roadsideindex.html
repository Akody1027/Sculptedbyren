<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Hero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Google Maps with Geometry -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU&libraries=geometry"></script>

<style>
:root {
  --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
  --accent: #2563eb; --danger: #ef4444; --success: #22c55e;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    font-family: -apple-system, system-ui, sans-serif;
    color: var(--text); background: white; overflow: hidden;
}

/* --- VIEW MANAGER --- */
.view { display: none; width: 100%; height: 100%; position: fixed; inset: 0; z-index: 10; background: white; }
.view-active { display: flex; flex-direction: column; }

/* --- LANDING PAGE --- */
#landingPage { align-items: center; justify-content: center; padding: 30px; text-align: center; z-index: 100; }
#landingPage img { width: 220px; margin-bottom: 10px; }
#landingPage h2 { font-size: 18px; font-weight: 500; color: var(--muted); margin: 0 0 50px 0; }
.mode-btn { 
    width: 100%; max-width: 320px; padding: 20px; border-radius: 18px; 
    font-size: 18px; font-weight: 700; border: none; cursor: pointer; margin-bottom: 16px;
    transition: transform 0.2s ease;
}
.btn-req { background: var(--danger); color: white; box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3); }
.btn-hero { background: var(--text); color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

/* --- SEEKER WAIT SCREEN --- */
#seekerUI { background: var(--bg); padding: 40px 20px; align-items: center; justify-content: flex-start; text-align: center; overflow-y: auto; }
.search-pulse {
    width: 100px; height: 100px; background: var(--accent); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 40px;
    color: white; margin: 30px auto; position: relative; z-index: 2;
}
.search-pulse::after {
    content: ''; position: absolute; inset: 0; border-radius: 50%;
    background: var(--accent); opacity: 0.4; animation: pulse 2s infinite;
}
@keyframes pulse { 0% { transform: scale(1); opacity: 0.4; } 100% { transform: scale(2); opacity: 0; } }

/* --- HERO UI (MAP) --- */
#heroUI { position: relative; background: #e5e7eb; }
#map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }

#panel { position: fixed; bottom: 90px; left: 15px; right: 15px; background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; overflow: hidden; transition: 0.3s; }
#panelHeader { padding: 18px 24px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
#panelContent { max-height: 0; overflow-y: auto; transition: 0.3s; padding: 0 16px; }
#panelContent.open { max-height: 40vh; padding-bottom: 20px; }

.card { background: #f8fafc; border-radius: 16px; padding: 15px; margin-bottom: 12px; border: 1px solid #e2e8f0; text-align: left; }
.btn-respond { width: 100%; border: none; padding: 12px; border-radius: 10px; background: var(--accent); color: white; font-weight: 700; cursor: pointer; margin-top: 10px; }

/* FOOTER */
#heroFooter { position: fixed; bottom: 0; width: 100%; height: 80px; display: flex; justify-content: space-between; align-items: center; z-index: 100; background: white; padding: 0 25px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
.icon-wrapper { position: relative; cursor: pointer; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 50%; font-size: 20px; }
#notifBadge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 10px; font-weight: bold; width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid white; }

/* MODALS */
.modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); display: none; justify-content: center; align-items: flex-end; z-index: 10000; }
.modal-content { background: white; width: 100%; max-width: 500px; border-radius: 32px 32px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; }

.vehicle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
.v-type { padding: 12px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; font-weight: 600; }
.v-type.active { border-color: var(--accent); background: #eff6ff; color: var(--accent); }

input, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 12px; font-size: 15px; }
.submit-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; }
.cancel-link { display: block; text-align: center; padding: 15px; color: var(--muted); cursor: pointer; }
</style>
</head>
<body>

<!-- 1. LANDING PAGE -->
<div id="landingPage" class="view view-active">
    <img src="Roadsidehero.png" alt="Roadside Hero Logo">
    <h2>Reliable help when you need it most.</h2>
    <button class="mode-btn btn-req" onclick="window.openModal('requestModal')">Request Help!</button>
    <button class="mode-btn btn-hero" onclick="window.enterHeroMode()">I am looking to be a Hero</button>
</div>

<!-- 2. SEEKER DASHBOARD -->
<div id="seekerUI" class="view">
    <div style="width:100%; text-align:left;"><button onclick="location.reload()" style="border:none; background:none; font-weight:700; padding:10px;">‚úï Cancel</button></div>
    <div class="search-pulse">üì°</div>
    <h1 id="seekerStatusTitle">Finding a Hero...</h1>
    <div id="helperCountBox" style="background:white; padding:20px; border-radius:20px; border:1px solid #eee;">
        <span id="helperCounter">Checking for nearby heroes...</span>
    </div>
    <div id="assignedHeroBox" style="display:none; margin-top:30px; width:100%; background:white; padding:20px; border-radius:20px; border:2px solid var(--success); text-align:left;">
        <div style="display:flex; align-items:center; gap:15px;">
            <img id="assignedHeroPic" src="" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
            <div>
                <h4 id="assignedHeroName" style="margin:0;">Hero Name</h4>
                <p style="margin:2px 0; color:var(--success); font-weight:700;">ON THE WAY</p>
            </div>
        </div>
    </div>
</div>

<!-- 3. HERO UI (MAP & TOOLS) -->
<div id="heroUI" class="view">
    <div id="map"></div>

    <!-- Active Requests Slider -->
    <div id="panel">
      <div id="panelHeader" onclick="window.togglePanel()">
        <h3 style="margin:0; font-size:16px;">Nearby Requests</h3>
        <span id="chevron">‚ñ≤</span>
      </div>
      <div id="panelContent"><div id="requests"></div></div>
    </div>

    <!-- Hero Footer -->
    <div id="heroFooter">
      <button style="border:none; background:none; font-weight:800; color:var(--muted); font-size:14px;" onclick="location.reload()">üè† HOME</button>
      <div class="footer-icons" style="display:flex; gap:15px;">
          <div class="icon-wrapper" onclick="window.openModal('notifModal')">üîî<span id="notifBadge">0</span></div>
          <div class="icon-wrapper" onclick="window.openProfile()">üë§</div>
      </div>
    </div>
</div>

<!-- MODALS -->
<div id="requestModal" class="modal">
  <div class="modal-content">
    <h3>Help Request Form</h3>
    <div class="vehicle-grid">
        <div class="v-type active" onclick="window.selectVehicle('Car', this)">üöó Car</div>
        <div class="v-type" onclick="window.selectVehicle('Truck', this)">üõª Truck</div>
        <div class="v-type" onclick="window.selectVehicle('RV', this)">üöê RV</div>
        <div class="v-type" onclick="window.selectVehicle('HeavyDuty', this)">üöõ Heavy</div>
    </div>
    <input id="reqName" placeholder="Your Name">
    <textarea id="reqIssue" placeholder="What's the problem?" rows="2"></textarea>
    <input id="reqTip" type="number" placeholder="Optional Tip ($)">
    <button class="submit-btn" onclick="window.submitSOS()">Submit SOS</button>
    <span class="cancel-link" onclick="window.closeModal('requestModal')">Cancel</span>
  </div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <h3>Hero Settings</h3>
        <input id="profileName" placeholder="Hero Name">
        <textarea id="profileBio" placeholder="Tools/Bio..." rows="2"></textarea>
        <button class="submit-btn" onclick="window.saveProfile()">Save Settings</button>
        <span class="cancel-link" onclick="window.closeModal('profileModal')">Close</span>
    </div>
</div>

<div id="notifModal" class="modal" onclick="if(event.target==this) window.closeModal('notifModal')">
    <div class="modal-content"><h3>History</h3><div id="notifList"></div></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, update, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

if(!localStorage.getItem('heroUserId')) localStorage.setItem('heroUserId', 'u_' + Math.random().toString(36).substr(2, 9));
const myId = localStorage.getItem('heroUserId');

let map, userLocation, selectedVehicle = "Car";
let sosCache = {}, profilesCache = {}, sosMarkers = {};

// --- VIEW CONTROLLER ---
window.switchView = (viewId) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
    document.getElementById(viewId).classList.add('view-active');
};

window.enterHeroMode = () => {
    window.switchView('heroUI');
    // Important: Delay map init slightly to let the CSS display take effect
    setTimeout(() => { if (!map) initMap(); }, 100);
};

// --- UI EXPORTS ---
window.openModal = (id) => document.getElementById(id).style.display = "flex";
window.closeModal = (id) => document.getElementById(id).style.display = "none";
window.togglePanel = () => {
    const c = document.getElementById("panelContent");
    c.classList.toggle("open");
    document.getElementById("chevron").textContent = c.classList.contains("open") ? "‚ñº" : "‚ñ≤";
};
window.selectVehicle = (type, el) => {
    selectedVehicle = type;
    document.querySelectorAll(".v-type").forEach(b => b.classList.remove("active"));
    el.classList.add("active");
};

// --- LOGIC ---
window.submitSOS = () => {
  const name = document.getElementById("reqName").value.trim();
  const issue = document.getElementById("reqIssue").value.trim();
  if(!name || !issue || !userLocation) return alert("Please allow GPS and fill form");
  
  push(ref(database, "sosRequests"), {
    userName: name, issue, vehicle: selectedVehicle,
    lat: userLocation.lat, lng: userLocation.lng,
    status: "open", timestamp: Date.now(), ownerId: myId
  });
  
  window.closeModal("requestModal");
  window.switchView('seekerUI');
};

window.confirmHelp = (id) => {
    update(ref(database, `sosRequests/${id}`), { status: "accepted", helperId: myId });
    alert("Response sent! Navigating to user.");
};

function initMap() {
    const mapEl = document.getElementById("map");
    map = new google.maps.Map(mapEl, {
        center: userLocation || { lat: 40.7, lng: -74 },
        zoom: 14,
        disableDefaultUI: true,
        styles: [{ featureType: "poi", stylers: [{ visibility: "off" }] }]
    });

    if(userLocation) {
        new google.maps.Marker({ position: userLocation, map, icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" });
        map.setCenter(userLocation);
    }

    onValue(ref(database, "sosRequests"), (snap) => {
        sosCache = snap.val() || {};
        renderSOS();
        updateSeekerUI();
    });

    onValue(ref(database, "profiles"), (snap) => {
        profilesCache = snap.val() || {};
        updateSeekerUI();
    });
}

function renderSOS() {
    const container = document.getElementById("requests");
    const badge = document.getElementById("notifBadge");
    container.innerHTML = "";
    let openCount = 0;

    Object.entries(sosCache).forEach(([id, d]) => {
        if(d.status !== "open") {
            if(sosMarkers[id]) { sosMarkers[id].setMap(null); delete sosMarkers[id]; }
            return;
        }
        openCount++;
        if(!sosMarkers[id] && map) {
            sosMarkers[id] = new google.maps.Marker({ position: {lat: d.lat, lng: d.lng}, map, icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" });
        }
        container.innerHTML += `<div class="card">
            <b>${d.userName}</b> [${d.vehicle}]
            <p style="font-size:13px; margin:5px 0;">${d.issue}</p>
            <button class="btn-respond" onclick="window.confirmHelp('${id}')">I CAN HELP</button>
        </div>`;
    });

    badge.innerText = openCount;
    badge.style.display = openCount > 0 ? "flex" : "none";
}

function updateSeekerUI() {
    const myReq = Object.values(sosCache).find(r => r.ownerId === myId && r.status !== 'completed');
    if (!myReq) return;

    // Helper count logic
    let nearby = 0;
    Object.values(profilesCache).forEach(p => {
        if (p.lat && p.id !== myId) nearby++;
    });
    document.getElementById('helperCounter').innerHTML = `<b>${nearby}</b> Heroes active nearby.`;

    if (myReq.status === 'accepted') {
        const hero = profilesCache[myReq.helperId] || {};
        document.getElementById('seekerStatusTitle').innerText = "Hero is Coming!";
        document.getElementById('assignedHeroBox').style.display = 'block';
        document.getElementById('assignedHeroName').innerText = hero.name || "A Hero";
        document.getElementById('assignedHeroPic').src = hero.pic || "https://via.placeholder.com/60";
    }
}

// Background GPS
navigator.geolocation.watchPosition(p => {
    userLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
    update(ref(database, `profiles/${myId}`), { lat: p.coords.latitude, lng: p.coords.longitude, id: myId });
}, null, { enableHighAccuracy: true });

</script>
</body>
</html>
