<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Hero - Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU"></script>

<style>
:root {
  --bg: #f1f5f9;
  --primary: #2563eb;
  --danger: #ef4444;
  --text: #1e293b;
  --white: #ffffff;
}

body { margin:0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); overflow: hidden; }
#map { height: 100vh; width: 100%; position: absolute; z-index: 1; }

/* Fixed Footer Bar */
#footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 75px;
  background: var(--white);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
  z-index: 100;
  box-sizing: border-box;
}

/* Footer - Left side SOS Button */
.footer-left { flex: 1; display: flex; justify-content: flex-start; }
#sosBtn {
  background: var(--danger);
  color: white;
  border: none;
  padding: 12px 28px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 15px;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  cursor: pointer;
  transition: transform 0.2s;
}
#sosBtn:active { transform: scale(0.95); }

/* Footer - Right side Notifications */
.footer-right { position: relative; display: flex; align-items: center; padding-right: 10px; }
.notif-icon {
  font-size: 28px;
  cursor: pointer;
  position: relative;
  background: #f8fafc;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  border: 1px solid #e2e8f0;
}
.badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: var(--danger);
  color: white;
  font-size: 10px;
  font-weight: bold;
  min-width: 18px;
  height: 18px;
  border-radius: 50%;
  display: none; /* hidden by default */
  align-items: center;
  justify-content: center;
  border: 2px solid white;
}

/* Notification Modal */
#notifModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 200;
  justify-content: center;
  align-items: flex-end;
}
#notifContent {
  background: white;
  width: 100%;
  max-width: 500px;
  border-radius: 24px 24px 0 0;
  padding: 24px;
  max-height: 70vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease-out;
}
.notif-item {
  padding: 12px;
  border-bottom: 1px solid #f1f5f9;
  font-size: 14px;
}
.notif-item.new { background: #eff6ff; border-left: 4px solid var(--primary); }

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* Original Request Modal Styles */
#requestModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 200; align-items: center; justify-content: center; }
.modal-box { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; }
input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
.submit-btn { width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; }
</style>
</head>
<body>

<div id="map"></div>

<!-- FOOTER -->
<div id="footer">
  <div class="footer-left">
    <button id="sosBtn" onclick="toggleModal('requestModal', true)">REQUEST SOS</button>
  </div>
  <div class="footer-right">
    <div class="notif-icon" onclick="openNotifications()">
      ðŸ””
      <span id="notifBadge" class="badge">0</span>
    </div>
  </div>
</div>

<!-- REQUEST MODAL -->
<div id="requestModal" onclick="if(event.target==this) toggleModal('requestModal', false)">
  <div class="modal-box">
    <h3>New Assistance Request</h3>
    <input id="userName" placeholder="Your Name">
    <textarea id="userIssue" placeholder="Describe the problem..."></textarea>
    <button class="submit-btn" onclick="submitRequest()">Post Request</button>
  </div>
</div>

<!-- NOTIFICATION MODAL -->
<div id="notifModal" onclick="if(event.target==this) toggleModal('notifModal', false)">
  <div id="notifContent">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0">Notifications</h2>
        <button onclick="toggleModal('notifModal', false)" style="border:none; background:none; font-size:20px;">âœ•</button>
    </div>
    <div id="notifList">
      <p style="color:#64748b; text-align:center;">No new notifications</p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userLocation = null;
let lastKnownCount = 0;

// Global UI Toggles
window.toggleModal = (id, show) => {
    document.getElementById(id).style.display = show ? 'flex' : 'none';
};

// Map Init
function initMap() {
    navigator.geolocation.getCurrentPosition(pos => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const map = new google.maps.Map(document.getElementById("map"), {
            center: userLocation, zoom: 14, disableDefaultUI: true
        });
        new google.maps.Marker({ position: userLocation, map, icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" });
    });
}

// Submit SOS
window.submitRequest = () => {
    const name = document.getElementById('userName').value;
    const issue = document.getElementById('userIssue').value;
    if(!name || !issue) return alert("Fill all fields");

    push(ref(db, 'sosRequests'), {
        userName: name,
        issue: issue,
        lat: userLocation.lat,
        lng: userLocation.lng,
        status: 'open',
        timestamp: Date.now()
    });
    toggleModal('requestModal', false);
};

// REAL-TIME NOTIFICATION LISTENER
onValue(ref(db, 'sosRequests'), (snapshot) => {
    const data = snapshot.val();
    const list = document.getElementById('notifList');
    const badge = document.getElementById('notifBadge');
    
    if (!data) return;

    const items = Object.values(data).filter(item => item.status === 'open');
    const count = items.length;

    // Update Badge
    if (count > 0) {
        badge.innerText = count;
        badge.style.display = 'flex';
        // Simple "pop" animation logic
        if(count > lastKnownCount) {
            badge.style.transform = "scale(1.4)";
            setTimeout(() => badge.style.transform = "scale(1)", 200);
        }
    } else {
        badge.style.display = 'none';
    }

    // Build Notification List
    list.innerHTML = "";
    items.sort((a,b) => b.timestamp - a.timestamp).forEach(item => {
        const div = document.createElement('div');
        div.className = "notif-item new";
        div.innerHTML = `<strong>New Request: ${item.userName}</strong><br>${item.issue}`;
        list.appendChild(div);
    });

    lastKnownCount = count;
});

window.openNotifications = () => {
    toggleModal('notifModal', true);
    // Optional: Clear badge when clicked
    // document.getElementById('notifBadge').style.display = 'none';
};

initMap();
</script>

</body>
</html>
