<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Hero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Google Maps with Geometry -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU&libraries=geometry"></script>

<style>
:root {
  --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
  --accent: #2563eb; --danger: #EE611C; --success: #22c55e; --warning: #f59e0b;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, system-ui, sans-serif; color: var(--text); background: white; overflow: hidden; }

/* --- VIEW MANAGER --- */
.view { display: none; width: 100vw; height: 100vh; position: fixed; inset: 0; z-index: 10; background: white; overflow-y: auto; }
.view-active { display: flex; flex-direction: column; }

/* --- LANDING PAGE --- */
#landingPage { align-items: center; justify-content: center; padding: 30px; text-align: center; z-index: 100; }
#landingPage img { width: 240px; margin-bottom: 10px; }
.mode-btn { width: 100%; max-width: 320px; padding: 20px; border-radius: 18px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; margin-bottom: 16px; transition: 0.2s; }
.btn-req { background: var(--danger); color: white; }
.btn-hero { background: var(--text); color: white; }

/* --- HERO DRAWER (NEW) --- */
#heroDrawer {
    position: fixed; left: -320px; top: 15%; width: 300px; height: 70%;
    background: white; z-index: 500; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 5px 0 25px rgba(0,0,0,0.15); border-radius: 0 24px 24px 0;
    display: flex; flex-direction: column; padding: 20px;
}
#heroDrawer.open { left: 0; }
#drawerToggle {
    position: absolute; right: -50px; top: 20px; width: 50px; height: 50px;
    background: var(--danger); border-radius: 0 12px 12px 0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 5px 0 10px rgba(0,0,0,0.1); transition: 0.3s;
}
#drawerToggle.active-job { background: var(--success) !important; box-shadow: 0 0 15px var(--success); }

/* --- SEEKER DASHBOARD --- */
#seekerUI { background: var(--bg); padding: 20px; align-items: center; }
.status-card { background: white; width: 100%; max-width: 450px; padding: 20px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e2e8f0; }
#seekerMap { width: 100%; height: 200px; border-radius: 15px; margin: 15px 0; background: #eee; }

/* --- MODALS --- */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
.modal-content { background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 25px; max-height: 95vh; overflow-y: auto; }

/* --- CHAT --- */
#chatBox { height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #f1f5f9; border-radius: 12px; margin-bottom: 10px; }
.msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 13px; }
.msg-me { align-self: flex-end; background: var(--accent); color: white; }
.msg-them { align-self: flex-start; background: #e2e8f0; color: var(--text); }

/* --- FOOTER --- */
.footer { position: fixed; bottom: 0; width: 100%; height: 60px; background: #ee611cb8; display: flex; justify-content:center; align-items: center;  z-index: 200; }
.footer-icons { display:flex; gap:60px; align-items: center; }
.icon-btn { cursor: pointer; width: 35px; height: 35px; }

/* SHARED */
.submit-btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; font-size: 15px; }
input, textarea, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 10px; }
</style>
</head>
<body>

<!-- 1. LANDING PAGE -->
<div id="landingPage" class="view view-active">
    <img src="Roadsidelogo.png" onerror="this.src='https://via.placeholder.com/240x80?text=Roadside+Hero'">
    <h2 style="color: var(--muted); margin-bottom: 40px;">Help is just a click away.</h2>
    <button class="mode-btn btn-req" onclick="window.openModal('requestModal')" style="padding:20px; width:300px; border-radius:15px; border:none; color:white; font-weight:700; margin-bottom:15px; cursor:pointer;">Request Help!</button>
    <button class="mode-btn btn-hero" onclick="window.enterHeroMode()" style="padding:20px; width:300px; border-radius:15px; border:none; color:white; font-weight:700; cursor:pointer;">Become a Hero!</button>
</div>

<!-- 2. SEEKER DASHBOARD -->
<div id="seekerUI" class="view">
    <button onclick="window.openModal('cancelConfirmModal')" style="background:none; border:none; color:var(--danger); padding:20px; font-weight:bold;">‚úï CANCEL SOS</button>
    <div id="searchingState" class="status-card" style="margin: 0 auto;">
        <h3>Broadcasting SOS...</h3>
        <p>Finding Heroes nearby...</p>
    </div>
    <div id="matchedState" class="status-card" style="display:none; margin: 0 auto;">
        <div style="background: var(--success); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-bottom:10px;">HERO ON THE WAY</div>
        <div style="display: flex; align-items: center; gap: 10px; text-align: left;">
            <img id="matchPic" src="" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
            <div style="flex:1">
                <h4 id="matchName" style="margin:0;">Hero</h4>
                <p id="matchETA" style="margin:0; font-size:12px; color:var(--success);">...</p>
            </div>
            <button onclick="window.openChat()" style="background:var(--accent); color:white; border:none; padding:8px; border-radius:8px;">CHAT</button>
        </div>
        <div id="seekerMap"></div>
    </div>
</div>

<!-- 3. HERO UI -->
<div id="heroUI" class="view">
    <div id="map"></div>
    
    <!-- COLLAPSIBLE DRAWER -->
    <div id="heroDrawer">
        <div id="drawerToggle" onclick="document.getElementById('heroDrawer').classList.toggle('open')">
            <span style="color:white; font-weight:bold;">üõ†Ô∏è</span>
        </div>
        
        <div id="drawerContent">
            <h3 style="margin-top:0;">Ongoing Job</h3>
            <div id="noJobMsg" style="color:var(--muted); text-align:center; padding:20px;">No active job. Click a red pin on the map to start.</div>
            
            <div id="jobDetails" style="display:none;">
                <p id="taskUser" style="font-weight:bold;"></p>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <a id="navBtn" href="#" target="_blank" style="flex:1; background:var(--success); color:white; text-align:center; padding:10px; border-radius:10px; text-decoration:none; font-size:12px; font-weight:bold;">NAVIGATE</a>
                    <button onclick="window.completeTask()" style="flex:1; background:white; border:1px solid #ddd; border-radius:10px; font-size:12px;">FINISH</button>
                </div>
                <hr>
                <button onclick="window.openChat()" class="submit-btn" style="padding:10px; font-size:13px; margin-bottom:10px;">OPEN CHAT</button>
            </div>

            <div id="taskCanceledView" style="display:none; text-align:center;">
                <b style="color:var(--danger)">CANCELED</b>
                <p id="cancelReasonDisplay" style="font-size:12px;"></p>
                <button onclick="window.acknowledgeCancel()" class="submit-btn" style="background:var(--text); padding:10px;">ACKNOWLEDGE</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-icons">
            <div style="position:relative"><img src="notificationicon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3119/3119338.png'" class="icon-btn" onclick="window.openModal('notifModal')"><span id="notifBadge">0</span></div>
            <img src="thishomeicon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1946/1946436.png'" class="icon-btn" onclick="location.reload()">
            <img src="usericon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1077/1077063.png'" class="icon-btn" onclick="window.openProfile()">
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <h3 id="detVehicle">Request</h3>
        <img id="detImg" style="width:100%; height:150px; object-fit:cover; border-radius:12px; margin-bottom:10px; display:none;">
        <p id="detIssue" style="font-weight:bold;"></p>
        <p id="detDist" style="color:var(--accent); font-size:13px; margin-bottom:15px;"></p>
        <label style="font-size:11px; font-weight:bold;">ARRIVAL TIME</label>
        <select id="detETA"><option value="5-10 mins">5-10 mins</option><option value="15-20 mins">15-20 mins</option><option value="30+ mins">30+ mins</option></select>
        <button id="detAcceptBtn" class="submit-btn">ACCEPT JOB</button>
        <span class="cancel-link" onclick="window.closeModal('detailsModal')">Cancel</span>
    </div>
</div>

<div id="chatModal" class="modal">
    <div class="modal-content" style="height:80vh">
        <h3>Chat</h3>
        <div id="chatBox"></div>
        <div style="display:flex; gap:5px;">
            <input id="chatInput" placeholder="Message..." style="margin:0;">
            <button onclick="window.sendTextMsg()" style="background:var(--accent); color:white; border:none; padding:10px; border-radius:10px;">SEND</button>
        </div>
        <span class="cancel-link" onclick="window.closeModal('chatModal')">Close</span>
    </div>
</div>

<!-- REST OF MODALS (REQUEST/PROFILE/ETC) -->
<div id="requestModal" class="modal">
    <div class="modal-content">
        <h3>Request SOS</h3>
        <textarea id="reqIssue" placeholder="What happened?" rows="3"></textarea>
        <button class="submit-btn" onclick="window.submitSOS()">SUBMIT SOS</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, update, runTransaction } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const myId = localStorage.getItem('heroUserId') || 'u_' + Math.random().toString(36).substr(2, 9);
localStorage.setItem('heroUserId', myId);

let map, seekerMiniMap, userLocation;
let sosCache = {}, profilesCache = {}, markers = {};

const alertIcon = {
    path: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z",
    fillColor: "#EE611C", fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1.5, anchor: new google.maps.Point(12, 12)
};

// --- WINDOW FUNCTIONS ---
window.openModal = (id) => document.getElementById(id).style.display = "flex";
window.closeModal = (id) => document.getElementById(id).style.display = "none";
window.switchView = (id) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
    document.getElementById(id).classList.add('view-active');
};

// --- HERO: SAFETY CHECK (TRANSACTION) ---
window.confirmHelp = async (sosId) => {
    const eta = document.getElementById('detETA').value;
    const sosRef = ref(db, `sosRequests/${sosId}`);

    try {
        const result = await runTransaction(sosRef, (currentData) => {
            if (currentData === null) return currentData;
            if (currentData.status !== 'open') {
                return; // Abort: Someone else took it
            }
            // Update to accepted
            currentData.status = 'accepted';
            currentData.helperId = myId;
            currentData.eta = eta;
            currentData.helperAcknowledged = false;
            return currentData;
        });

        if (result.committed) {
            window.closeModal('detailsModal');
            document.getElementById('heroDrawer').classList.add('open');
        } else {
            alert("Sorry! This request was just accepted by another Hero.");
            window.closeModal('detailsModal');
        }
    } catch (e) {
        console.error(e);
        alert("Transaction failed. Please try again.");
    }
};

// --- HERO LOGIC ---
window.enterHeroMode = () => { window.switchView('heroUI'); setTimeout(() => { if(!map) initMap(); }, 200); };
window.completeTask = () => {
    const active = Object.entries(sosCache).find(([id, r]) => r.helperId === myId && r.status === 'accepted');
    if(active) update(ref(db, `sosRequests/${active[0]}`), { status: 'completed' });
};
window.acknowledgeCancel = () => {
    const canceled = Object.entries(sosCache).find(([id, r]) => r.helperId === myId && r.status === 'canceled');
    if(canceled) update(ref(db, `sosRequests/${canceled[0]}`), { helperAcknowledged: true });
};

// --- SEEKER LOGIC ---
window.submitSOS = () => {
    const issue = document.getElementById('reqIssue').value;
    if(!issue || !userLocation) return alert("Allow GPS.");
    push(ref(db, "sosRequests"), {
        ownerId: myId, userName: "User", issue, status: 'open',
        lat: userLocation.lat, lng: userLocation.lng, timestamp: Date.now()
    });
    window.closeModal('requestModal'); window.switchView('seekerUI');
};

// --- SYNC ENGINE ---
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), { 
        center: userLocation || {lat: 39, lng: -98}, zoom: 14, disableDefaultUI: true 
    });
}

function syncUI() {
    let openCount = 0; let activeJob = null; let mySOS = null;
    const drawerToggle = document.getElementById('drawerToggle');
    
    Object.entries(sosCache).forEach(([id, r]) => {
        const isMyJob = (r.helperId === myId && r.status === 'accepted');
        if((r.status === 'open' && r.ownerId !== myId) || isMyJob) {
            if(r.status === 'open') openCount++;
            if(!markers[id] && map) {
                const marker = new google.maps.Marker({ position: {lat: r.lat, lng: r.lng}, map, icon: alertIcon });
                marker.addListener('click', () => {
                    const r = sosCache[id];
                    document.getElementById('detVehicle').innerText = "Assistance Requested";
                    document.getElementById('detIssue').innerText = r.issue;
                    document.getElementById('detAcceptBtn').onclick = () => window.confirmHelp(id);
                    window.openModal('detailsModal');
                });
                markers[id] = marker;
            }
        } else if(markers[id]) { markers[id].setMap(null); delete markers[id]; }
        
        if(r.helperId === myId && (r.status === 'accepted' || (r.status === 'canceled' && !r.helperAcknowledged))) activeJob = r;
        if(r.ownerId === myId && (r.status === 'open' || r.status === 'accepted')) mySOS = r;
    });

    // Update Drawer Icon & Content
    if(activeJob) {
        drawerToggle.classList.add('active-job');
        document.getElementById('noJobMsg').style.display = 'none';
        if(activeJob.status === 'canceled') {
            document.getElementById('jobDetails').style.display = 'none';
            document.getElementById('taskCanceledView').style.display = 'block';
            document.getElementById('cancelReasonDisplay').innerText = activeJob.cancelReason || "";
        } else {
            document.getElementById('jobDetails').style.display = 'block';
            document.getElementById('taskCanceledView').style.display = 'none';
            document.getElementById('taskUser').innerText = activeJob.issue;
            document.getElementById('navBtn').href = `https://www.google.com/maps/dir/?api=1&destination=${activeJob.lat},${activeJob.lng}`;
        }
    } else {
        drawerToggle.classList.remove('active-job');
        document.getElementById('noJobMsg').style.display = 'block';
        document.getElementById('jobDetails').style.display = 'none';
        document.getElementById('taskCanceledView').style.display = 'none';
    }

    if(mySOS && mySOS.status === 'accepted') {
        window.switchView('seekerUI');
        document.getElementById('searchingState').style.display = 'none';
        document.getElementById('matchedState').style.display = 'block';
        const h = profilesCache[mySOS.helperId] || {};
        document.getElementById('matchName').innerText = h.name || "Hero";
        document.getElementById('matchETA').innerText = `ETA: ${mySOS.eta}`;
        updateSeekerMap(mySOS, h);
    }

    document.getElementById('notifBadge').innerText = openCount;
    document.getElementById('notifBadge').style.display = openCount > 0 ? "flex" : "none";
}

function updateSeekerMap(s, h) {
    if(!seekerMiniMap) seekerMiniMap = new google.maps.Map(document.getElementById('seekerMap'), {zoom:14, disableDefaultUI:true});
    // ... logic for live hero tracking markers ...
}

onValue(ref(db, "sosRequests"), (s) => { sosCache = s.val() || {}; syncUI(); });
onValue(ref(db, "profiles"), (s) => { profilesCache = s.val() || {}; syncUI(); });

navigator.geolocation.watchPosition(p => {
    userLocation = { lat: p.coords.latitude, lng: p.coords.longitude };
    update(ref(db, `profiles/${myId}`), { lat: userLocation.lat, lng: userLocation.lng });
}, null, { enableHighAccuracy: true });

</script>
</body>
</html>
