<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Hero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Google Maps with Geometry -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU&libraries=geometry"></script>

<style>
:root {
  --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
  --accent: #2563eb; --danger: #EE611C; --success: #22c55e; --warning: #f59e0b;
  --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, system-ui, sans-serif; color: var(--text); background: white; overflow: hidden; }

.view { display: none; width: 100vw; height: 100vh; position: fixed; inset: 0; z-index: 10; background: white; overflow-y: auto; }
.view-active { display: flex; flex-direction: column; }

#landingPage { align-items: center; justify-content: center; padding: 30px; text-align: center; z-index: 100; background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%); }
#landingPage img { width: 240px; margin-bottom: 10px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1)); }
.mode-btn { width: 100%; max-width: 320px; padding: 20px; border-radius: 18px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; margin-bottom: 16px; box-shadow: var(--shadow); }
.mode-btn:active { transform: scale(0.98); }
.btn-req { background: var(--danger); color: white; }
.btn-hero { background: var(--text); color: white; }

#seekerUI { background: var(--bg); padding: 20px; align-items: center; }
.status-card { background: white; width: 100%; max-width: 450px; padding: 25px; border-radius: 28px; box-shadow: var(--shadow); text-align: center; margin-top: 10px; border: 1px solid rgba(226, 232, 240, 0.8); }
#seekerMap { width: 100%; height: 220px; border-radius: 20px; margin: 15px 0; background: #eee; border: 1px solid #e2e8f0; }

#map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }

/* Status Indicator Fix */
#statusIndicator { 
    position: fixed; left: 15px; bottom: 150px; z-index: 200; 
    width: 55px; height: 55px; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    color: white; font-weight: 900; font-size: 28px; cursor: pointer; 
    box-shadow: var(--shadow); border: 3px solid white; transition: 0.3s; 
}

#heroPanel { width: 100%; max-width: 400px; position: fixed; bottom: 85px; left: 0; z-index: 150; display: flex; flex-direction: column; padding: 0 15px; pointer-events: none; }
#heroPanel > * { pointer-events: auto; }

.task-card { 
    background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); 
    padding: 20px 20px 20px 60px; /* Offset for indicator */
    border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
    border-left: 6px solid #cbd5e1; 
    display: block; transform: translateX(-110%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
}
.task-card.expanded { transform: translateX(0); }

.modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: flex-end; z-index: 1000; }
.modal-content { background: white; width: 100%; max-width: 500px; border-radius: 32px 32px 0 0; padding: 30px; max-height: 95vh; overflow-y: auto; transform: translateY(100%); animation: slideUp 0.3s forwards cubic-bezier(0, 0, 0.2, 1); }
@keyframes slideUp { to { transform: translateY(0); } }

#chatBox { height: 320px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 15px; background: #f8fafc; border-radius: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
.msg { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; line-height: 1.4; }
.msg-me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.msg-them { align-self: flex-start; background: white; color: var(--text); border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }

.vehicle-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 15px 0; }
.v-type { padding: 15px; border: 2px solid #f1f5f9; border-radius: 16px; text-align: center; cursor: pointer; font-weight: 700; }
.v-type.active { border-color: var(--accent); background: #eff6ff; color: var(--accent); }
.tip-btn { border: 2px solid #f1f5f9; border-radius: 12px; padding: 12px; flex: 1; text-align: center; cursor: pointer; font-weight: 800; background: white; }
.tip-btn.active { border-color: var(--success); background: #f0fdf4; color: var(--success); }

input, textarea, select { width: 100%; padding: 15px; border-radius: 14px; border: 1px solid #e2e8f0; margin-bottom: 12px; font-size: 15px; background: #f8fafc; }
.submit-btn { width: 100%; padding: 18px; background: var(--accent); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 16px; }
.cancel-link { display: block; text-align: center; padding: 15px; color: var(--muted); cursor: pointer; font-weight: 600; }

.footer { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(238, 97, 28, 0.9); backdrop-filter: blur(10px); display: flex; justify-content:center; align-items: center; z-index: 200; border-top: 1px solid rgba(255,255,255,0.2); }
.footer-icons { display:flex; gap:40px; align-items: center; }
.icon-btn { cursor: pointer; width: 32px; height: 32px; filter: brightness(0) invert(1); }
#notifBadge, #chatBadge, #chatBadgeHero { position: absolute; top: -5px; right: -5px; background: white; color: var(--danger); font-size: 10px; width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: 900; }

.center-btn { position: absolute; top: 20px; right: 20px; background: white; border: none; padding: 12px; border-radius: 12px; box-shadow: var(--shadow); cursor: pointer; z-index: 5; font-weight: 800; font-size: 11px; }
</style>
</head>
<body>

<div id="landingPage" class="view view-active">
    <img src="Roadsidelogo.png" onerror="this.src='https://via.placeholder.com/240x80?text=Roadside+Hero'" alt="Logo">
    <h2 style="color: var(--muted); margin-bottom: 40px; font-weight: 500; font-size: 18px;">Reliable help, wherever you are.</h2>
    <button class="mode-btn btn-req" onclick="window.openModal('requestModal')">Request Help!</button>
    <button class="mode-btn btn-hero" onclick="window.enterHeroMode()">Become a Hero!</button>
</div>

<!-- SEEKER UI -->
<div id="seekerUI" class="view">
    <button onclick="window.openModal('cancelConfirmModal')" style="align-self: flex-start; background: none; border: none; font-weight: 800; color: var(--danger); padding: 20px;">‚úï CANCEL SOS</button>
    <div id="searchingState" class="status-card">
        <div style="font-size:40px; margin-bottom:10px;">üì°</div>
        <h3>Broadcasting SOS...</h3>
        <p>Finding Heroes nearby...</p>
    </div>
    <div id="matchedState" class="status-card" style="display:none; border-color: var(--success);">
        <div style="background: var(--success); color: white; padding: 6px 16px; border-radius: 20px; display: inline-block; font-size: 12px; font-weight: 800; margin-bottom: 15px;">HERO CONNECTED</div>
        <div style="display: flex; align-items: center; gap: 15px; text-align: left;">
            <img id="matchPic" src="" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #f1f5f9;">
            <div style="flex:1">
                <h3 id="matchName" style="margin:0;">Hero Name</h3>
                <p id="matchETA" style="margin:4px 0; color: var(--success); font-weight: 800; font-size: 14px;">Arriving in ...</p>
            </div>
            <button onclick="window.openChat()" style="background:var(--accent); color:white; border:none; padding:12px; border-radius:14px; font-weight:bold;">CHAT</button>
        </div>
        <div id="seekerMap"></div>
    </div>
    <div class="footer">
        <div class="footer-icons">
            <img src="thishomeicon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1946/1946436.png'" class="icon-btn" onclick="location.reload()">
            <div id="footerChatBtn" style="position:relative; display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/589/589708.png" class="icon-btn" onclick="window.openChat()">
                <span id="chatBadge">0</span>
            </div>
            <img src="usericon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1077/1077063.png'" class="icon-btn" onclick="window.openProfile()">
        </div>
    </div>
</div>

<!-- HERO UI -->
<div id="heroUI" class="view">
    <button class="center-btn" onclick="window.centerOnMe()">üìç RE-CENTER</button>
    <div id="statusIndicator" style="background: #94a3b8;" onclick="window.toggleTaskCard()">!</div>
    <div id="map"></div>
    <div id="heroPanel">
        <div id="activeTask" class="task-card">
            <!-- Content Injected Dynamically via syncUI -->
            <div id="taskNormalView">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b id="taskStatusLabel" style="color: var(--muted); font-size:12px;">NO ACTIVE JOB</b>
                    <button id="taskChatBtn" onclick="window.openChat()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:12px; font-weight:bold; font-size:11px; display:none;">CHAT</button>
                </div>
                <p id="taskUser" style="margin:10px 0; font-weight:700; font-size:14px; color: var(--muted);">Tap a red pin on the map to start helping.</p>
                <p id="taskTipLabel" style="margin: 0 0 10px 0; font-weight: 800; color: var(--success); font-size: 14px;"></p>
                <div id="taskActionRow" style="display:none; gap:8px;">
                    <a id="navBtn" href="" target="_blank" style="flex:1; background:var(--success); color:white; text-align:center; padding:12px; border-radius:12px; text-decoration:none; font-weight:700; font-size:13px;">MAPS</a>
                    <button id="arrivedBtn" onclick="window.markArrived()" style="flex:1; background:var(--warning); color:white; border:none; border-radius:12px; font-weight:700; font-size:13px;">HERE</button>
                    <button id="completeBtn" onclick="window.completeTask()" style="flex:1; border:1px solid #ddd; background:white; border-radius:12px; font-weight:700; font-size:13px; display:none;">DONE</button>
                </div>
            </div>
            <div id="taskCanceledView" style="display:none; text-align:center;">
                <b style="color:var(--danger)">SOS CANCELED</b>
                <p id="cancelReasonDisplay" style="font-size:13px; margin:10px 0;"></p>
                <button onclick="window.acknowledgeCancel()" class="submit-btn" style="background:var(--text); padding:10px; font-size:13px;">CLOSE</button>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="footer-icons">
            <div style="position:relative">
                <img src="notificationicon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3119/3119338.png'" class="icon-btn" onclick="window.openModal('notifModal')">
                <span id="notifBadge">0</span>
            </div>
            <img src="thishomeicon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1946/1946436.png'" class="icon-btn" onclick="location.reload()">
            <div id="heroFooterChatBtn" style="position:relative; display:none;">
                <img src="https://cdn-icons-png.flaticon.com/512/589/589708.png" class="icon-btn" onclick="window.openChat()">
                <span id="chatBadgeHero">0</span>
            </div>
            <img src="usericon.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1077/1077063.png'" class="icon-btn" onclick="window.openProfile()">
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="detailsModal" class="modal"><div class="modal-content">
    <h3 id="detVehicle">Request</h3>
    <img id="detImg" style="width:100%; height:180px; object-fit:cover; border-radius:20px; margin-bottom:15px; display:none;">
    <p id="detIssue" style="font-weight:bold;"></p>
    <p id="detTip" style="color:var(--success); font-weight:900;"></p>
    <p id="detDist" style="color:var(--accent); font-size:13px; margin-bottom:15px;"></p>
    <select id="detETA"><option value="5-10 mins">5-10 mins</option><option value="15-20 mins">15-20 mins</option><option value="30 mins+">30 mins+</option></select>
    <button id="detAcceptBtn" class="submit-btn">ACCEPT & HELP</button>
    <span id="detInProgressText" style="display:none; color:var(--success); font-weight:bold; text-align:center;">JOB IN PROGRESS...</span>
    <span class="cancel-link" onclick="window.closeModal('detailsModal')">Go Back</span>
</div></div>

<div id="chatModal" class="modal"><div class="modal-content" style="height:85vh">
    <h3>Messages</h3><div id="chatBox"></div>
    <div style="display:flex; gap:10px;">
        <button onclick="document.getElementById('chatImgInput').click()" style="padding:15px; background:#f1f5f9; border:none; border-radius:15px;">üì∑</button>
        <input type="file" id="chatImgInput" accept="image/*" style="display:none" onchange="window.sendChatImg(this)">
        <input id="chatInput" placeholder="Type message..." style="margin:0;">
        <button onclick="window.sendTextMsg()" style="background:var(--accent); color:white; border:none; padding:0 20px; border-radius:15px; font-weight:bold;">SEND</button>
    </div>
    <span class="cancel-link" onclick="window.closeModal('chatModal')">Close</span>
</div></div>

<div id="requestModal" class="modal"><div class="modal-content">
    <h3>Request Help</h3>
    <div class="vehicle-grid">
        <div class="v-type active" onclick="window.selectVehicle('Car', this)">üöó Car</div>
        <div class="v-type" onclick="window.selectVehicle('Truck', this)">üõª Truck</div>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:12px;">
        <div class="tip-btn" onclick="window.setTip(5, this)">$5</div>
        <div class="tip-btn" onclick="window.setTip(10, this)">$10</div>
    </div>
    <input type="number" id="customTip" placeholder="Other Tip ($)">
    <textarea id="reqIssue" placeholder="What's the problem?"></textarea>
    <button class="submit-btn" onclick="window.submitSOS()">SUBMIT SOS</button>
    <p onclick="window.closeModal('requestModal')" class="cancel-link">Cancel</p>
</div></div>

<div id="profileModal" class="modal"><div class="modal-content">
    <h3>Profile</h3>
    <input id="profileName" placeholder="Name">
    <label>Radius: <span id="radiusVal">25</span> miles</label>
    <input type="range" id="profileRadius" min="5" max="100" step="5" value="25" oninput="document.getElementById('radiusVal').innerText=this.value">
    <button class="submit-btn" onclick="window.saveProfile()">Save Settings</button>
    <span class="cancel-link" onclick="window.closeModal('profileModal')">Close</span>
</div></div>

<div id="notifModal" class="modal"><div class="modal-content"><h3>History</h3><div id="notifHistory"></div><button class="submit-btn" onclick="window.closeModal('notifModal')">CLOSE</button></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const myId = localStorage.getItem('heroUserId') || 'u_'+Math.random().toString(36).substr(2,9);
localStorage.setItem('heroUserId', myId);

let map, userLocation, selectedVehicle = "Car", myRadius = 25, heroMarker;
let sosCache = {}, profilesCache = {}, markers = {}, activeChatId = null, lastMsgCount = 0;

const getMarkerIcon = (color) => ({
    path: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z",
    fillColor: color, fillOpacity: 1, strokeWeight: 2, strokeColor: "#ffffff", scale: 1.5, anchor: new google.maps.Point(12, 12)
});

window.onload = () => {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(p => {
            const loc = { lat: p.coords.latitude, lng: p.coords.longitude };
            const isFirst = !userLocation; userLocation = loc;
            update(ref(db, `profiles/${myId}`), { ...loc, id: myId });
            if (map) {
                if (!heroMarker) heroMarker = new google.maps.Marker({ position: loc, map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#2563eb", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 } });
                else heroMarker.setPosition(loc);
                if (isFirst) map.setCenter(loc);
            }
            syncUI();
        });
    }
};

window.toggleTaskCard = () => document.getElementById('activeTask').classList.toggle('expanded');
window.openModal = (id) => document.getElementById(id).style.display = "flex";
window.closeModal = (id) => document.getElementById(id).style.display = "none";
window.setTip = (amt, el) => { document.querySelectorAll('.tip-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); document.getElementById('customTip').value = amt; };
window.centerOnMe = () => map.setCenter(userLocation);
window.enterHeroMode = () => { window.switchView('heroUI'); if(!map) initMap(); };
window.switchView = (id) => {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
    document.getElementById(id).classList.add('view-active');
    if(map) google.maps.event.trigger(map, 'resize');
};

function initMap() { map = new google.maps.Map(document.getElementById("map"), { center: userLocation || {lat: 40, lng: -74}, zoom: 14, disableDefaultUI: true }); }

function syncUI() {
    let openCount = 0, currentTask = null, mySOS = null, jobActive = false;
    const history = document.getElementById('notifHistory'); history.innerHTML = "";

    Object.entries(sosCache).forEach(([id, r]) => {
        const isMyJob = (r.helperId === myId && (r.status === 'accepted' || r.status === 'arrived'));
        const dist = userLocation ? google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLocation.lat, userLocation.lng), new google.maps.LatLng(r.lat, r.lng)) / 1609 : 999;
        
        if((r.status === 'open' && r.ownerId !== myId) || isMyJob) {
            if(dist <= myRadius || isMyJob) {
                if(r.status === 'open') openCount++;
                const color = isMyJob ? "#22c55e" : "#EE611C";
                if(!markers[id] && map) {
                    const m = new google.maps.Marker({ position: {lat: r.lat, lng: r.lng}, map, icon: getMarkerIcon(color) });
                    m.addListener('click', () => window.viewRequest(id));
                    markers[id] = m;
                } else if(markers[id]) markers[id].setIcon(getMarkerIcon(color));
            } else if(markers[id]) { markers[id].setMap(null); delete markers[id]; }
        } else if(markers[id]) { markers[id].setMap(null); delete markers[id]; }

        if(r.helperId === myId && (r.status === 'accepted' || r.status === 'arrived' || (r.status === 'canceled' && !r.helperAcknowledged))) currentTask = r;
        if(r.ownerId === myId && (r.status === 'open' || r.status === 'accepted' || r.status === 'arrived')) mySOS = r;
        if((r.ownerId === myId || r.helperId === myId) && (r.status === 'accepted' || r.status === 'arrived')) jobActive = true;
    });

    // Update the Sidebar Dropdown based on Actual State
    const statusInd = document.getElementById('statusIndicator');
    const label = document.getElementById('taskStatusLabel');
    const userTxt = document.getElementById('taskUser');
    const chatBtn = document.getElementById('taskChatBtn');
    const actionRow = document.getElementById('taskActionRow');
    const tipLbl = document.getElementById('taskTipLabel');

    if(currentTask) {
        statusInd.style.background = currentTask.status === 'canceled' ? "var(--danger)" : "var(--success)";
        if(currentTask.status === 'canceled') {
            document.getElementById('taskNormalView').style.display = 'none';
            document.getElementById('taskCanceledView').style.display = 'block';
            document.getElementById('cancelReasonDisplay').innerText = `Reason: ${currentTask.cancelReason || 'None'}`;
        } else {
            document.getElementById('taskNormalView').style.display = 'block';
            document.getElementById('taskCanceledView').style.display = 'none';
            label.innerText = currentTask.status.toUpperCase() + " JOB";
            label.style.color = "var(--accent)";
            userTxt.innerText = `${currentTask.vehicle}: ${currentTask.issue}`;
            userTxt.style.color = "var(--text)";
            tipLbl.innerText = currentTask.tip > 0 ? "üí∞ Tip: $" + currentTask.tip : "";
            chatBtn.style.display = "block";
            actionRow.style.display = "flex";
            document.getElementById('navBtn').href = `https://www.google.com/maps/dir/?api=1&destination=${currentTask.lat},${currentTask.lng}`;
            document.getElementById('arrivedBtn').style.display = currentTask.status === 'accepted' ? 'block' : 'none';
            document.getElementById('completeBtn').style.display = currentTask.status === 'arrived' ? 'block' : 'none';
        }
    } else {
        // NO ACTIVE JOB STATE
        statusInd.style.background = openCount > 0 ? "var(--danger)" : "#94a3b8";
        label.innerText = openCount > 0 ? "JOBS AVAILABLE" : "NO JOBS AVAILABLE";
        label.style.color = "var(--muted)";
        userTxt.innerText = openCount > 0 ? "Tap a red pin nearby to accept." : "No requests in your radius right now.";
        userTxt.style.color = "var(--muted)";
        chatBtn.style.display = "none";
        actionRow.style.display = "none";
        tipLbl.innerText = "";
    }

    document.getElementById('footerChatBtn').style.display = jobActive ? 'block' : 'none';
    document.getElementById('heroFooterChatBtn').style.display = jobActive ? 'block' : 'none';
    const badge = document.getElementById('notifBadge'); badge.innerText = openCount; badge.style.display = openCount > 0 ? "flex" : "none";
}

onValue(ref(db, "sosRequests"), (snap) => { sosCache = snap.val() || {}; syncUI(); });
onValue(ref(db, "profiles"), (snap) => { profilesCache = snap.val() || {}; syncUI(); });

window.saveProfile = () => {
    myRadius = parseInt(document.getElementById("profileRadius").value);
    update(ref(db, `profiles/${myId}`), { name: document.getElementById("profileName").value, radius: myRadius });
    if(map && userLocation) { const c = new google.maps.Circle({center: userLocation, radius: myRadius * 1609}); map.fitBounds(c.getBounds()); }
    window.closeModal("profileModal");
};

// Messaging & Actions (re-used from your existing logic)
window.confirmHelp = (id) => { update(ref(db, `sosRequests/${id}`), { status: 'accepted', helperId: myId, eta: document.getElementById('detETA').value }); window.closeModal('detailsModal'); document.getElementById('activeTask').classList.add('expanded'); };
window.markArrived = () => { const act = Object.entries(sosCache).find(([k,v]) => v.helperId === myId && v.status === 'accepted'); if(act) update(ref(db, `sosRequests/${act[0]}`), {status:'arrived'}); };
window.completeTask = () => { const act = Object.entries(sosCache).find(([k,v]) => v.helperId === myId && v.status === 'arrived'); if(act) update(ref(db, `sosRequests/${act[0]}`), {status:'completed'}); };
window.submitSOS = () => { push(ref(db, "sosRequests"), { ownerId: myId, issue: document.getElementById('reqIssue').value, tip: document.getElementById('customTip').value, lat: userLocation.lat, lng: userLocation.lng, status: 'open', vehicle: selectedVehicle, timestamp: Date.now() }); window.closeModal('requestModal'); window.switchView('seekerUI'); };
window.acknowledgeCancel = () => { const act = Object.entries(sosCache).find(([k,v]) => v.helperId === myId && v.status === 'canceled'); if(act) update(ref(db, `sosRequests/${act[0]}`), {helperAcknowledged:true}); };
window.openProfile = async () => { window.openModal("profileModal"); const snap = await get(ref(db, `profiles/${myId}`)); if(snap.exists()) { const d = snap.val(); document.getElementById("profileName").value = d.name || ""; document.getElementById("profileRadius").value = d.radius || 25; document.getElementById("radiusVal").innerText = d.radius || 25; } };
</script>
</body>
</html>
