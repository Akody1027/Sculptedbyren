<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Roadside Hero</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Maps with Geometry -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5GbyoapPOyLYJLNo9y85cyorIczEI-WU&libraries=geometry"></script>

<style>
:root {
  --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
  --accent: #2563eb; --danger: #ef4444; --success: #22c55e;
  --inactive: #e2e8f0;
}
* { box-sizing: border-box; }
body { margin:0; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--text); overflow: hidden; }
#map { height: 100vh; width:100%; position:absolute; top:0; z-index:1; }

/* Panels */
#panel { position: fixed; bottom: 85px; left: 10px; right: 10px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 10; overflow: hidden; transition: 0.3s; }
#panelHeader { padding:16px 20px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; background: white; border-bottom: 1px solid #f1f5f9; }
#panelContent { max-height:0; overflow-y:auto; transition: 0.3s; padding: 0 16px; }
#panelContent.open { max-height: 40vh; padding-bottom: 16px; }

.card { background: #f1f5f9; border-radius:12px; padding:14px; margin-bottom:12px; border: 1px solid #e2e8f0; }
.btn-respond { width: 100%; border:none; padding:10px; border-radius:8px; background:var(--text); color:white; font-weight:600; cursor:pointer; margin-top:8px; }

/* Footer */
#footer { position:fixed; bottom:0; width:100%; height:75px; display:flex; justify-content: space-between; align-items:center; z-index:100; background: white; padding: 0 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
#sosBtn { background:var(--danger); color: white; border: none; padding:12px 25px; border-radius:12px; font-weight:700; cursor: pointer; }
.footer-icons { display: flex; gap: 12px; }
.icon-wrapper { position: relative; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 50%; }
#notifBadge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 10px; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 2px solid white; }

/* Modals */
.modal { position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); display:none; justify-content:center; align-items:flex-end; z-index:200; }
.modal-content { background:white; width:100%; max-width:500px; border-radius:24px 24px 0 0; padding:24px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* Notification Items */
.notif-item { padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #e2e8f0; position: relative; }
.notif-active { background: #f0fdf4; border-color: var(--success); }
.notif-completed { background: #f8fafc; border-color: #e2e8f0; opacity: 0.8; }
.status-pill { font-size: 10px; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; float: right; }
.status-active { background: var(--success); color: white; }
.status-completed { background: var(--muted); color: white; }

/* Vehicle Selection */
.vehicle-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
.v-type { padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; text-align: center; cursor: pointer; font-size: 13px; background: white; }
.v-type.active { background: var(--accent); color: white; border-color: var(--accent); }

/* Profile UI */
.profile-pic-container { text-align: center; margin-bottom: 15px; }
.round-pic { width: 85px; height: 85px; border-radius: 50%; object-fit: cover; background: #e2e8f0; border: 3px solid var(--accent); }

.hero-card { display: flex; align-items: center; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
.hero-info h4 { margin: 0; font-size: 16px; }

input, textarea { width:100%; padding:12px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:12px; font-size: 14px; }
.submit-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-bottom: 8px; }
.nav-btn { width: 100%; padding: 14px; background: var(--success); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: block; text-align: center; margin-bottom: 8px;}
.cancel-link { display: block; text-align: center; padding: 10px; color: var(--muted); cursor: pointer; font-size: 14px;}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <div id="panelHeader" onclick="window.togglePanel()">
    <h3>Active Requests</h3>
    <span id="chevron">‚ñ≤</span>
  </div>
  <div id="panelContent">
    <div id="requests"></div>
  </div>
</div>

<div id="footer">
  <button id="sosBtn" onclick="window.openModal('modal')">GET HELP NOW</button>
  <div class="footer-icons">
      <div class="icon-wrapper" onclick="window.openModal('notifModal')">
          <span>üîî</span>
          <span id="notifBadge">0</span>
      </div>
      <div class="icon-wrapper" onclick="window.openProfile()">
          <span>üë§</span>
      </div>
  </div>
</div>

<!-- Interaction Details Modal -->
<div id="interactionModal" class="modal">
    <div class="modal-content">
        <h3>Hero Assistance Details</h3>
        <div id="interactionHeroDisplay"></div>
        <div id="interactionSOSDisplay" style="margin-top:10px;"></div>
        <div id="interactionActions">
            <button class="submit-btn" style="background:var(--success); margin-top:15px;" id="interactionCompleteBtn">MARK SOS COMPLETED</button>
        </div>
        <span class="cancel-link" onclick="window.closeModal('interactionModal')">Close Details</span>
    </div>
</div>

<!-- Request SOS Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Post SOS Request</h3>
    <label style="font-size:12px; color:var(--muted)">Vehicle Type</label>
    <div class="vehicle-grid">
        <div class="v-type active" onclick="window.selectVehicle('Car', this)">üöó Car</div>
        <div class="v-type" onclick="window.selectVehicle('Truck', this)">üõª Truck</div>
        <div class="v-type" onclick="window.selectVehicle('RV', this)">üöê RV</div>
        <div class="v-type" onclick="window.selectVehicle('Commercial', this)">üöõ Heavy Duty</div>
    </div>
    <input id="name" placeholder="Your Name">
    <textarea id="issue" placeholder="What's the problem?" rows="2"></textarea>
    <input id="tip" type="number" placeholder="Incentive Tip Amount ($)">
    <button class="submit-btn" onclick="window.submitSOS()">Post Request</button>
    <span class="cancel-link" onclick="window.closeModal('modal')">Cancel</span>
  </div>
</div>

<!-- Response Modal -->
<div id="responseModal" class="modal">
  <div class="modal-content">
    <h3 id="respName">SOS Details</h3>
    <p id="respVehicle" style="font-weight:bold; margin:0 0 10px; color:var(--accent);"></p>
    <p id="respIssue" style="background:#f1f5f9; padding:15px; border-radius:12px;"></p>
    <p id="respTip" style="font-weight:bold; color:var(--success);"></p>
    <button class="submit-btn" id="confirmHelpBtn">I'M ON MY WAY</button>
    <a id="navBtn" class="nav-btn" target="_blank" style="display:none;">NAVIGATE TO LOCATION</a>
    <span class="cancel-link" onclick="window.closeModal('responseModal')">Go Back</span>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <div class="profile-pic-container">
            <img id="profileDisplayPic" class="round-pic" src="https://via.placeholder.com/85">
            <input type="file" id="picInput" style="display:none" onchange="window.previewFile()">
            <button onclick="document.getElementById('picInput').click()" style="display:block; margin:5px auto; border:none; background:none; color:var(--accent); font-weight:bold; cursor:pointer;">Update Photo</button>
        </div>
        <div style="text-align:center; margin-bottom:15px;">Assists: <b id="heroCountDisplay">0</b></div>
        <input id="profileName" placeholder="Display Name">
        <textarea id="profileBio" placeholder="Bio/Tools..." rows="2"></textarea>
        <button class="submit-btn" onclick="window.saveProfile()">Save Settings</button>
        <span class="cancel-link" onclick="window.closeModal('profileModal')">Close</span>
    </div>
</div>

<!-- Notifications Modal -->
<div id="notifModal" class="modal" onclick="if(event.target==this) window.closeModal('notifModal')">
    <div class="modal-content">
        <h3>Notification History</h3>
        <div id="notifList"></div>
        <button class="submit-btn" style="background:#f1f5f9; color:var(--text); margin-top:20px;" onclick="window.closeModal('notifModal')">Close</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, update, remove, query, orderByChild, endAt } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgXWZkH0WMjhGmOfxjqbIDoJHlyA1pc-o",
  authDomain: "roadsidehero-104ea.firebaseapp.com",
  databaseURL: "https://roadsidehero-104ea-default-rtdb.firebaseio.com",
  projectId: "roadsidehero-104ea",
  storageBucket: "roadsidehero-104ea.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

if(!localStorage.getItem('heroUserId')) localStorage.setItem('heroUserId', 'u_' + Math.random().toString(36).substr(2, 9));
const myId = localStorage.getItem('heroUserId');

let map, userLocation, watchId = null, selectedVehicle = "Car";
let sosCache = {}, profilesCache = {}, sosMarkers = {}, helperMarkers = {};

window.openModal = (id) => document.getElementById(id).style.display = "flex";
window.closeModal = (id) => document.getElementById(id).style.display = "none";
window.togglePanel = () => {
    const c = document.getElementById("panelContent");
    c.classList.toggle("open");
    document.getElementById("chevron").textContent = c.classList.contains("open") ? "‚ñº" : "‚ñ≤";
};

window.selectVehicle = (type, el) => {
    selectedVehicle = type;
    document.querySelectorAll(".v-type").forEach(b => b.classList.remove("active"));
    el.classList.add("active");
};

// Interaction Logic
window.openInteractionDetails = (sosId) => {
    const sos = sosCache[sosId];
    if(!sos) return;
    const hero = profilesCache[sos.helperId] || {};

    document.getElementById('interactionHeroDisplay').innerHTML = `
        <div class="hero-card">
            <img src="${hero.pic || 'https://via.placeholder.com/85'}" class="round-pic" style="width:60px; height:60px;">
            <div class="hero-info">
                <h4>${hero.name || 'Hero'} Assistance</h4>
                <p>${sos.status === 'completed' ? 'This help request is completed.' : 'Hero is on the way!'}</p>
            </div>
        </div>
    `;
    document.getElementById('interactionSOSDisplay').innerHTML = `
        <div class="card" style="background:#f1f5f9; border:none;">
            <p><b>Vehicle:</b> ${sos.vehicle || 'Car'}</p>
            <p><b>Issue:</b> ${sos.issue}</p>
            ${sos.tip > 0 ? `<p style="color:var(--success)"><b>Tip Offered:</b> $${sos.tip}</p>` : ''}
        </div>
    `;

    // Hide complete button if already completed
    document.getElementById('interactionActions').style.display = sos.status === 'completed' ? 'none' : 'block';
    document.getElementById('interactionCompleteBtn').onclick = () => window.completeSOS(sosId);
    
    window.closeModal('notifModal');
    window.openModal('interactionModal');
};

// Profile & GPS
window.previewFile = () => {
    const reader = new FileReader();
    reader.onload = (e) => document.getElementById('profileDisplayPic').src = e.target.result;
    reader.readAsDataURL(document.getElementById('picInput').files[0]);
};

window.saveProfile = () => {
    update(ref(database, `profiles/${myId}`), {
        name: document.getElementById("profileName").value,
        bio: document.getElementById("profileBio").value,
        pic: document.getElementById("profileDisplayPic").src
    });
    window.closeModal("profileModal");
};

window.openProfile = async () => {
    window.openModal("profileModal");
    const snap = await get(ref(database, `profiles/${myId}`));
    if(snap.exists()) {
        const d = snap.val();
        document.getElementById("profileName").value = d.name || "";
        document.getElementById("profileBio").value = d.bio || "";
        document.getElementById("heroCountDisplay").innerText = d.helpsCount || 0;
        if(d.pic) document.getElementById("profileDisplayPic").src = d.pic;
    }
};

// SOS Flow
window.submitSOS = () => {
  const name = document.getElementById("name").value.trim();
  const issue = document.getElementById("issue").value.trim();
  const tip = document.getElementById("tip").value || 0;
  if(!name || !issue || !userLocation) return;
  push(ref(database, "sosRequests"), {
    userName: name, issue, tip, vehicle: selectedVehicle,
    lat: userLocation.lat, lng: userLocation.lng,
    status: "open", timestamp: Date.now(), ownerId: myId
  });
  window.closeModal("modal");
};

window.openHelpDetails = (id) => {
    const data = sosCache[id];
    document.getElementById("respName").innerText = "Helping " + data.userName;
    document.getElementById("respVehicle").innerText = "Vehicle: " + (data.vehicle || "Car");
    document.getElementById("respIssue").innerText = data.issue;
    document.getElementById("respTip").innerText = data.tip > 0 ? `Tip: $${data.tip}` : "";
    document.getElementById("navBtn").style.display = "block";
    document.getElementById("navBtn").href = `https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}`;
    document.getElementById("confirmHelpBtn").onclick = () => window.confirmHelp(id);
    window.openModal("responseModal");
};

window.confirmHelp = (id) => {
    update(ref(database, `sosRequests/${id}`), { status: "accepted", helperId: myId });
    window.closeModal("responseModal");
};

window.completeSOS = async (id) => {
    const r = sosCache[id];
    if (r && r.helperId) {
        const snap = await get(ref(database, `profiles/${r.helperId}`));
        const count = snap.exists() ? (snap.val().helpsCount || 0) : 0;
        update(ref(database, `profiles/${r.helperId}`), { helpsCount: count + 1 });
    }
    // Update status to completed instead of removing
    update(ref(database, `sosRequests/${id}`), { status: "completed", completedAt: Date.now() });
    window.closeModal('interactionModal');
};

async function cleanupOldRequests() {
    const twelveHoursAgo = Date.now() - (12 * 60 * 60 * 1000);
    const q = query(ref(database, "sosRequests"), orderByChild("timestamp"), endAt(twelveHoursAgo));
    const snap = await get(q);
    // Cleanup old completed or open requests to save DB space, but keep them in session if needed
    if (snap.exists()) snap.forEach(c => remove(ref(database, `sosRequests/${c.key}`)));
}

function initMap() {
    cleanupOldRequests();
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.7, lng: -74 }, zoom: 15, disableDefaultUI: true
    });

    navigator.geolocation.getCurrentPosition(pos => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(userLocation);
        new google.maps.Marker({ position: userLocation, map, icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" });
        // Start watching hero location for live updates
        watchId = navigator.geolocation.watchPosition(p => {
             update(ref(database, `profiles/${myId}`), { lat: p.coords.latitude, lng: p.coords.longitude });
        }, null, { enableHighAccuracy: true });
    });

    onValue(ref(database, "sosRequests"), (snap) => {
        sosCache = snap.val() || {};
        renderSOS();
        updateNotifications();
    });

    onValue(ref(database, "profiles"), (snap) => {
        profilesCache = snap.val() || {};
        renderHelpers();
    });
}

function renderSOS() {
    const container = document.getElementById("requests");
    container.innerHTML = "";
    Object.entries(sosCache).forEach(([id, d]) => {
        // Only show OPEN requests on the map/browse list
        if(d.status !== "open") {
            if(sosMarkers[id]) { sosMarkers[id].setMap(null); delete sosMarkers[id]; }
            return;
        }
        if(!sosMarkers[id]) sosMarkers[id] = new google.maps.Marker({ 
            position: {lat: d.lat, lng: d.lng}, map, icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" 
        });
        container.innerHTML += `<div class="card">
            <b>${d.userName}</b> [${d.vehicle || 'Car'}]
            <p style="font-size:14px; margin:5px 0;">${d.issue}</p>
            <button class="btn-respond" onclick="window.openHelpDetails('${id}')">VIEW & HELP</button>
        </div>`;
    });
}

function renderHelpers() {
    Object.entries(profilesCache).forEach(([id, p]) => {
        if(id === myId) return;
        let isMyHero = false;
        Object.values(sosCache).forEach(req => { 
            // Only track hero on map if status is specifically 'accepted'
            if(req.ownerId === myId && req.status==='accepted' && req.helperId===id) isMyHero = true; 
        });

        // If not your active hero, don't show on map
        if(!isMyHero) {
            if(helperMarkers[id]) { helperMarkers[id].setMap(null); delete helperMarkers[id]; }
            return;
        }
        const pos = {lat: p.lat, lng: p.lng};
        if(!helperMarkers[id]) {
            helperMarkers[id] = new google.maps.Marker({
                position: pos, map, icon: "http://maps.google.com/mapfiles/kml/pal4/icon54.png"
            });
        } else {
            helperMarkers[id].setPosition(pos);
        }
    });
}

function updateNotifications() {
    const badge = document.getElementById("notifBadge");
    const list = document.getElementById("notifList");
    let activeCount = 0; let html = "";
    
    // Sort notifications: Accepted first, then Completed
    const sortedEntries = Object.entries(sosCache).sort((a,b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

    sortedEntries.forEach(([id, r]) => {
        if(r.ownerId === myId) {
            if (r.status === "accepted") {
                activeCount++;
                html += `
                <div class="notif-item notif-active" onclick="window.openInteractionDetails('${id}')">
                    <span class="status-pill status-active">Active</span>
                    <b>Hero is on the way!</b><br>
                    <small>Assigned Hero: ${profilesCache[r.helperId]?.name || 'Hero'}</small>
                    <button class="btn-respond" style="background:var(--accent)">SHOW DETAILS</button>
                </div>`;
            } else if (r.status === "completed") {
                html += `
                <div class="notif-item notif-completed" onclick="window.openInteractionDetails('${id}')">
                    <span class="status-pill status-completed">Completed</span>
                    <b>Assistance Finished</b><br>
                    <small>Issue: ${r.issue.substring(0, 20)}...</small>
                </div>`;
            }
        }
    });

    badge.innerText = activeCount;
    badge.style.display = activeCount > 0 ? "flex" : "none";
    list.innerHTML = html || "<p style='color:gray;text-align:center;'>No past or active requests found.</p>";
}

initMap();
</script>
</body>
</html>
