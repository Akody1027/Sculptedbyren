<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Mockup Creator</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <style>
    /* (same CSS as before) */
    :root {
      --bg: #f0f2f5;
      --card: #fff;
      --text: #333;
      --accent: #4A90E2;
      --shadow-light: rgba(0,0,0,0.05);
      --shadow-strong: rgba(0,0,0,0.15);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; height:100%; width:100%; }
    body {
      padding:20px; font-family:'Inter',sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh;
    }
    .container { /* ... */ }
    /* truncate for brevity: include all previous CSS */
  </style>
</head>
<body>
  <div class="container">
    <h1>Mockup Creator</h1>
    <!-- file inputs, thumbnails, canvas as before -->
    <label for="add-mockup-input">Upload a mockup (JPG/PNG)</label>
    <input type="file" id="add-mockup-input" accept="image/*" />
    <div id="mockup-thumbnails" class="thumbnail-container"></div>
    <div id="no-mockups-msg">No mockups yet — upload one above.</div>

    <label for="design-input">Select your design (PNG)</label>
    <input type="file" id="design-input" accept="image/png" />
    <div id="design-thumb" class="thumb-wrapper">
      <img src="" alt="Design" /><div class="minus">-</div>
    </div>

    <canvas id="mockup-canvas"></canvas>
  </div>

  <button id="download-btn">Download Mockup</button>

  <div id="controls-container">
    <!-- control buttons as before -->
  </div>

  <script>
  (function(){
    // state & element refs (same as before)...
    let mockupImages = {}, designImg = null;
    let scale = 1, offsetX = 0, offsetY = 0, rotation = 0;

    const canvas = document.getElementById('mockup-canvas'),
          ctx    = canvas.getContext('2d'),
          thumbs = document.getElementById('mockup-thumbnails'),
          noMsg  = document.getElementById('no-mockups-msg'),
          addIn  = document.getElementById('add-mockup-input'),
          desIn  = document.getElementById('design-input'),
          desWr  = document.getElementById('design-thumb'),
          desImg = desWr.querySelector('img'),
          desMin = desWr.querySelector('.minus'),
          dlBtn  = document.getElementById('download-btn'),
          resSel = document.getElementById('resolution-select');

    // loadStoredMockups(), renderThumbnails(), selectMockup(), drawCanvas(),
    // input handlers, control-btn handlers, touch handlers—all as before...

    // DOWNLOAD FIXED: use Data URL + append/remove anchor
    dlBtn.addEventListener('click', () => {
      const m = parseInt(resSel.value, 10),
            ex = document.createElement('canvas'),
            exCtx = ex.getContext('2d');
      ex.width = canvas.width * m;
      ex.height = canvas.height * m;
      exCtx.scale(m, m);
      exCtx.drawImage(window.bgImg, 0, 0);
      if (designImg) {
        const w = designImg.width * scale,
              h = designImg.height * scale,
              cx = canvas.width/2 + (offsetX/100)*canvas.width,
              cy = canvas.height/2 + (offsetY/100)*canvas.height;
        exCtx.save();
        exCtx.translate(cx, cy);
        exCtx.rotate(rotation * Math.PI/180);
        exCtx.drawImage(designImg, -w/2, -h/2, w, h);
        exCtx.restore();
      }

      // Generate Data URL
      const dataUrl = ex.toDataURL('image/png');
      // Create, append, click, and remove <a> each time
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `mockup@${m}x.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // initialization
    loadStoredMockups();
    renderThumbnails();

  })();
  </script>
</body>
</html>
