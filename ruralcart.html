<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Fetch</title>

    <!-- 1. Leaflet (The Free Engine) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <!-- 2. FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* GOOGLE MATERIAL DESIGN THEME */
        :root {
            --primary: #1a73e8; /* Google Blue */
            --accent: #e67e22;  /* Fetch Orange */
            --dark: #202124;    /* Google Text Black */
            --grey: #5f6368;    /* Google Text Grey */
            --light: #f8f9fa;
            --shadow: 0 1px 2px rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Roboto', -apple-system, sans-serif; }
        body { margin: 0; background-color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Map Container --- */
        #map { height: 55vh; width: 100%; z-index: 1; background: #eef2f3; }

        /* --- Floating Search Bar (Google Style) --- */
        .search-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; z-index: 1000;
        }

        .search-box {
            background: white; border-radius: 8px;
            box-shadow: var(--shadow); height: 48px;
            display: flex; align-items: center; padding: 0 15px;
            transition: all 0.2s;
        }
        
        .search-box i.menu-icon { color: var(--grey); margin-right: 15px; font-size: 18px; }
        .search-box i.search-icon { color: var(--primary); margin-left: auto; font-size: 20px;}
        
        #place-input {
            border: none; width: 100%; height: 100%; font-size: 16px; outline: none; 
            color: var(--dark);
        }

        /* --- Search Results Dropdown --- */
        #search-results {
            background: white; width: 100%; margin-top: 5px; border-radius: 8px;
            box-shadow: var(--shadow); display: none; overflow: hidden; max-height: 250px; overflow-y: auto;
        }
        .result-item {
            padding: 15px; border-bottom: 1px solid #f1f3f4; font-size: 14px; color: var(--dark);
            display: flex; align-items: center; cursor: pointer;
        }
        .result-item:active { background: #f1f3f4; }
        .result-item i { margin-right: 15px; color: var(--grey); }

        /* --- Bottom Sheet --- */
        #step-container {
            flex: 1; background: white;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            margin-top: -20px; z-index: 2; padding: 24px;
            overflow-y: auto; position: relative;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
        }

        h2 { margin: 0 0 10px 0; color: var(--dark); font-size: 22px; font-weight: 400; }
        p { color: var(--grey); margin-top: 0; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        
        /* --- Buttons --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 14px;
            border-radius: 24px; font-size: 14px; font-weight: 500; letter-spacing: 0.5px;
            width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            margin-top: 20px; box-shadow: 0 1px 3px rgba(60,64,67,0.3);
            text-transform: uppercase;
        }
        .btn:active { background: #1765cc; }
        
        .btn-outline { background: white; border: 1px solid #dadce0; color: var(--primary); box-shadow: none; }

        /* --- Location Choice Overlay --- */
        #location-choice {
            position: absolute; top:0; left:0; width:100%; height:100%; background: white;
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px;
        }
        .big-btn {
            width: 100%; padding: 20px; border: 1px solid #dadce0; border-radius: 12px;
            margin-bottom: 15px; text-align: left; display: flex; align-items: center;
            background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .big-btn i { font-size: 24px; color: var(--primary); margin-right: 20px; }
        .big-btn strong { display: block; font-size: 16px; color: var(--dark); margin-bottom: 4px; }
        .big-btn small { color: var(--grey); font-size: 13px; }

        /* --- List Items --- */
        .stop-item {
            display: flex; align-items: center; padding: 12px 0; 
            border-bottom: 1px solid #f1f3f4;
        }
        .stop-item i { color: var(--accent); margin-right: 15px; }

        /* --- Invoice --- */
        .invoice-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 10px; }
        .invoice-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #3c4043; }
        .total-row { font-weight: bold; font-size: 18px; margin-top: 10px; border-top: 1px solid #dadce0; padding-top: 10px; }

        /* Views & Progress */
        .step-view { display: none; animation: fadeIn 0.3s ease; }
        .step-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { display: flex; justify-content: center; margin-bottom: 20px; gap: 8px; }
        .dot { width: 8px; height: 8px; background: #dadce0; border-radius: 50%; }
        .dot.active { background: var(--primary); }

        /* Custom Markers */
        .g-pin-red {
            /* Standard Google Red Pin */
            width: 30px; height: 30px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg');
            background-size: contain; background-repeat: no-repeat;
        }
        .g-pin-blue {
            /* Standard Google Blue Dot */
            width: 14px; height: 14px;
            background: #1a73e8; border: 2px solid white; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <!-- 1. LOCATION CHOICE -->
    <div id="location-choice">
        <h1 style="color:var(--dark); margin-bottom:30px; font-weight:400;">Fetch</h1>
        
        <button class="big-btn" onclick="app.useGPS()">
            <i class="fas fa-crosshairs"></i>
            <div>
                <strong>Use current location</strong>
                <small>Auto-detect via GPS</small>
            </div>
        </button>

        <button class="big-btn" onclick="app.useManual()">
            <i class="fas fa-search"></i>
            <div>
                <strong>Enter address</strong>
                <small>Type it manually</small>
            </div>
        </button>
    </div>

    <!-- 2. MAP AREA -->
    <div id="map"></div>
    
    <!-- SEARCH BAR -->
    <div class="search-container" id="search-bar" style="display:none;">
        <div class="search-box">
            <i class="fas fa-bars menu-icon"></i>
            <input type="text" id="place-input" placeholder="Search home address..." autocomplete="off">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- 3. CONTENT SHEET -->
    <div id="step-container">
        
        <div class="progress-bar">
            <div id="dot-1" class="dot active"></div>
            <div id="dot-2" class="dot"></div>
            <div id="dot-3" class="dot"></div>
        </div>

        <!-- STEP 1: CONFIRM HOME -->
        <div id="step-1" class="step-view active">
            <h2>Confirm Location</h2>
            <div style="display:flex; align-items:center; margin-bottom:15px; background:#f1f3f4; padding:12px; border-radius:8px;">
                <i class="fas fa-map-marker-alt" style="color:#d93025; margin-right:12px; font-size:18px;"></i>
                <div id="address-text" style="font-weight:500;">Locating...</div>
            </div>
            <button class="btn" onclick="app.goToStep(2)">Confirm Location</button>
        </div>

        <!-- STEP 2: ADD STOPS -->
        <div id="step-2" class="step-view">
            <h2>Add Stops</h2>
            <p>Search for stores (e.g. "Walmart") above.</p>

            <div id="stops-list">
                <div id="empty-state" style="text-align:center; padding:30px; color:#bdc1c6;">
                    <i class="fas fa-store-alt" style="font-size:30px; margin-bottom:10px;"></i>
                    <div>No stops added yet</div>
                </div>
            </div>

            <button class="btn" id="finish-stops-btn" style="display:none; background:var(--accent);" onclick="app.goToStep(3)">
                Done Adding Stops
            </button>
            <button class="btn btn-outline" onclick="app.goToStep(1)">Back</button>
        </div>

        <!-- STEP 3: PAYMENT -->
        <div id="step-3" class="step-view">
            <h2>Review Order</h2>
            
            <label style="display:flex; padding:15px; border:1px solid #dadce0; border-radius:8px; margin-bottom:10px;" onclick="app.calcTotal()">
                <input type="radio" name="speed" value="standard" checked style="margin-right:15px; accent-color:var(--primary);">
                <div><strong>Standard</strong><br><small>Waitlist â€¢ Delivered Tomorrow</small></div>
            </label>

            <label style="display:flex; padding:15px; border:1px solid #dadce0; border-radius:8px;" onclick="app.calcTotal()">
                <input type="radio" name="speed" value="rush" style="margin-right:15px; accent-color:var(--primary);">
                <div><strong>Rush</strong><br><small>Immediate Dispatch</small></div>
            </label>

            <div id="bribe-section" style="display:none; margin-top:10px; padding:10px; background:#e8f0fe; border-radius:8px;">
                <label style="font-size:12px; font-weight:bold;">Driver Offer ($):</label>
                <input type="number" id="bribe-val" value="25" style="width:60px; padding:5px; border:1px solid #ccc; border-radius:4px;" onchange="app.calcTotal()">
            </div>

            <div class="invoice-box">
                <div class="invoice-row"><span>Driver Base</span><span>$15.00</span></div>
                <div class="invoice-row"><span>Platform Fee</span><span>$5.00</span></div>
                <div class="invoice-row" id="row-rush" style="display:none;"><span>Rush Fee</span><span id="rush-price">$0.00</span></div>
                <div class="total-row"><span>Total</span><span id="total-price">$20.00</span></div>
            </div>
            <button class="btn" onclick="alert('Order Placed!')">Place Order</button>
            <button class="btn btn-outline" onclick="app.goToStep(2)">Back</button>
        </div>
    </div>

    <script>
        const state = {
            map: null,
            userMarker: null,
            routeLine: null,
            stops: [],
            currentStep: 1,
            userLoc: { lat: 35.0, lng: -97.0 },
            searchDebounce: null
        };

        // --- INIT MAP (Uses Leaflet engine but loads Google Images) ---
        function initMap() {
            // MAGIC LINE: This loads Google Map Tiles without an API Key
            const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            });

            state.map = L.map('map', {
                zoomControl: false,
                attributionControl: false // Cleaner look
            }).setView([35.0, -97.0], 13);

            googleStreets.addTo(state.map);
        }

        const app = {
            useGPS: () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                            app.setHome(pos, "GPS Location");
                            
                            // Hide Choice, Show Search
                            document.getElementById('location-choice').style.display = 'none';
                            document.getElementById('search-bar').style.display = 'block';
                            document.getElementById('place-input').placeholder = "Search home address...";
                        },
                        () => {
                            alert("GPS failed.");
                            app.useManual();
                        }
                    );
                }
            },

            useManual: () => {
                document.getElementById('location-choice').style.display = 'none';
                document.getElementById('search-bar').style.display = 'block';
                document.getElementById('place-input').focus();
            },

            setHome: (latlng, text) => {
                state.userLoc = latlng;
                if(state.userMarker) state.map.removeLayer(state.userMarker);
                
                // Red Google-Style Pin using CSS/Icon
                const icon = L.divIcon({
                    className: 'custom-pin',
                    html: '<i class="fas fa-map-marker-alt fa-3x" style="color:#d93025; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.4));"></i>',
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });

                state.userMarker = L.marker(latlng, {draggable: true, icon: icon}).addTo(state.map);
                state.map.setView(latlng, 16);

                state.userMarker.on('dragend', (e) => {
                    state.userLoc = e.target.getLatLng();
                    document.getElementById('address-text').innerText = "Pin Dropped";
                });
                document.getElementById('address-text').innerText = text;
            },

            // --- SEARCH LOGIC (Styled like Google, Powered by OSM) ---
            handleSearch: (e) => {
                const query = e.target.value;
                const resultsBox = document.getElementById('search-results');
                
                if(query.length < 3) {
                    resultsBox.style.display = 'none';
                    return;
                }

                clearTimeout(state.searchDebounce);
                state.searchDebounce = setTimeout(() => {
                    // Using Nominatim (Free) but styled like Google
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5`)
                        .then(res => res.json())
                        .then(data => {
                            resultsBox.innerHTML = "";
                            if(data.length > 0) {
                                resultsBox.style.display = 'block';
                                data.forEach(place => {
                                    const div = document.createElement('div');
                                    div.className = 'result-item';
                                    const name = place.display_name.split(',')[0];
                                    const addr = place.display_name.split(',').slice(1,3).join(',');
                                    
                                    div.innerHTML = `
                                        <i class="fas fa-map-marker-alt"></i> 
                                        <div>
                                            <strong style="color:#202124">${name}</strong>
                                            <div style="color:#70757a; font-size:12px;">${addr}</div>
                                        </div>`;
                                    
                                    div.onclick = () => {
                                        app.selectResult(place);
                                        resultsBox.style.display = 'none';
                                        document.getElementById('place-input').value = "";
                                    };
                                    resultsBox.appendChild(div);
                                });
                            }
                        });
                }, 300);
            },

            selectResult: (place) => {
                const lat = parseFloat(place.lat);
                const lng = parseFloat(place.lon);
                const name = place.display_name.split(',')[0];

                if(state.currentStep === 1) {
                    app.setHome({lat, lng}, name);
                } else {
                    app.addStop(name, lat, lng);
                }
            },

            addStop: (name, lat, lng) => {
                state.stops.push({name, lat, lng});
                
                // Blue Google Dot
                const icon = L.divIcon({
                    className: 'stop-pin',
                    html: '<div class="g-pin-blue"></div>',
                    iconSize: [14, 14]
                });
                L.marker([lat, lng], {icon: icon}).addTo(state.map).bindPopup(name).openPopup();

                // Add to List
                const list = document.getElementById('stops-list');
                document.getElementById('empty-state').style.display = 'none';
                list.innerHTML += `
                    <div class="stop-item">
                        <i class="fas fa-store"></i>
                        <div class="stop-text">
                            <strong>${name}</strong>
                            <div style="font-size:12px; color:#70757a;">Stop Added</div>
                        </div>
                    </div>`;

                app.drawRoute();
                document.getElementById('finish-stops-btn').style.display = 'flex';
            },

            drawRoute: () => {
                if(state.routeLine) state.map.removeLayer(state.routeLine);
                
                const points = state.stops.map(s => [s.lat, s.lng]);
                points.push([state.userLoc.lat, state.userLoc.lng]); // End at home

                // Blue Google Route Line
                state.routeLine = L.polyline(points, {color: '#1a73e8', weight: 5, opacity: 0.8}).addTo(state.map);
                state.map.fitBounds(state.routeLine.getBounds(), {padding: [50,50]});
            },

            goToStep: (num) => {
                document.querySelectorAll('.step-view').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.dot').forEach(el => el.classList.remove('active'));
                document.getElementById('step-' + num).classList.add('active');
                for(let i=1; i<=num; i++) document.getElementById('dot-'+i).classList.add('active');
                
                state.currentStep = num;
                const input = document.getElementById('place-input');
                if(num === 1) input.placeholder = "Search home address...";
                else if (num === 2) {
                    input.placeholder = "Search for stores (e.g. Walmart)...";
                    state.map.setZoom(12);
                }
            },

            calcTotal: () => {
                const speed = document.querySelector('input[name="speed"]:checked').value;
                let rush = (speed === 'rush') ? parseFloat(document.getElementById('bribe-val').value) : 0;
                document.getElementById('bribe-section').style.display = (speed === 'rush') ? 'block' : 'none';
                document.getElementById('row-rush').style.display = (speed === 'rush') ? 'flex' : 'none';
                document.getElementById('rush-price').innerText = '$' + rush.toFixed(2);
                document.getElementById('total-price').innerText = '$' + (15 + 5 + rush).toFixed(2);
            }
        };

        // Init
        document.getElementById('place-input').addEventListener('input', app.handleSearch);
        window.onload = initMap;
    </script>
</body>
</html>
