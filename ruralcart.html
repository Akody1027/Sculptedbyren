<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#e67e22"> <!-- Burnt Orange -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fetch</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        :root {
            --primary: #e67e22; /* Fetch Orange */
            --primary-dark: #d35400;
            --secondary: #2c3e50; /* Slate Blue */
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #f5f6fa;
            --grey: #bdc3c7;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--light);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- App Shell --- */
        .view {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 90px;
            animation: fadeIn 0.3s ease;
        }

        .view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { margin-top: 0; color: var(--dark); }
        p { color: #7f8c8d; line-height: 1.5; }

        /* --- Components --- */
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: var(--danger); }
        .btn-outline { background: transparent; border: 2px solid #ddd; color: var(--dark); }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            background: #fff;
        }
        input:focus { outline: none; border-color: var(--primary); }

        /* --- Gateway --- */
        .gateway-split {
            height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .gateway-customer { background: white; color: var(--primary); }
        .gateway-driver { background: var(--secondary); color: white; }
        .gateway-driver:active { opacity: 0.9; }

        /* --- Map --- */
        #map-container {
            height: 250px;
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            z-index: 1;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            display: none;
            justify-content: space-around;
            padding: 12px 0 calc(12px + var(--safe-bottom)) 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .nav-item {
            text-align: center;
            color: var(--grey);
            font-size: 10px;
            flex: 1;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        /* --- Invoice Rows --- */
        .invoice-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .invoice-row.total { font-weight: bold; font-size: 18px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .invoice-row.fee { color: #7f8c8d; font-size: 12px; }

        /* --- Badges --- */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-pending { background: #f1c40f; color: #333; }
        .badge-success { background: #2ecc71; color: white; }
    </style>
</head>
<body>

    <!-- ================= VIEWS ================= -->

    <!-- 1. GATEWAY (Landing) -->
    <div id="view-gateway" style="display:block; padding:0; height:100vh;">
        <!-- Customer: No Login Required -->
        <div class="gateway-split gateway-customer" onclick="app.guestEntry()">
            <i class="fas fa-dog fa-3x"></i>
            <h1>Fetch</h1>
            <p>Order Delivery (Guest)</p>
        </div>
        <!-- Driver: Login Required -->
        <div class="gateway-split gateway-driver" onclick="app.navTo('auth')">
            <i class="fas fa-truck-pickup fa-3x"></i>
            <h1>Driver Login</h1>
            <p>Log in to access your routes.</p>
        </div>
    </div>

    <!-- 2. AUTHENTICATION (Drivers Only) -->
    <div id="view-auth" class="view">
        <h2 style="margin-top:40px;">Driver Access</h2>
        <p>Sign in to your account.</p>
        
        <div class="card">
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            
            <button class="btn btn-blue" onclick="app.login()">Sign In / Sign Up</button>
            <button class="btn btn-outline" onclick="app.navTo('gateway')">Back</button>
        </div>
    </div>

    <!-- 3. CUSTOMER DASHBOARD (Guest Mode) -->
    <div id="view-customer" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Order Delivery</h2>
            <div class="badge badge-success">Guest</div>
        </div>

        <!-- Address Selection -->
        <div class="card">
            <div id="map-container"></div>
            <p style="font-size:12px; color:var(--primary); text-align:center;">
                <i class="fas fa-map-pin"></i> Drag pin to your exact driveway
            </p>
            <input type="text" placeholder="Start typing store name (e.g. Walmart)...">
        </div>

        <!-- Contact Info (Required for Guests) -->
        <div class="card">
            <h3>Contact Info</h3>
            <input type="text" placeholder="Your Name">
            <input type="tel" placeholder="Mobile Number (for updates)">
        </div>

        <!-- Delivery Type Selection -->
        <div class="card">
            <h3>Delivery Speed</h3>
            <label style="display:flex; align-items:center; margin-bottom:15px;" onclick="app.updateTotal()">
                <input type="radio" name="speed" value="standard" checked style="width:20px; margin-right:10px;">
                <div>
                    <strong>Standard</strong><br>
                    <small>Waitlist ‚Ä¢ Flat Fee</small>
                </div>
                <div style="margin-left:auto;">$15.00</div>
            </label>

            <label style="display:flex; align-items:center;" onclick="app.updateTotal()">
                <input type="radio" name="speed" value="rush" style="width:20px; margin-right:10px;">
                <div>
                    <strong>‚ö° Rush (Line Jumper)</strong><br>
                    <small>Delivered Today ‚Ä¢ Bribe Driver</small>
                </div>
            </label>
            
            <div id="rush-bid-container" style="display:none; margin-top:10px; padding:10px; background:var(--light); border-radius:8px;">
                <label style="font-size:12px;">Your Bribe Offer:</label>
                <input type="number" id="rush-amount" value="25.00" onchange="app.updateTotal()">
            </div>
        </div>

        <!-- Add-ons -->
        <div class="card">
            <label style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center;">
                    <input type="checkbox" id="white-glove" style="width:20px; margin-right:10px;" onchange="app.updateTotal()">
                    <div>
                        <strong>üß§ White Glove Service</strong><br>
                        <small>Verify items at store</small>
                    </div>
                </div>
                <div>+$1.99</div>
            </label>
        </div>

        <!-- Invoice -->
        <div class="card">
            <div class="invoice-row"><span>Driver Pay</span><span>$15.00</span></div>
            <div class="invoice-row fee"><span>Platform Fee</span><span>$5.00</span></div>
            <div class="invoice-row" id="rush-row" style="display:none; color:var(--primary);"><span>‚ö° Rush Bribe</span><span id="rush-display">$0.00</span></div>
            <div class="invoice-row" id="glove-row" style="display:none;"><span>White Glove</span><span>$1.99</span></div>
            <div class="invoice-row total"><span>Total</span><span id="grand-total">$20.00</span></div>
            
            <button class="btn" onclick="alert('Proceeding to Stripe Payment...')">Pay & Book</button>
        </div>
    </div>

    <!-- 4. DRIVER DASHBOARD -->
    <div id="view-driver" class="view">
        <!-- If Pending, show Application Status -->
        <div id="driver-pending-msg" class="card" style="display:none; background:#fff3cd; border:1px solid #ffeeba;">
            <h3>‚ö†Ô∏è Access Restricted</h3>
            <p>Your application is pending approval from Dispatch. Check back later.</p>
        </div>

        <!-- If Active, show Controls -->
        <div id="driver-active-controls">
            <div class="card" style="background:var(--secondary); color:white;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2 style="color:white; margin:0;">Dashboard</h2>
                        <small>Status: Online</small>
                    </div>
                    <i class="fas fa-satellite-dish fa-2x"></i>
                </div>
            </div>

            <!-- Magnet Mode -->
            <div class="card">
                <h3>üß≤ Magnet Mode</h3>
                <p>Highlight orders within 3 miles of my route.</p>
                <button class="btn btn-outline">Configure Radius</button>
            </div>

            <!-- Active Order List -->
            <h3>Available Orders</h3>
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <strong>Walmart -> Miller Farm</strong>
                    <span class="badge badge-success">Rush</span>
                </div>
                <p>5 items ‚Ä¢ 8.2 miles</p>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <strong>Payout: $42.00</strong>
                    <button class="btn btn-blue" style="width:auto; padding:8px 15px; margin:0;">Details</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. PROFILE (Where Drivers Apply) -->
    <div id="view-profile" class="view">
        <h2>My Account</h2>
        <div class="card">
            <p><strong>Email:</strong> <span id="profile-email">driver@example.com</span></p>
            <p><strong>Status:</strong> <span id="profile-status" class="badge badge-pending">General User</span></p>
        </div>

        <!-- Application Form (Hidden if already driver) -->
        <div id="driver-application-form" class="card" style="display:none;">
            <h3>üöõ Apply to Drive</h3>
            <p>Fill out this form to join the Fetch fleet.</p>
            <input type="text" id="app-name" placeholder="Full Legal Name">
            <input type="text" id="app-vehicle" placeholder="Vehicle Make/Model">
            <input type="text" id="app-license" placeholder="Driver's License #">
            <input type="text" id="app-insurance" placeholder="Insurance Policy #">
            <button class="btn btn-blue" onclick="app.submitApplication()">Submit Application</button>
        </div>

        <button class="btn btn-outline" onclick="app.logout()">Log Out</button>
    </div>

    <!-- ================= NAV BAR ================= -->
    <div class="bottom-nav" id="main-nav">
        <!-- Customer Nav -->
        <div class="nav-item active" id="nav-home" onclick="app.navTo('customer')">
            <i class="fas fa-home nav-icon"></i> Home
        </div>
        <div class="nav-item" onclick="app.navTo('gateway')">
            <i class="fas fa-sign-out-alt nav-icon"></i> Exit
        </div>
    </div>

    <div class="bottom-nav" id="driver-nav">
        <!-- Driver Nav -->
        <div class="nav-item" onclick="app.navTo('driver')">
            <i class="fas fa-road nav-icon"></i> Routes
        </div>
        <div class="nav-item" onclick="app.navTo('profile')">
            <i class="fas fa-user nav-icon"></i> Profile
        </div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        // MOCK DATABASE STATE
        let currentUser = {
            email: "",
            role: "user", // 'user', 'pending', 'driver'
            isLoggedIn: false
        };

        const app = {
            map: null,

            // Navigation
            navTo: (viewId) => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-gateway').style.display = 'none';
                document.getElementById('main-nav').style.display = 'none';
                document.getElementById('driver-nav').style.display = 'none';
                
                if(viewId === 'gateway') {
                    document.getElementById('view-gateway').style.display = 'block';
                } else {
                    document.getElementById('view-' + viewId).classList.add('active');
                    
                    // Show correct Nav Bar
                    if(currentUser.isLoggedIn && (viewId === 'driver' || viewId === 'profile')) {
                        document.getElementById('driver-nav').style.display = 'flex';
                        app.updateProfileView();
                    } else if (viewId === 'customer') {
                        document.getElementById('main-nav').style.display = 'flex';
                    }
                }
            },

            // Guest Entry
            guestEntry: () => {
                currentUser.role = 'guest';
                currentUser.isLoggedIn = false;
                app.navTo('customer');
                app.initMap();
            },

            // Driver Login
            login: () => {
                const email = document.getElementById('email').value;
                if(email) {
                    // Simulate Login
                    currentUser.email = email;
                    currentUser.isLoggedIn = true;
                    // Default role is 'user' until they apply
                    currentUser.role = "user"; 
                    app.navTo('driver');
                }
            },

            logout: () => {
                currentUser.isLoggedIn = false;
                app.navTo('gateway');
            },

            // Application Logic
            updateProfileView: () => {
                document.getElementById('profile-email').innerText = currentUser.email;
                
                const statusSpan = document.getElementById('profile-status');
                const form = document.getElementById('driver-application-form');

                if(currentUser.role === 'user') {
                    statusSpan.innerText = "Not Applied";
                    statusSpan.className = "badge";
                    form.style.display = 'block'; // Show Form
                } else if (currentUser.role === 'pending') {
                    statusSpan.innerText = "Pending Approval";
                    statusSpan.className = "badge badge-pending";
                    form.style.display = 'none';
                } else if (currentUser.role === 'driver') {
                    statusSpan.innerText = "Active Driver";
                    statusSpan.className = "badge badge-success";
                    form.style.display = 'none';
                }
            },

            submitApplication: () => {
                const name = document.getElementById('app-name').value;
                if(name) {
                    alert("Application Submitted! Status: Pending Approval.");
                    currentUser.role = 'pending';
                    app.updateProfileView();
                    app.navTo('driver'); // Go back to dashboard to see pending message
                } else {
                    alert("Please fill out all fields.");
                }
            },

            // Map Logic
            initMap: () => {
                if(app.map) return;
                setTimeout(() => {
                    app.map = L.map('map-container').setView([35.0, -97.0], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(app.map);
                    L.marker([35.0, -97.0], {draggable: true}).addTo(app.map)
                        .bindPopup("Drag to your driveway").openPopup();
                }, 500);
            },

            // Calculator
            updateTotal: () => {
                const speed = document.querySelector('input[name="speed"]:checked').value;
                const whiteGlove = document.getElementById('white-glove').checked;
                let rush = (speed === 'rush') ? (parseFloat(document.getElementById('rush-amount').value) || 0) : 0;
                let glove = whiteGlove ? 1.99 : 0;
                
                document.getElementById('rush-bid-container').style.display = (speed === 'rush') ? 'block' : 'none';
                document.getElementById('rush-row').style.display = (speed === 'rush') ? 'flex' : 'none';
                document.getElementById('glove-row').style.display = whiteGlove ? 'flex' : 'none';
                
                document.getElementById('rush-display').innerText = '$' + rush.toFixed(2);
                document.getElementById('grand-total').innerText = '$' + (15 + 5 + rush + glove).toFixed(2);
            }
        };
        
        // Initial Calculation
        app.updateTotal();

        // Driver Dashboard Logic Check
        // If driver goes to dashboard but is pending/user, hide controls
        const originalNavTo = app.navTo;
        app.navTo = (viewId) => {
            originalNavTo(viewId);
            if(viewId === 'driver') {
                if(currentUser.role === 'driver') {
                    document.getElementById('driver-pending-msg').style.display = 'none';
                    document.getElementById('driver-active-controls').style.display = 'block';
                } else {
                    document.getElementById('driver-pending-msg').style.display = 'block';
                    document.getElementById('driver-active-controls').style.display = 'none';
                    
                    if(currentUser.role === 'user') {
                         document.getElementById('driver-pending-msg').innerHTML = 
                         `<h3>üëã Welcome</h3><p>You are logged in. Go to <a href="#" onclick="app.navTo('profile')">Profile</a> to apply to drive.</p>`;
                    }
                }
            }
        };

    </script>
</body>
</html>
